<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¤‡åˆ©èˆ‡æé ˜ç­–ç•¥è¨ˆç®—æ©Ÿ (ç‰ˆé¢å„ªåŒ–ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS Reset & è®Šæ•¸è¨­å®š */
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
        }

        h1 {
            text-align: center;
            color: var(--primary);
            font-size: 1.5rem;
            margin-bottom: 25px;
        }

        /* --- éŸ¿æ‡‰å¼ä½ˆå±€æ ¸å¿ƒ (ä¿®æ­£é‡é») --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            /* â˜…â˜…â˜… ä¿®æ­£1ï¼šåŠ å¤§é–“è·ï¼Œå¾ 20px æ”¹ç‚º 40pxï¼Œè®“ä¸­é–“ç•™ç™½æ›´å¤š â˜…â˜…â˜… */
            gap: 40px; 
            grid-template-columns: 1fr; /* æ‰‹æ©Ÿç‰ˆé è¨­å–®æ¬„ */
        }

        /* é›»è…¦ç‰ˆ (å¯¬åº¦å¤§æ–¼ 768px) */
        @media (min-width: 768px) {
            .container {
                /* è¨­å®šæ¯”ä¾‹ï¼šå·¦é‚Šåƒæ•¸å€ (1ç­‰ä»½) å³é‚Šåœ–è¡¨å€ (1.8ç­‰ä»½) */
                grid-template-columns: 1fr 1.8fr; 
                align-items: start;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            
            /* â˜…â˜…â˜… ä¿®æ­£2ï¼šå¼·åˆ¶å…§å®¹ä¸æº¢å‡ºï¼Œè§£æ±ºé‡ç–Šå•é¡Œ â˜…â˜…â˜… */
            min-width: 0; 
            width: 100%;
            overflow: hidden; 
        }

        h2 {
            font-size: 1.2rem;
            margin-top: 0;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            color: var(--primary);
        }

        /* è¼¸å…¥ä»‹é¢å„ªåŒ– */
        .input-group { margin-bottom: 20px; } /* å¢åŠ å‚ç›´é–“è· */
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95rem;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; 
            box-sizing: border-box;
            background: #fafafa;
        }
        
        input[type="number"]:focus {
            border-color: var(--accent);
            outline: none;
            background: #fff;
        }

        input[type="range"] {
            width: 100%;
            height: 30px; 
            cursor: pointer;
            margin: 5px 0;
        }

        .val-display { float: right; color: var(--accent); font-weight: bold; }

        /* çµæœæ‘˜è¦å€å¡Š */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 15px;
            margin-bottom: 20px;
        }

        .result-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #eee;
        }

        .result-box .label { font-size: 0.85rem; color: #777; margin-bottom: 5px; }
        .result-box .value { font-size: 1.25rem; font-weight: bold; color: var(--primary); }

        /* ç‹€æ…‹è¨Šæ¯ */
        .status-box {
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: white;
            margin-bottom: 20px;
        }
        .status-success { background-color: var(--success); }
        .status-danger { background-color: var(--danger); }

        /* åœ–è¡¨å®¹å™¨ */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px; /* æ‰‹æ©Ÿé«˜åº¦ */
        }
        @media (min-width: 768px) {
            .chart-container { height: 450px; } /* é›»è…¦é«˜åº¦ */
        }
        
        #errorMsg { color: red; display: none; text-align: center; padding: 20px; }

    </style>
</head>
<body>

    <h1>ğŸ’° è¤‡åˆ©èˆ‡æé ˜ç­–ç•¥è¨ˆç®—æ©Ÿ</h1>
    <div id="errorMsg">âš ï¸ è«‹é€£æ¥ç¶²è·¯ä»¥è¼‰å…¥åœ–è¡¨å…ƒä»¶</div>

    <div class="container">
        <!-- å·¦å´ï¼šåƒæ•¸è¨­å®š -->
        <div class="card">
            <h2>âš™ï¸ åƒæ•¸è¨­å®š</h2>
            
            <div class="input-group">
                <label>åˆå§‹æœ¬é‡‘ (å…ƒ)</label>
                <input type="number" id="initialPrincipal" value="1000000" inputmode="numeric">
            </div>

            <div class="input-group">
                <label>æ¯æœˆå®šæœŸå®šé¡ (å…ƒ)</label>
                <input type="number" id="monthlyContribute" value="20000" inputmode="numeric">
            </div>

            <div class="input-group">
                <label>é æœŸå¹´åŒ–å ±é…¬ç‡ <span id="rateVal" class="val-display">6%</span></label>
                <input type="range" id="interestRate" min="1" max="15" step="0.1" value="6">
            </div>

            <div class="input-group">
                <label>è·é›¢é€€ä¼‘é‚„æœ‰å¹¾å¹´ (ç´¯ç©æœŸ) <span id="yearsVal" class="val-display">20å¹´</span></label>
                <input type="range" id="investYears" min="1" max="50" step="1" value="20">
            </div>

            <div class="input-group">
                <label>é€€ä¼‘å¾Œå¹´æé ˜ç‡ <span id="withdrawRateVal" class="val-display">4%</span></label>
                <input type="range" id="withdrawalRate" min="1" max="10" step="0.1" value="4">
            </div>

            <div class="input-group">
                <label>é€€ä¼‘å¾Œç”Ÿæ´»å¹´æ•¸ <span id="lifeVal" class="val-display">30å¹´</span></label>
                <input type="range" id="retirementYears" min="10" max="60" step="1" value="30">
            </div>
        </div>

        <!-- å³å´ï¼šåœ–è¡¨èˆ‡çµæœ -->
        <div class="card">
            <h2>ğŸ“Š åˆ†æçµæœ</h2>
            
            <div class="results-grid">
                <div class="result-box">
                    <div class="label">é€€ä¼‘æ™‚ç´¯ç©è³‡ç”¢</div>
                    <div class="value" id="finalAccumulation">$0</div>
                </div>
                <div class="result-box">
                    <div class="label">é€€ä¼‘é¦–å¹´æ¯æœˆå¯ç”¨</div>
                    <div class="value" id="monthlyIncome">$0</div>
                </div>
            </div>

            <div id="statusMessage" class="status-box">è¨ˆç®—ä¸­...</div>

            <div class="chart-container">
                <canvas id="wealthChart"></canvas>
            </div>
            
            <div style="font-size: 0.8rem; color: #888; margin-top: 15px; text-align: center;">
                * è—è‰²ç‚ºè³‡ç”¢ç´¯ç©æœŸï¼Œæ©˜è‰²ç‚ºé€€ä¼‘æé ˜æœŸ
            </div>
        </div>
    </div>

    <script>
        // æª¢æŸ¥ Chart.js
        window.onload = function() {
            if (typeof Chart === 'undefined') {
                document.getElementById('errorMsg').style.display = 'block';
            } else {
                init();
            }
        };

        const inputs = {
            principal: document.getElementById('initialPrincipal'),
            monthly: document.getElementById('monthlyContribute'),
            rate: document.getElementById('interestRate'),
            years: document.getElementById('investYears'),
            wRate: document.getElementById('withdrawalRate'),
            rYears: document.getElementById('retirementYears')
        };

        const displays = {
            rate: document.getElementById('rateVal'),
            years: document.getElementById('yearsVal'),
            wRate: document.getElementById('withdrawRateVal'),
            rYears: document.getElementById('lifeVal'),
            final: document.getElementById('finalAccumulation'),
            income: document.getElementById('monthlyIncome'),
            status: document.getElementById('statusMessage')
        };

        let chartInstance = null;

        function init() {
            Object.values(inputs).forEach(input => {
                input.addEventListener('input', updateSimulation);
            });
            updateSimulation();
        }

        function formatMoney(num) {
            return parseInt(num).toLocaleString('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 });
        }

        function updateSimulation() {
            // æ›´æ–°æ•¸å€¼é¡¯ç¤º
            displays.rate.textContent = inputs.rate.value + '%';
            displays.years.textContent = inputs.years.value + 'å¹´';
            displays.wRate.textContent = inputs.wRate.value + '%';
            displays.rYears.textContent = inputs.rYears.value + 'å¹´';

            const P = parseFloat(inputs.principal.value) || 0;
            const PMT = parseFloat(inputs.monthly.value) || 0;
            const r = parseFloat(inputs.rate.value) / 100;
            const t1 = parseInt(inputs.years.value); // ç´¯ç©å¹´æ•¸
            const wRate = parseFloat(inputs.wRate.value) / 100;
            const t2 = parseInt(inputs.rYears.value); // é€€ä¼‘å¹´æ•¸

            let labels = [];
            let dataPoints = [];
            let currentWealth = P;
            let brokeYear = null;

            // --- ç´¯ç©æœŸ ---
            for (let i = 0; i <= t1; i++) {
                labels.push(i + "å¹´(ç´¯ç©)");
                
                if (i === 0) {
                    dataPoints.push(currentWealth);
                } else {
                    // æ¯å¹´è¤‡åˆ© (æ¨¡æ“¬æ¯æœˆæŠ•å…¥)
                    for(let m=0; m<12; m++) {
                        currentWealth = currentWealth * (1 + r/12) + PMT;
                    }
                    dataPoints.push(currentWealth);
                }
            }

            const retirementWealth = currentWealth;
            const annualWithdrawal = retirementWealth * wRate;
            
            // --- æé ˜æœŸ ---
            for (let i = 1; i <= t2; i++) {
                let labelText = (t1 + i) + "å¹´(é€€ä¼‘)";
                labels.push(labelText);

                currentWealth = currentWealth - annualWithdrawal; // å¹´åˆæé ˜
                
                // å‰©é¤˜è³‡é‡‘ç¹¼çºŒæ»¾å­˜
                for(let m=0; m<12; m++) {
                    currentWealth = currentWealth * (1 + r/12);
                }

                if (currentWealth < 0) {
                    currentWealth = 0;
                    if (brokeYear === null) brokeYear = i;
                }

                dataPoints.push(currentWealth);
            }

            // --- UI æ›´æ–° ---
            displays.final.textContent = formatMoney(retirementWealth);
            displays.income.textContent = formatMoney(annualWithdrawal / 12);

            if (currentWealth > 0) {
                displays.status.className = "status-box status-success";
                displays.status.textContent = `æ­å–œï¼è³‡ç”¢è¶³ä»¥æ”¯æ’è‡³çµ‚è€ï¼Œå‰©é¤˜ ${formatMoney(currentWealth)}`;
            } else {
                displays.status.className = "status-box status-danger";
                displays.status.textContent = `è­¦å‘Šï¼šè³‡ç”¢å°‡åœ¨é€€ä¼‘ç¬¬ ${brokeYear} å¹´è€—ç›¡`;
            }

            drawChart(labels, dataPoints, t1);
        }

        function drawChart(labels, data, retirementIndex) {
            const ctx = document.getElementById('wealthChart').getContext('2d');
            
            if (chartInstance) {
                chartInstance.destroy();
            }

            // è¨­å®šé•·æ¢åœ–é¡è‰²
            const backgroundColors = data.map((val, index) => {
                if (val <= 0) return '#e74c3c'; // ç´…è‰²
                if (index <= retirementIndex) return '#3498db'; // è—è‰²
                return '#e67e22'; // æ©˜è‰²
            });

            // æ‰‹æ©Ÿç‰ˆå­—é«”èª¿æ•´
            const isMobile = window.innerWidth < 600;
            const fontSize = isMobile ? 10 : 12;

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ç¸½è³‡ç”¢é‡‘é¡',
                        data: data,
                        backgroundColor: backgroundColors,
                        borderRadius: 2,
                        barPercentage: 0.8,
                        categoryPercentage: 0.9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                generateLabels: function(chart) {
                                    return [
                                        { text: 'è³‡ç”¢ç´¯ç©æœŸ', fillStyle: '#3498db' },
                                        { text: 'é€€ä¼‘æé ˜æœŸ', fillStyle: '#e67e22' }
                                    ];
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return formatMoney(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 10000).toFixed(0) + 'è¬';
                                },
                                font: { size: fontSize }
                            },
                            grid: { color: '#f0f0f0' }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: isMobile ? 8 : 15,
                                font: { size: fontSize }
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        window.addEventListener('resize', () => {
             updateSimulation();
        });

    </script>
</body>
</html>