<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¤‡åˆ©èˆ‡æé ˜ç­–ç•¥è¨ˆç®—æ©Ÿ</title>
    <!-- è¼‰å…¥åœ–è¡¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background: #f4f4f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; }
        .control-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 20px; background: #ecf0f1; border-radius: 8px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="range"] { width: 100%; cursor: pointer; }
        input[type="number"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .val-display { float: right; color: #2980b9; font-weight: bold; }
        
        .summary { display: flex; justify-content: space-around; text-align: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .box { background: #34495e; color: white; padding: 15px; border-radius: 8px; min-width: 200px; flex: 1; }
        .box .num { font-size: 1.5em; font-weight: bold; margin-top: 5px; }
        .box.success { background: #27ae60; }
        .box.fail { background: #c0392b; }

        .chart-container { position: relative; height: 400px; width: 100%; }
        #errorMsg { color: red; text-align: center; display: none; padding: 20px; border: 1px solid red; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ’° è¤‡åˆ©æŠ•è³‡èˆ‡æé ˜æ¨¡æ“¬å™¨</h1>
    
    <!-- éŒ¯èª¤è¨Šæ¯å€ -->
    <div id="errorMsg"></div>

    <div class="control-panel">
        <div>
            <div class="input-group">
                <label>åˆå§‹æœ¬é‡‘: <input type="number" id="p_init" value="1000000"></label>
            </div>
            <div class="input-group">
                <label>æ¯æœˆå­˜å…¥: <input type="number" id="p_monthly" value="20000"></label>
            </div>
            <div class="input-group">
                <label>å¹´åŒ–å ±é…¬ç‡: <span class="val-display" id="d_rate">6%</span></label>
                <input type="range" id="r_rate" min="1" max="15" step="0.1" value="6">
            </div>
        </div>
        <div>
            <div class="input-group">
                <label>ç´¯ç©å¹´æ•¸ (é€€ä¼‘å‰): <span class="val-display" id="d_years">20å¹´</span></label>
                <input type="range" id="t_years" min="1" max="50" value="20">
            </div>
            <div class="input-group">
                <label>é€€ä¼‘å¾Œå¹´æé ˜ç‡: <span class="val-display" id="d_withdraw">4%</span></label>
                <input type="range" id="w_rate" min="1" max="10" step="0.1" value="4">
            </div>
            <div class="input-group">
                <label>é è¨ˆé€€ä¼‘ç”Ÿæ´»å¹´æ•¸: <span class="val-display" id="d_life">30å¹´</span></label>
                <input type="range" id="l_years" min="10" max="60" value="30">
            </div>
        </div>
    </div>

    <div class="summary">
        <div class="box">
            <div>é€€ä¼‘æº–å‚™é‡‘ç¸½é¡</div>
            <div class="num" id="res_total">$0</div>
        </div>
        <div class="box">
            <div>é€€ä¼‘å¾Œæ¯æœˆç”Ÿæ´»è²»</div>
            <div class="num" id="res_monthly">$0</div>
        </div>
        <div class="box" id="status_box">
            <div id="res_status_title">ç‹€æ…‹</div>
            <div class="num" id="res_status_text">è¨ˆç®—ä¸­</div>
        </div>
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>
</div>

<script>
    // æª¢æŸ¥ Chart.js æ˜¯å¦æˆåŠŸè¼‰å…¥
    window.onload = function() {
        if (typeof Chart === 'undefined') {
            const errDiv = document.getElementById('errorMsg');
            errDiv.style.display = 'block';
            errDiv.innerHTML = 'âš ï¸ <b>éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥åœ–è¡¨å…ƒä»¶ï¼</b><br>è«‹ç¢ºèªæ‚¨çš„é›»è…¦å·²é€£ä¸Šç¶²éš›ç¶²è·¯ï¼Œæ­¤ç¶²é éœ€è¦ç¶²è·¯è¼‰å…¥ Chart.js æ‰èƒ½ç¹ªåœ–ã€‚';
        } else {
            init();
        }
    };

    let myChart = null;

    function init() {
        // ç¶å®šæ‰€æœ‰è¼¸å…¥æ¡†äº‹ä»¶
        const inputs = document.querySelectorAll('input');
        inputs.forEach(el => {
            el.addEventListener('input', calculate);
        });
        calculate();
    }

    function formatMoney(n) {
        return parseInt(n).toLocaleString('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 });
    }

    function calculate() {
        // å–å¾—æ•¸å€¼
        const P = Number(document.getElementById('p_init').value);
        const PMT = Number(document.getElementById('p_monthly').value);
        const rate = Number(document.getElementById('r_rate').value) / 100;
        const years = Number(document.getElementById('t_years').value);
        const wRate = Number(document.getElementById('w_rate').value) / 100;
        const life = Number(document.getElementById('l_years').value);

        // æ›´æ–°é¡¯ç¤ºæ–‡å­—
        document.getElementById('d_rate').innerText = (rate*100).toFixed(1) + '%';
        document.getElementById('d_years').innerText = years + 'å¹´';
        document.getElementById('d_withdraw').innerText = (wRate*100).toFixed(1) + '%';
        document.getElementById('d_life').innerText = life + 'å¹´';

        // è¨ˆç®—é‚è¼¯
        let labels = [];
        let data = [];
        let currentMoney = P;
        let monthlyRate = rate / 12;
        let brokenYear = -1;

        // éšæ®µä¸€ï¼šç´¯ç©
        for(let y=0; y<=years; y++) {
            labels.push(y + 'å¹´(ç´¯ç©)');
            if(y > 0) {
                // ç°¡å–®è¤‡åˆ©ï¼šæ¯å¹´æŠ•å…¥ = æœˆæŠ•*12ï¼Œä½†åœ¨é€™è£¡ç”¨å¹´åŒ–è¨ˆç®—è¼ƒå¹³æ»‘ï¼Œæˆ–æ˜¯æ¨¡æ“¬æ¯æœˆ
                // é€™è£¡ç°¡åŒ–ï¼šå¹´åˆè³‡ç”¢ * (1+r) + å¹´æŠ•å…¥
                // ç‚ºäº†ç²¾ç¢ºä¸€é»ï¼Œæ¨¡æ“¬12å€‹æœˆ
                for(let m=0; m<12; m++) {
                    currentMoney = currentMoney * (1 + monthlyRate) + PMT;
                }
            }
            data.push(currentMoney);
        }

        const retireMoney = currentMoney;
        const yearWithdraw = retireMoney * wRate; 
        
        // éšæ®µäºŒï¼šæé ˜
        for(let y=1; y<=life; y++) {
            labels.push((years+y) + 'å¹´(é€€ä¼‘)');
            
            // æ¯å¹´åˆæé ˜
            currentMoney -= yearWithdraw;
            
            // å‰©é¤˜è³‡é‡‘ç¹¼çºŒæ»¾åˆ©æ¯
            // é€™è£¡å‡è¨­é€€ä¼‘å¾Œçš„éŒ¢æ”¾åœ¨åŒæ¨£æŠ•å ±ç‡çš„åœ°æ–¹ï¼Œæˆ–è€…ä½ å¯ä»¥è¨­å®šè¼ƒä¿å®ˆçš„åˆ©ç‡
            // ç‚ºäº†ç°¡åŒ–æ¨¡å‹ï¼Œæ²¿ç”¨åŒæ¨£åˆ©ç‡
            for(let m=0; m<12; m++) {
                currentMoney = currentMoney * (1 + monthlyRate);
            }

            if(currentMoney < 0) {
                currentMoney = 0;
                if(brokenYear === -1) brokenYear = y;
            }
            data.push(currentMoney);
        }

        // æ›´æ–°çµæœä»‹é¢
        document.getElementById('res_total').innerText = formatMoney(retireMoney);
        document.getElementById('res_monthly').innerText = formatMoney(yearWithdraw / 12);
        
        const statusBox = document.getElementById('status_box');
        const statusText = document.getElementById('res_status_text');

        if(brokenYear !== -1) {
            statusBox.className = "box fail";
            statusBox.querySelector('div').innerText = "è³‡é‡‘è€—ç›¡";
            statusText.innerText = `é€€ä¼‘ç¬¬ ${brokenYear} å¹´ç ´ç”¢`;
        } else {
            statusBox.className = "box success";
            statusBox.querySelector('div').innerText = "å®‰äº«æ™šå¹´";
            statusText.innerText = `é¤˜é¡: ${formatMoney(currentMoney)}`;
        }

        drawChart(labels, data, years);
    }

    function drawChart(labels, data, splitIndex) {
        const ctx = document.getElementById('myChart').getContext('2d');
        
        // è¨­å®šé¡è‰²ï¼šç´¯ç©æœŸè—è‰²ï¼Œé€€ä¼‘æœŸæ©˜è‰²ï¼Œæ²’éŒ¢äº†ç´…è‰²
        const colors = data.map((v, i) => {
            if(v <= 0) return 'red';
            return i <= splitIndex ? '#3498db' : '#e67e22';
        });

        if(myChart) myChart.destroy();

        myChart = new Chart(ctx, {
            type: 'bar', // ç”¨é•·æ¢åœ–å¯èƒ½æ¯”è¼ƒç›´è§€ï¼Œæˆ–è€… line
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç¸½è³‡ç”¢é‡‘é¡',
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatMoney(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        ticks: { maxTicksLimit: 20 } // é¿å…Xè»¸å¤ªæ“ 
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
</script>

</body>
</html>