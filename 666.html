<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬ (æ–°å¢å°ç©é›»)(</title>
    
    <!-- å¼•å…¥ Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Roboto', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f3f4f6; color: #374151; }
        .font-mono-num { font-family: 'Roboto Mono', monospace; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 24px; border: 1px solid #e5e7eb; }
        
        /* è¼¸å…¥æ¡†é è¨­é å³ï¼Œä½†æœƒè¢« inline style è¦†è“‹ */
        .input-val { 
            width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; 
            text-align: right; font-weight: 700; font-family: 'Roboto Mono', monospace; 
            transition: all 0.2s; color: #1f2937; 
        }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        
        /* ä¿®æ”¹è™•ï¼šfont-size æ”¹ç‚º inheritï¼Œè®“å®ƒè·Ÿéš¨è¡¨æ ¼è¨­å®š (text-sm) */
        .calc-val { border: none; background: transparent; text-align: right; font-family: 'Roboto Mono', monospace; color: #374151; width: 100%; font-size: inherit; }
        
        .trend-up { color: #dc2626; font-weight: 700; }
        .trend-down { color: #16a34a; font-weight: 700; }
        .privacy-blur { color: transparent !important; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; }
        .strategy-card { border-left: 4px solid #3b82f6; background: #f8fafc; padding: 16px; margin-bottom: 12px; border-radius: 8px; font-size: 0.95rem; line-height: 1.5; }
        .strategy-title { font-weight: 700; color: #1e40af; display: block; margin-bottom: 6px; font-size: 1.05rem; }
        th { font-weight: 700; letter-spacing: 0.02em; }
        td { font-variant-numeric: tabular-nums; }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 99; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="pb-20">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-white/90">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight"><i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬</h1>
                <div class="flex items-center gap-2 mt-2">
                    <button onclick="saveData()" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full transition font-medium border border-green-200">
                        <i class="fa-solid fa-floppy-disk mr-1"></i>å„²å­˜è¨­å®š
                    </button>
                    <button onclick="togglePrivacy()" id="btn-privacy" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition font-medium border border-gray-300">
                        <i class="fa-solid fa-eye-slash mr-1"></i>éš±è—è³‡ç”¢
                    </button>
                    <button onclick="fetchAllData()" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full transition font-medium border border-blue-200">
                        <i class="fa-solid fa-sync-alt mr-1"></i>åˆ·æ–°å ±åƒ¹
                    </button>
                    <span id="status-msg" class="text-xs text-gray-500 font-medium font-mono-num ml-2"></span>
                </div>
            </div>
            <div class="flex items-center gap-8">
                <!-- åŒ¯ç‡å€å¡Š -->
                <div class="border-r pr-8 border-gray-200 flex flex-col items-start">
                    <div class="text-xs text-gray-500 font-medium mb-1">USD/TWD åŒ¯ç‡</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-2xl font-bold text-blue-600 w-24 text-left bg-transparent border-none focus:ring-0 p-0 m-0 font-mono-num" onchange="calculateAll()">
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 font-medium mb-1">ç›®å‰å¸³é¢ç¸½è³‡ç”¢ (TWD)</div>
                    <div class="text-4xl font-bold text-gray-800 tracking-tight font-mono-num privacy-target" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

        <!-- 1. å°ç£çµ±è¨ˆæ•¸æ“š -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card border-l-4 border-purple-500 flex justify-between items-center">
                <div>
                    <div class="text-sm text-gray-500 font-medium">ğŸ‡¹ğŸ‡¼ å®¶åº­å¯æ”¯é…æ‰€å¾— (ä¸­ä½æ•¸)</div>
                    <div class="text-xs text-gray-400 mt-1">ä¸»è¨ˆç¸½è™• 112å¹´</div>
                </div>
                <div class="text-2xl font-bold text-purple-700 font-mono-num">113.7 è¬</div>
            </div>
            <div class="card border-l-4 border-indigo-500 flex justify-between items-center">
                <div>
                    <div class="text-sm text-gray-500 font-medium">ğŸ‡¹ğŸ‡¼ ç”·æ€§å¹³å‡é¤˜å‘½ (1987å¹´ç”Ÿä¼°ç®—)</div>
                    <div class="text-xs text-gray-400 mt-1">å…§æ”¿éƒ¨æ•¸æ“š + å¥åº·èª¿æ•´</div>
                </div>
                <div class="text-2xl font-bold text-indigo-700 font-mono-num">ç´„ 83 æ­²</div>
            </div>
        </section>

        <!-- 2. è³‡ç”¢é…ç½®èˆ‡å€åŸŸæ›éšª -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-2 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <table class="w-full min-w-[700px] text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 border-b border-gray-200">
                            <th class="p-3 text-left rounded-tl-lg">æ¨™çš„</th>
                            <th class="p-3 text-center">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                            <th class="p-3 text-center w-32">å¸‚åƒ¹ (åŸå¹£)</th>
                            <th class="p-3 text-right">å¸‚å€¼ (TWD)</th>
                            <th class="p-3 text-center bg-blue-50/50 w-24">ç›®æ¨™ %</th>
                            <th class="p-3 text-center bg-blue-50/50 rounded-tr-lg">å»ºè­°æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr>
                            <td class="p-3 font-bold text-blue-700 text-base font-mono-num">
                                å°ç©é›» 2330 
                                <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">å°ç£åŠå°é«”</span>
                            </td>
                            <td class="p-3"><input type="text" id="qty-aoa" value="2180" class="input-val privacy-target" style="text-align: left;" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="number" id="price-aoa" value="1040" step="1" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="text" id="val-aoa" readonly class="calc-val font-bold privacy-target"></td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-aoa" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold bg-blue-50/30 font-mono-num whitespace-nowrap privacy-target" id="act-aoa">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-purple-700 text-base font-mono-num">IMID <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">è‹±è‚¡ (USDè¨ˆåƒ¹)</span></td>
                            <td class="p-3"><input type="text" id="qty-imid" value="344" class="input-val privacy-target" style="text-align: left;" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="number" id="price-imid" value="35.50" step="0.01" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <!-- ä¿®æ”¹è™•ï¼šç§»é™¤ text-base -->
                            <td class="p-3"><input type="text" id="val-imid" readonly class="calc-val font-bold privacy-target"></td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-imid" value="60" class="input-val text-center" oninput="calculateAll()"></td>
                            <!-- ä¿®æ”¹è™•ï¼šç§»é™¤ text-base -->
                            <td class="p-3 text-left font-bold bg-blue-50/30 font-mono-num whitespace-nowrap privacy-target" id="act-imid">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-green-700 text-base font-mono-num">00631L <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">å…ƒå¤§å°ç£50æ­£2</span></td>
                            <td class="p-3"><input type="text" id="qty-tw" value="15500" class="input-val privacy-target" style="text-align: left;" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="number" id="price-tw" value="161.03" step="0.01" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <!-- ä¿®æ”¹è™•ï¼šç§»é™¤ text-base -->
                            <td class="p-3"><input type="text" id="val-tw" readonly class="calc-val font-bold privacy-target"></td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw" value="40" class="input-val text-center" oninput="calculateAll()"></td>
                            <!-- ä¿®æ”¹è™•ï¼šç§»é™¤ text-base -->
                            <td class="p-3 text-left font-bold bg-blue-50/30 font-mono-num whitespace-nowrap privacy-target" id="act-tw">-</td>
                        </tr>
                        <tr class="bg-gray-50/50">
                            <td class="p-3 font-bold text-gray-600 text-base">ç¾é‡‘ <span class="text-xs font-normal text-gray-400 block mt-0.5">TWD</span></td>
                            <td class="p-3"><input type="text" id="val-cash" value="3,000,000" class="input-val font-bold text-gray-700 privacy-target" style="text-align: left;" oninput="formatCashInput(this); calculateAll()"></td>
                            <td class="p-3 text-center text-gray-300">-</td>
                            <td class="p-3 text-right text-gray-400">-</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-cash" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <!-- ä¿®æ”¹è™•ï¼šç§»é™¤ text-base -->
                            <td class="p-3 text-left font-bold bg-blue-50/30 text-gray-600 font-mono-num whitespace-nowrap privacy-target" id="act-cash">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card flex flex-col items-center">
                <h3 class="text-base font-bold text-gray-700 mb-4 w-full flex items-center justify-between">
                    <span><i class="fa-solid fa-earth-americas mr-2 text-blue-500"></i>å€åŸŸé¢¨éšªæ›éšªæ¨ä¼°</span>
                </h3>
                <div class="relative w-full flex-grow min-h-[300px]">
                    <canvas id="countryChart"></canvas>
                </div>
                <div class="text-[10px] text-gray-400 mt-3 text-center bg-gray-50 p-2 rounded w-full">
                    æ³¨æ„ï¼šå…¶ä¸­ <strong>00631L</strong> å·²æŒ‰ <strong>200%</strong> æ§“æ¡¿æ¬Šé‡è¨ˆç®—ã€‚
                </div>
            </div>
        </div>

        <!-- 3. å¸‚å ´è¡¨ç¾çœ‹æ¿ -->
        <div class="card overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å¸‚å ´è¡¨ç¾çœ‹æ¿ (æ­·å²æ•¸æ“š)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-center border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 border-b border-gray-200">
                            <th class="p-3 text-left rounded-tl-lg">æ¨™çš„</th>
                            <th class="p-3">æœ€æ–°åƒ¹</th>
                            <th class="p-3">ä»Šæ—¥æ¼²è·Œ</th>
                            <th class="p-3">è¿‘ 1 é€±</th>
                            <th class="p-3">è¿‘ 1 æœˆ</th>
                            <th class="p-3">YTD</th>
                            <th class="p-3 bg-orange-50/50">1 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50">3 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50">5 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50 rounded-tr-lg">10 å¹´ (å¹´åŒ–)</th>
                        </tr>
                    </thead>
                    <tbody id="perf-body" class="divide-y divide-gray-100 font-mono-num">
                        <tr id="row-AOA"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                        <tr id="row-IMID"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                        <tr id="row-TW"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr class="border-gray-200 my-8">

        <!-- 4. è’™åœ°å¡ç¾…æ¨¡æ“¬ -->
        <section class="space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-dice text-blue-600 mr-2"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬</h2>
                <div class="text-sm text-gray-500 font-medium bg-gray-100 px-3 py-1 rounded-full">
                    ä»¥ã€Œç›®æ¨™ %ã€é€²è¡Œæ¨¡æ“¬ | æ‰£é™¤æ¯å¹´æé ˜ | è€ƒæ…®è³‡ç”¢æ³¢å‹•
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">
                <div class="card border-l-4 border-indigo-500 p-5">
                    <label class="block text-sm font-bold text-gray-600 mb-2">é¸æ“‡æé ˜ç­–ç•¥</label>
                    <div class="flex items-center gap-2">
                        <select id="withdraw-strategy" class="flex-grow border-2 border-gray-200 rounded-lg p-2 text-gray-700 font-medium focus:border-indigo-500 focus:outline-none" onchange="updateStrategyDesc()">
                            <option value="fixed-pct">1. å›ºå®šç™¾åˆ†æ¯” (Fixed %)</option>
                            <option value="swr" selected>2. å›ºå®šé‡‘é¡ (SWR, Inflation Adjusted)</option>
                            <option value="vanguard">3. Vanguard å‹•æ…‹æ”¯å‡º (Floor/Ceiling)</option>
                            <option value="gk">4. Guyton-Klinger (å‹•æ…‹æ±ºç­–)</option>
                            <option value="one-n">5. 1/N æé ˜æ³• (RMD Style)</option>
                            <option value="cape">6. CAPE ä¼°å€¼èª¿æ•´ (Valuation Based)</option>
                            <option value="vpw">7. VPW è®Šå‹•ç™¾åˆ†æ¯” (Variable %)</option>
                        </select>
                        <button onclick="runMonteCarlo(true)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold transition shadow-sm whitespace-nowrap">
                            <i class="fa-solid fa-play mr-1"></i>é–‹å§‹æ¸¬è©¦
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2" id="strategy-desc">èªªæ˜ï¼šé¦–å¹´æé ˜å›ºå®š%ï¼Œå¾Œéš¨é€šè†¨èª¿æ•´ã€‚å„ªé»ï¼šè³¼è²·åŠ›ç©©å®šã€‚ç¼ºé»ï¼šå¯èƒ½ç ´ç”¢ã€‚</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="card border-t-4 border-blue-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é€€ä¼‘ç”Ÿæ´»å¹´æ•¸</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="sim-years" value="45" class="text-2xl font-bold text-gray-800 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-blue-500 transition-colors font-mono-num">
                        <span class="text-sm text-gray-600 font-medium">å¹´</span>
                    </div>
                </div>
                <div class="card border-t-4 border-orange-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é¦–å¹´æé ˜ç‡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="withdraw-rate" value="4.0" step="0.1" class="text-2xl font-bold text-orange-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-orange-500 transition-colors font-mono-num">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2 font-medium">é¦–å¹´ç´„ <span id="withdraw-amt" class="text-orange-600 font-mono-num privacy-target">0</span> è¬</div>
                </div>
                <div class="card border-t-4 border-red-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é ä¼°å¹´é€šè†¨ç‡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inflation-rate" value="3.0" step="0.1" class="text-2xl font-bold text-red-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-red-500 transition-colors font-mono-num">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                </div>
                <div class="card border-t-4 border-gray-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">éš±æ€§æˆæœ¬èˆ‡ç·©è¡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="cost-drag" value="1.5" step="0.1" class="text-2xl font-bold text-gray-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-gray-500 transition-colors font-mono-num">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2">å«å…§æ‰£è²»ã€ç¨…å‹™ã€åŒ¯ç‡æ³¢å‹•</div>
                </div>
                <div class="card border-t-4 border-green-500 bg-green-50 p-5">
                    <h3 class="text-xs text-green-800 font-bold mb-2 uppercase tracking-wide">æé ˜è³‡ç”¢æˆåŠŸç‡</h3>
                    <div class="flex items-center gap-2 h-[34px]">
                         <div class="text-2xl font-bold text-green-600 font-mono-num" id="success-rate">---%</div>
                    </div>
                </div>
            </div>

            <div class="card relative">
                <!-- 1. è³‡ç”¢è¡¨æ ¼ -->
                <div class="mb-8 overflow-x-auto">
                    <h4 class="text-sm font-bold text-gray-600 mb-3 pl-3 border-l-4 border-gray-400">è³‡ç”¢ç´¯ç©è©³ç´°æ•¸æ“š (è¬å…ƒ)</h4>
                    <table class="w-full text-sm text-center border border-gray-200 rounded-lg overflow-hidden table-fixed">
                        <thead class="bg-gray-100 text-gray-700 font-bold">
                            <tr id="mc-detail-table-head"></tr>
                        </thead>
                        <tbody id="mc-detail-table-body" class="bg-white divide-y divide-gray-100 font-mono-num text-gray-800"></tbody>
                    </table>
                </div>

                <!-- 2. æé ˜é‡‘é¡è¡¨æ ¼ -->
                <div class="mb-8 overflow-x-auto">
                    <h4 class="text-sm font-bold text-orange-600 mb-3 pl-3 border-l-4 border-orange-400">é ä¼°æ¯å¹´å¯æé ˜ç”Ÿæ´»è²» (è¬å…ƒ)</h4>
                    <table class="w-full text-sm text-center border border-gray-200 rounded-lg overflow-hidden table-fixed">
                        <thead class="bg-orange-50 text-orange-800 font-bold">
                            <tr id="mc-withdraw-table-head"></tr>
                        </thead>
                        <tbody id="mc-withdraw-table-body" class="bg-white divide-y divide-gray-100 font-mono-num text-gray-800"></tbody>
                    </table>
                    <p class="text-xs text-gray-400 mt-2">* æ­¤è¡¨é¡¯ç¤ºåœ¨ä¸åŒå¸‚å ´æƒ…å¢ƒä¸‹ï¼Œä¾ç…§æ‰€é¸ç­–ç•¥å¯¦éš›èƒ½æé ˜çš„é‡‘é¡ï¼ˆå·²å«é€šè†¨èª¿æ•´ï¼‰ã€‚</p>
                </div>

                <!-- 3. åœ–è¡¨ -->
                <div class="flex justify-between items-center mb-6 border-t pt-6 border-gray-200">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">æœ€çµ‚è³‡ç”¢è·¯å¾‘æ¨¡æ“¬</h3>
                        <p class="text-xs text-gray-500 mt-1">æ‰£é™¤æé ˜å¾Œçš„è³‡ç”¢è®ŠåŒ–è¶¨å‹¢ (75% æ©Ÿç‡å€é–“)</p>
                    </div>
                    <button onclick="resetZoom()" class="text-xs bg-white hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded border border-gray-300 shadow-sm transition font-medium">
                        <i class="fa-solid fa-magnifying-glass-minus mr-1"></i>é‡ç½®ç¸®æ”¾
                    </button>
                </div>
                <div class="h-96 w-full">
                    <canvas id="mcChart"></canvas>
                </div>
                
                <div class="grid grid-cols-3 gap-6 mt-6 text-center text-sm border-t border-gray-100 pt-6">
                    <div class="space-y-1">
                        <div class="text-xs font-bold text-green-700 bg-green-50 inline-block px-2 py-1 rounded">ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num privacy-target" id="res-low">---</div>
                        <div class="text-[10px] text-gray-400">è‹¥é‡åˆ°è¼ƒå·®å¸‚æ³ï¼Œè³‡ç”¢è‡³å°‘é‚„æœ‰...</div>
                    </div>
                    <div class="space-y-1 border-l border-r border-gray-100">
                        <div class="text-xs font-bold text-blue-700 bg-blue-50 inline-block px-2 py-1 rounded">ä¸­ä½è¶¨å‹¢ (é æœŸ)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num privacy-target" id="res-p50">---</div>
                        <div class="text-[10px] text-gray-400">çµ±è¨ˆä¸Šæœ€å¯èƒ½çš„çµæœ</div>
                    </div>
                    <div class="space-y-1">
                        <div class="text-xs font-bold text-red-700 bg-red-50 inline-block px-2 py-1 rounded">æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num privacy-target" id="res-high">---</div>
                        <div class="text-[10px] text-gray-400">è‹¥å¸‚å ´è¡¨ç¾å„ªç•°ï¼Œè³‡ç”¢å¯é”...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. ç­–ç•¥å»ºè­° -->
        <section class="card bg-slate-50 border-slate-200">
            <h2 class="text-xl font-bold text-gray-800 mb-6">æé ˜ç­–ç•¥ç¸½çµèˆ‡å»ºè­°</h2>
            
            <div id="zero-warning" class="hidden mb-6 border-l-4 border-red-500 bg-red-50 p-4 rounded-md shadow-sm">
                <div class="flex items-start">
                    <div class="ml-3">
                        <h3 class="text-lg font-bold text-red-800">âš ï¸ è­¦å ±ï¼šä¿å®ˆæƒ…å¢ƒä¸‹é¢è‡¨ã€Œè³‡ç”¢æ­¸é›¶ã€é¢¨éšª</h3>
                        <div class="mt-2 text-sm text-red-700 space-y-1">
                            <p>å»ºè­°èª¿æ•´ï¼šé™ä½æé ˜ç‡ã€å¢åŠ ç¾é‡‘ç·©è¡ã€æˆ–æ¸›å°‘æ§“æ¡¿æ¯”ä¾‹ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="strategy-card"><span class="strategy-title">1. å›ºå®šç™¾åˆ†æ¯”æé ˜</span>å„ªé»ï¼šæ°¸ä¸ç ´ç”¢ã€‚ç¼ºé»ï¼šæ³¢å‹•å¤§ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">2. å›ºå®šé‡‘é¡ (SWR)</span>å„ªé»ï¼šç©©å®šã€‚ç¼ºé»ï¼šå¯èƒ½ç ´ç”¢ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">3. Vanguard å‹•æ…‹</span>è¨­ä¸Šä¸‹é™ï¼Œå¹³è¡¡ç©©å®šèˆ‡å®‰å…¨ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">4. Guyton-Klinger</span>ç‹€æ³ä¸å¥½æ™‚æ¸›è–ªï¼Œé©åˆé«˜æ³¢å‹•ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">5. 1/N æé ˜æ³•</span>æŒ‰å‰©é¤˜å£½å‘½æé ˜ï¼Œæ­»å‰èŠ±å®Œã€‚</div>
                <div class="strategy-card"><span class="strategy-title">6. CAPE ä¼°å€¼</span>å¸‚å ´è²´å°‘é ˜ï¼Œä¾¿å®œå¤šé ˜ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">7. VPW è®Šå‹•ç™¾åˆ†æ¯”</span>çµåˆå¹´é‡‘å…¬å¼ï¼Œæ•ˆç‡æœ€é«˜ã€‚</div>
                <div class="strategy-card bg-white border border-blue-200">
                    <span class="strategy-title text-center text-blue-700"><i class="fa-solid fa-lightbulb mr-1"></i> æ‚¨çš„çµ„åˆå»ºè­°</span>
                    <div id="dynamic-advice" class="mt-2 text-gray-700 space-y-2 italic">
                        <!-- JS populated -->
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        let isPrivacyMode = false;
        let cachedMcResults = null;
        const FALLBACK_PRICES = { AOA: 1510, IMID: 35.50, TW: 161.03, USD: 32.5 };
        const QUOTES = [
            "ã€ŒæŠ•è³‡çš„æœ¬è³ªä¸æ˜¯æ“Šæ•—å¸‚å ´ï¼Œè€Œæ˜¯æ§åˆ¶é¢¨éšªã€‚ã€",
            "ã€Œæ™‚é–“æ˜¯æŠ•è³‡è€…æœ€å¥½çš„æœ‹å‹ï¼Œè¡å‹•å‰‡æ˜¯æœ€å¤§çš„æ•µäººã€‚ã€",
            "ã€Œåœ¨å¸‚å ´ä¸­ï¼Œæœ€æ˜‚è²´çš„ä¸€å¥è©±æ˜¯ï¼šé€™æ¬¡ä¸ä¸€æ¨£ã€‚ã€",
            "ã€Œä¿æŒç°¡å–®ï¼Œä¿æŒåˆ†æ•£ï¼Œä¿æŒä½æˆæœ¬ã€‚ã€",
            "ã€Œè€å¿ƒæ˜¯è²¡å¯Œç´¯ç©çš„é—œéµè¦ç´ ã€‚ã€",
            "ã€Œä¸è¦è©¦åœ–é æ¸¬é¢¨å‘ï¼Œèª¿æ•´ä½ çš„é¢¨å¸†å³å¯ã€‚ã€",
            "ã€Œè¤‡åˆ©æ˜¯ä¸–ç•Œç¬¬å…«å¤§å¥‡è¹Ÿï¼Œäº†è§£å®ƒçš„äººè³ºå–å®ƒã€‚ã€",
            "ã€Œä¸‹è·Œæ˜¯å¸‚å ´çš„å¸¸æ…‹ï¼Œææ…Œå‰‡æ˜¯å¤šé¤˜çš„åæ‡‰ã€‚ã€",
            "ã€Œå¦‚æœä½ ä¸èƒ½åœ¨è‚¡å¸‚è·Œ50%æ™‚ä¿æŒå†·éœï¼Œä½ å°±ä¸é©åˆåšæŠ•è³‡ã€‚ã€"
        ];

        const fmtMoney = (n) => {
            if (isPrivacyMode) return "******";
            if (n === null || n === undefined) return "---";
            if (n <= 0) return "0 è¬";
            const wan = n / 10000;
            if (wan >= 10000) return (wan / 10000).toFixed(2).replace(/\.00$/, '') + " å„„";
            return Math.round(wan).toLocaleString() + " è¬";
        };
        const fmtVal = (n) => isPrivacyMode ? "******" : Math.round(n).toLocaleString();
        const fmtShare = (n) => isPrivacyMode ? "******" : Math.round(n).toLocaleString();
        const fmtPct = (n) => (n==null||isNaN(n)) ? "---" : `<span class="${n>=0?'trend-up':'trend-down'}">${n>=0?'+':''}${n.toFixed(2)}%</span>`;

        function formatCashInput(input) {
            if(isPrivacyMode) return; 
            let val = input.value.replace(/[^\d.]/g, '');
            input.value = val ? parseFloat(val).toLocaleString('en-US') : "";
        }

        function togglePrivacy() {
            isPrivacyMode = !isPrivacyMode;
            const btn = document.getElementById('btn-privacy');
            if (isPrivacyMode) {
                btn.innerHTML = '<i class="fa-solid fa-eye mr-1"></i>é¡¯ç¤ºé‡‘é¡';
                btn.className = btn.className.replace('bg-gray-100','bg-yellow-100').replace('text-gray-700','text-yellow-800');
                ['qty-aoa','qty-imid','qty-tw','val-cash'].forEach(id=>{
                    let el = document.getElementById(id);
                    el.dataset.real = el.value; 
                    el.value = "******";
                    el.disabled = true;
                    el.classList.add('masked-text');
                });
            } else {
                btn.innerHTML = '<i class="fa-solid fa-eye-slash mr-1"></i>éš±è—è³‡ç”¢';
                btn.className = btn.className.replace('bg-yellow-100','bg-gray-100').replace('text-yellow-800','text-gray-700');
                ['qty-aoa','qty-imid','qty-tw','val-cash'].forEach(id=>{
                    let el = document.getElementById(id);
                    if(el.dataset.real) el.value = el.dataset.real;
                    el.disabled = false;
                    el.classList.remove('masked-text');
                });
            }
            document.querySelectorAll('.privacy-target').forEach(el => {
                isPrivacyMode ? el.classList.add('privacy-blur') : el.classList.remove('privacy-blur');
            });
            calculateAll(false); 
        }

        function updateStrategyDesc() {
            const strategy = document.getElementById('withdraw-strategy').value;
            const descs = {
                'fixed-pct': 'æ¯å¹´æé ˜ç•¶ä¸‹è³‡ç”¢çš„ 4%ã€‚å„ªé»ï¼šæ°¸ä¸ç ´ç”¢ã€‚ç¼ºé»ï¼šé‡‘é¡æ³¢å‹•å¤§ã€‚',
                'swr': 'é¦–å¹´æé ˜å›ºå®š%ï¼Œå¾Œéš¨é€šè†¨èª¿æ•´ã€‚å„ªé»ï¼šè³¼è²·åŠ›ç©©å®šã€‚ç¼ºé»ï¼šå¯èƒ½ç ´ç”¢ã€‚',
                'vanguard': 'è¨­å®šæé ˜ä¸Šä¸‹é™ (ä¾‹å¦‚ +5% / -2.5%)ã€‚å¹³è¡¡ç©©å®šèˆ‡å®‰å…¨ã€‚',
                'gk': 'è‹¥è³‡ç”¢è·Œå ±é…¬è² å€¼ï¼Œä¸èª¿é€šè†¨ï¼›è‹¥æé ˜ç‡é£†é«˜ï¼Œæ¸›è–ª 10%ã€‚',
                'one-n': 'æ¯å¹´æé ˜ 1 / å‰©é¤˜å¹´æ•¸ã€‚ç¢ºä¿æ­»å‰å‰›å¥½èŠ±å®Œã€‚',
                'cape': 'å¸‚å ´è²´æ™‚å°‘é ˜ï¼Œä¾¿å®œæ™‚å¤šé ˜ (æ¨¡æ“¬ä¼°å€¼èª¿æ•´)ã€‚',
                'vpw': 'è®Šå‹•ç™¾åˆ†æ¯”ï¼Œçµåˆå¹´é‡‘å…¬å¼èˆ‡æŠ•è³‡ç¸¾æ•ˆï¼Œä¸ç ´ç”¢ä¸”èŠ±å¾—å®Œã€‚'
            };
            document.getElementById('strategy-desc').innerText = descs[strategy];
        }

        Chart.defaults.font.family = "'Roboto', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif";
        Chart.register(ChartDataLabels);
        
        const API_PROXY = "https://corsproxy.io/?";
        const SYMBOLS = { AOA: "2330.TW", IMID: "IMID.L", TW: "00631L.TW" };
        let portfolioStats = { totalVal: 0, weightedReturn: 0.08, weightedVol: 0.15 }; 
        let countryChart = null, mcChart = null;

        function saveData() {
            const getRealVal = (id) => {
                let el = document.getElementById(id);
                return (isPrivacyMode && el.dataset.real) ? el.dataset.real : el.value;
            };
            const data = {
                qtyAoa: getRealVal('qty-aoa'), qtyImid: getRealVal('qty-imid'), qtyTw: getRealVal('qty-tw'), valCash: getRealVal('val-cash'),
                targetAoa: document.getElementById('target-aoa').value,
                targetImid: document.getElementById('target-imid').value,
                targetTw: document.getElementById('target-tw').value,
                targetCash: document.getElementById('target-cash').value,
                simYears: document.getElementById('sim-years').value,
                withdrawRate: document.getElementById('withdraw-rate').value,
                inflationRate: document.getElementById('inflation-rate').value,
                costDrag: document.getElementById('cost-drag').value,
                costAoa: document.getElementById('price-aoa').value, 
                costImid: document.getElementById('price-imid').value,
                costTw: document.getElementById('price-tw').value,
                strategy: document.getElementById('withdraw-strategy').value
            };
            localStorage.setItem('portfolioData', JSON.stringify(data));
            const x = document.getElementById("toast");
            x.className = "show"; setTimeout(()=>x.className=x.className.replace("show",""), 3000);
        }

        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                const d = JSON.parse(saved);
                if(d.qtyAoa) document.getElementById('qty-aoa').value = d.qtyAoa;
                if(d.qtyImid) document.getElementById('qty-imid').value = d.qtyImid;
                if(d.qtyTw) document.getElementById('qty-tw').value = d.qtyTw;
                if(d.valCash) document.getElementById('val-cash').value = d.valCash;
                if(d.targetAoa) document.getElementById('target-aoa').value = d.targetAoa;
                if(d.targetImid) document.getElementById('target-imid').value = d.targetImid;
                if(d.targetTw) document.getElementById('target-tw').value = d.targetTw;
                if(d.targetCash) document.getElementById('target-cash').value = d.targetCash;
                if(d.simYears) document.getElementById('sim-years').value = d.simYears;
                if(d.withdrawRate) document.getElementById('withdraw-rate').value = d.withdrawRate;
                if(d.inflationRate) document.getElementById('inflation-rate').value = d.inflationRate;
                if(d.costDrag) document.getElementById('cost-drag').value = d.costDrag;
                if(d.strategy) document.getElementById('withdraw-strategy').value = d.strategy;
            }
        }

        function initCharts() {
            const ctxC = document.getElementById('countryChart').getContext('2d');
            countryChart = new Chart(ctxC, {
                type: 'pie', 
                data: {
                    labels: ['ç¾åœ‹','å°ç£','æ­æ´²','äºæ´²(ä¸å«å°ç£)','å…¶ä»–','ç¾é‡‘'],
                    datasets: [{ data: [0,0,0,0,0,0], backgroundColor: ['#2563eb','#16a34a','#9333ea','#f59e0b','#06b6d4','#9ca3af'], borderWidth:2, borderColor:'#fff' }]
                },
                options: {
                    maintainAspectRatio: false, responsive: true,
                    plugins: { 
                        legend: { position:'right', labels:{usePointStyle:true} },
                        datalabels: { color:'#fff', font:{weight:'900',size:14}, formatter: (v,c)=>{
                            // Keep chart labels visible even in privacy mode
                            let d=c.chart.data.datasets[0].data, sum=d.reduce((a,b)=>a+b,0), p=v*100/sum, s=[...d].sort((a,b)=>b-a);
                            return (v>=s[2] && p>2) ? c.chart.data.labels[c.dataIndex]+"\n"+p.toFixed(1)+"%" : "";
                        }},
                        tooltip: {
                            callbacks: {
                                label: function(c) {
                                    // Blur tooltip content if privacy mode
                                    if (isPrivacyMode) return `${c.label}: ******`;
                                    let sum = c.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return `${c.label}: ${fmtMoney(c.raw)} (${(c.raw*100/sum).toFixed(1)}%)`;
                                }
                            }
                        }
                    }
                }
            });

            const ctxMc = document.getElementById('mcChart').getContext('2d');
            mcChart = new Chart(ctxMc, {
                type: 'line', data: {labels:[], datasets:[]},
                options: {
                    maintainAspectRatio: false, responsive: true,
                    elements: { point: {radius:0, hitRadius:10} },
                    interaction: { mode:'index', intersect:false },
                    plugins: {
                        legend: { position:'top', labels:{usePointStyle:true, sort:(a,b)=>['ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)','ä¸­ä½è¶¨å‹¢ (é æœŸ)','æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)'].indexOf(a.text)-['ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)','ä¸­ä½è¶¨å‹¢ (é æœŸ)','æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)'].indexOf(b.text)} },
                        datalabels: {display:false},
                        tooltip: {
                            backgroundColor: 'rgba(255,255,255,0.95)', titleColor:'#1f2937', bodyColor:'#1f2937', borderColor:'#e5e7eb', borderWidth:1, padding:10,
                            itemSort: (a,b)=>b.raw-a.raw,
                            callbacks: { title: t=>`ç¬¬ ${t[0].label} å¹´ (${new Date().getFullYear()+parseInt(t[0].label)} å¹´)`, label: c=> {
                                let val = isPrivacyMode ? "******" : fmtMoney(c.parsed.y);
                                return c.dataset.label+": "+val;
                            }}
                        },
                        zoom: { zoom:{wheel:{enabled:true}, pinch:{enabled:true}, drag:{enabled:true, backgroundColor:'rgba(59,130,246,0.1)'}, mode:'x'}, pan:{enabled:true, mode:'x'} }
                    },
                    scales: { y: {beginAtZero:true, ticks:{callback:v=>isPrivacyMode?"******":fmtMoney(v), font:{family:'Roboto Mono'}}}, x:{grid:{display:false}} }
                }
            });
        }
        function resetZoom(){ if(mcChart) mcChart.resetZoom(); }

        const getVal = (id) => {
            let el = document.getElementById(id);
            let valStr = (isPrivacyMode && el.dataset.real) ? el.dataset.real : el.value;
            if(!valStr) return 0;
            return parseFloat(valStr.toString().replace(/,/g,'')) || 0;
        };

        async function fetchYahooData(symbol) {
            const url = `${API_PROXY}https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=10y&interval=1d`;
            try {
                const res = await fetch(url);
                const json = await res.json();
                const r = json.chart.result[0];
                const q = r.indicators.quote[0].close;
                const t = r.timestamp;
                const h = [];
                for(let i=0; i<t.length; i++) if(q[i]!=null) h.push({date: new Date(t[i]*1000), price: q[i]});
                
                const prices = h.map(x=>x.price);
                const ret = (Math.pow(prices[prices.length-1]/prices[0], 1/(prices.length/252)) - 1);
                const returns = [];
                for(let i=1; i<prices.length; i++) returns.push(Math.log(prices[i]/prices[i-1]));
                const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
                const std = Math.sqrt(returns.map(x=>Math.pow(x-mean, 2)).reduce((a,b)=>a+b,0)/returns.length);
                const vol = std * Math.sqrt(252);

                return { price: r.meta.regularMarketPrice, prevClose: h[h.length-2].price, history: h, stats: { return: ret, vol: vol } };
            } catch (e) { return null; }
        }

        async function fetchAllData() {
            document.getElementById('status-msg').innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> æ›´æ–°ä¸­...';
            let usd = FALLBACK_PRICES.USD;
            try {
                const r = await fetch("https://open.er-api.com/v6/latest/USD").then(r=>r.json());
                usd = r.rates.TWD;
            } catch {}
            document.getElementById('usd-rate').value = usd.toFixed(2);

            const [dA, dI, dT] = await Promise.all([ fetchYahooData(SYMBOLS.AOA), fetchYahooData(SYMBOLS.IMID), fetchYahooData(SYMBOLS.TW) ]);
            
            if(dA) { document.getElementById('price-aoa').value = dA.price.toFixed(2); renderRow('row-AOA', 'AOA', dA); }
            if(dI) { document.getElementById('price-imid').value = dI.price.toFixed(2); renderRow('row-IMID', 'IMID', dI); }
            if(dT) { document.getElementById('price-tw').value = dT.price.toFixed(2); renderRow('row-TW', '00631L', dT); }

            window.assetData = { 
                AOA: dA || { stats: {return:0.08, vol:0.12} }, 
                IMID: dI || { stats: {return:0.09, vol:0.20} }, 
                TW: dT || { stats: {return:0.25, vol:0.50} } 
            };

            const now = new Date();
            document.getElementById('status-msg').innerHTML = `<span class="text-green-600 text-xs">å·²æ›´æ–° ${now.toLocaleTimeString()}</span>`;
            calculateAll(true); 
        }

        function renderRow(id, name, data) {
            const p=data.price, h=data.history, chg=((p-data.prevClose)/data.prevClose)*100;
            const perf = (d,ann) => {
                let dt=new Date(); dt.setDate(dt.getDate()-d);
                let old=h.findLast(x=>x.date<=dt)?.price;
                return old ? (ann ? (Math.pow(p/old,1/(d/365))-1)*100 : ((p-old)/old)*100) : null;
            };
            document.getElementById(id).innerHTML = `
                <td class="p-3 font-bold text-left text-gray-800 font-mono-num">${name}</td>
                <td class="p-3 font-mono font-bold text-gray-900">${p.toFixed(2)}</td>
                <td class="p-3 font-mono">${fmtPct(chg)}</td>
                <td class="p-3 text-gray-600">${fmtPct(perf(7))}</td>
                <td class="p-3 text-gray-600">${fmtPct(perf(30))}</td>
                <td class="p-3 text-gray-600">${fmtPct(perf((new Date()-new Date(new Date().getFullYear(),0,1))/86400000))}</td>
                <td class="p-3 bg-orange-50/50">${fmtPct(perf(365,1))}</td>
                <td class="p-3 bg-orange-50/50">${fmtPct(perf(365*3,1))}</td>
                <td class="p-3 bg-orange-50/50">${fmtPct(perf(365*5,1))}</td>
                <td class="p-3 bg-orange-50/50">${fmtPct(perf(365*10,1))}</td>
            `;
        }

        function calculateAll(runSim = true) {
            const usd = parseFloat(document.getElementById('usd-rate').value)||32.5;
            const qA=getVal('qty-aoa'), pA=getVal('price-aoa'), tA=getVal('target-aoa');
            const qI=getVal('qty-imid'), pI=getVal('price-imid'), tI=getVal('target-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw'), tT=getVal('target-tw');
            
            const elCash = document.getElementById('val-cash');
            let vCash = 0;
            if (isPrivacyMode && elCash.dataset.real) {
                vCash = parseFloat(elCash.dataset.real.replace(/,/g, '')) || 0;
            } else {
                vCash = parseFloat(elCash.value.replace(/,/g, '')) || 0;
            }
            const tCash = getVal('target-cash');

            // 1. ä¿®æ­£è¨ˆç®—å…¬å¼ (ç¢ºä¿æ²’æœ‰å¤šé¤˜çš„æ‹¬è™Ÿ)
            const vA = Math.round(qA*pA);  // å°ç©é›»ç›´æ¥ä¹˜è‚¡åƒ¹ï¼Œä¸ä¹˜åŒ¯ç‡
            const vI = Math.round(qI*pI*usd);
            const vT = Math.round(qT*pT);
            const total = vA+vI+vT+vCash;

            document.getElementById('val-aoa').value = fmtVal(vA);
            document.getElementById('val-imid').value = fmtVal(vI);
            document.getElementById('val-tw').value = fmtVal(vT);
            const elTotal = document.getElementById('total-assets');
            elTotal.innerText = fmtMoney(total);
            isPrivacyMode ? elTotal.classList.add('privacy-blur') : elTotal.classList.remove('privacy-blur');

            const setAct = (id, cur, tgtPct, px, isC) => {
                const diff = (total*(tgtPct/100)) - cur;
                let txt = "-";
                if(isPrivacyMode) {
                    txt = "******";
                } else {
                    if(isC && Math.abs(diff)>1) {
                        const wVal = Math.round(Math.abs(diff)/10000);
                        const type = diff>0?'å­˜':'å–';
                        txt = `<span class="${diff>0?'text-red-500':'text-green-600'}">${type} ${wVal} è¬å…ƒ</span>`;
                    } else if(px>0) {
                        const s = Math.round(diff/px);
                        if(s!=0) txt = `<span class="${s>0?'text-red-500':'text-green-600'}">${s>0?'è²·':'è³£'} ${fmtShare(Math.abs(s))} è‚¡</span>`;
                    }
                }
                const el = document.getElementById(id);
                el.innerHTML = txt;
                isPrivacyMode ? el.classList.add('privacy-blur') : el.classList.remove('privacy-blur');
            };
            setAct('act-aoa', vA, tA, pA);
            setAct('act-imid', vI, tI, pI*usd);
            setAct('act-tw', vT, tT, pT);
            setAct('act-cash', vCash, tCash, 1, true);

            const sA = window.assetData?.AOA?.stats || {return:0.08, vol:0.12};
            const sI = window.assetData?.IMID?.stats || {return:0.09, vol:0.20};
            const sT_raw = window.assetData?.TW?.stats || {return:0.25, vol:0.50};
            const sT = { return: sT_raw.return * 0.7, vol: sT_raw.vol }; 
            
            const wA = tA/100, wI = tI/100, wT = tT/100, wC = tCash/100;
            const portRet = (wA*sA.return) + (wI*sI.return) + (wT*sT.return) + (wC*0.01);
            const portVol = (wA*sA.vol) + (wI*sI.vol) + (wT*sT.vol); 
            portfolioStats = { totalVal: total, weightedReturn: portRet, weightedVol: portVol };
            
            if(countryChart) {
                // 3. ä¿®æ­£å€åŸŸæ›éšª (vA æ˜¯å°ç©é›»ï¼Œç§»åˆ°å°ç£ï¼Œä¸”ä¸è¦æœ‰å¤šé¤˜æ‹¬è™Ÿ)
                const expUS = (vI*0.58);
                const expTW = vA + (vI*0.02) + (vT*2); // vA ç›´æ¥åŠ åœ¨é€™è£¡
                const expEU = (vI*0.16);
                const expAS = (vI*0.17);
                const expOT = (vI*0.07);
                
                countryChart.data.datasets[0].data = [expUS, expTW, expEU, expAS, expOT, vCash];
                countryChart.update();
            }
            
            if (runSim) runMonteCarlo(true);
            else if (cachedMcResults) renderMCResults(cachedMcResults);
        }

        function runMonteCarlo(recalculate) {
            const years = parseInt(document.getElementById('sim-years').value)||45;
            const ratePct = parseFloat(document.getElementById('withdraw-rate').value)||4.0;
            const inflationRate = parseFloat(document.getElementById('inflation-rate').value)||3.0;
            const costDrag = parseFloat(document.getElementById('cost-drag').value)||1.5;
            const strategy = document.getElementById('withdraw-strategy').value;
            const startVal = portfolioStats.totalVal;
            
            const descs = {
                'fixed-pct': 'æ¯å¹´æé ˜ç•¶ä¸‹è³‡ç”¢çš„ 4%ã€‚å„ªé»ï¼šæ°¸ä¸ç ´ç”¢ã€‚ç¼ºé»ï¼šé‡‘é¡æ³¢å‹•å¤§ã€‚',
                'swr': 'é¦–å¹´æé ˜å›ºå®š%ï¼Œå¾Œéš¨é€šè†¨èª¿æ•´ã€‚å„ªé»ï¼šè³¼è²·åŠ›ç©©å®šã€‚ç¼ºé»ï¼šå¯èƒ½ç ´ç”¢ã€‚',
                'vanguard': 'è¨­å®šæé ˜ä¸Šä¸‹é™ (ä¾‹å¦‚ +5% / -2.5%)ã€‚å¹³è¡¡ç©©å®šèˆ‡å®‰å…¨ã€‚',
                'gk': 'è‹¥è³‡ç”¢è·Œå ±é…¬è² å€¼ï¼Œä¸èª¿é€šè†¨ï¼›è‹¥æé ˜ç‡é£†é«˜ï¼Œæ¸›è–ª 10%ã€‚',
                'one-n': 'æ¯å¹´æé ˜ 1 / å‰©é¤˜å¹´æ•¸ã€‚ç¢ºä¿æ­»å‰å‰›å¥½èŠ±å®Œã€‚',
                'cape': 'å¸‚å ´è²´æ™‚å°‘é ˜ï¼Œä¾¿å®œæ™‚å¤šé ˜ (æ¨¡æ“¬ä¼°å€¼èª¿æ•´)ã€‚',
                'vpw': 'è®Šå‹•ç™¾åˆ†æ¯”ï¼Œçµåˆå¹´é‡‘å…¬å¼èˆ‡æŠ•è³‡ç¸¾æ•ˆï¼Œä¸ç ´ç”¢ä¸”èŠ±å¾—å®Œã€‚'
            };
            document.getElementById('strategy-desc').innerText = descs[strategy];

            if(startVal === 0) return;

            const initialW = startVal * (ratePct / 100);
            const wEl = document.getElementById('withdraw-amt');
            wEl.innerText = fmtMoney(initialW).replace(" è¬", "");
            isPrivacyMode ? wEl.classList.add('privacy-blur') : wEl.classList.remove('privacy-blur');

            if (!recalculate && cachedMcResults) {
                renderMCResults(cachedMcResults);
                return;
            }

            const simulations = 10000;
            const mu = portfolioStats.weightedReturn - (costDrag / 100);
            const sigma = portfolioStats.weightedVol;
            const inf = inflationRate / 100;

            const yearlyData = new Array(years + 1).fill(0).map(() => []);
            const yearlyW = new Array(years + 1).fill(0).map(() => []);
            let successCount = 0;

            for(let i=0; i<simulations; i++) {
                let cur = startVal;
                let w = initialW;
                let prevW = initialW;
                let alive = true;
                yearlyData[0].push(cur);
                yearlyW[0].push(w); 

                for(let y=1; y<=years; y++) {
                    if(!alive) { yearlyData[y].push(0); yearlyW[y].push(0); continue; }
                    
                    const u1=Math.random(), u2=Math.random();
                    const z=Math.sqrt(-2*Math.log(u1))*Math.cos(2*Math.PI*u2);
                    const ret=Math.exp(mu-0.5*sigma*sigma+sigma*z);
                    const mktRetPct = ret - 1;

                    cur = cur * ret; 

                    switch(strategy) {
                        case 'fixed-pct': w = cur * (ratePct/100); break;
                        case 'swr': w = prevW * (1+inf); break;
                        case 'vanguard': 
                            let t = cur*(ratePct/100), f=prevW*(1+inf)*0.975, c=prevW*(1+inf)*1.05;
                            w = Math.min(Math.max(t,f),c); break;
                        case 'gk':
                            let nw = (mktRetPct < 0) ? prevW : prevW * (1+inf);
                            if((nw/cur) > (ratePct/100)*1.2) nw *= 0.9;
                            w = nw; break;
                        case 'one-n':
                            let rem = years - y + 1;
                            w = (rem>0) ? cur/rem : cur; break;
                        case 'cape':
                            let yld = (ratePct/100) - 0.1*(mktRetPct-mu);
                            if(yld<0.01) yld=0.01; w = cur*yld; break;
                        case 'vpw':
                            let rm = years-y+1, r=(ratePct/100);
                            let pf = r/(1-Math.pow(1+r, -rm)); w=cur*pf; break;
                    }

                    if(w > cur) w = cur; 
                    cur -= w;
                    if(cur<=0.01) { 
                        cur=0; 
                        // ä¿®æ­£é‚è¼¯ï¼šå¦‚æœæ˜¯ 1/N æˆ– VPWï¼Œä¸”æ˜¯æœ€å¾Œä¸€å¹´æ­¸é›¶ï¼Œè¦–ç‚ºæˆåŠŸ
                        if (!((strategy === 'one-n' || strategy === 'vpw') && y === years)) {
                            alive = false; 
                        }
                    } 
                    prevW = w;
                    yearlyData[y].push(cur);
                    yearlyW[y].push(w);
                }
                if(alive) successCount++;
            }

            const pLow=[], p50=[], pHigh=[];
            const wLow=[], w50=[], wHigh=[];

            for(let y=0; y<=years; y++) {
                yearlyData[y].sort((a,b)=>a-b);
                yearlyW[y].sort((a,b)=>a-b);
                
                pLow.push(yearlyData[y][Math.floor(simulations*0.125)]);
                p50.push(yearlyData[y][Math.floor(simulations*0.50)]);
                pHigh.push(yearlyData[y][Math.floor(simulations*0.875)]);

                wLow.push(yearlyW[y][Math.floor(simulations*0.125)]);
                w50.push(yearlyW[y][Math.floor(simulations*0.50)]);
                wHigh.push(yearlyW[y][Math.floor(simulations*0.875)]);
            }

            cachedMcResults = {
                years: years,
                successRate: successCount/simulations,
                pLow: pLow, p50: p50, pHigh: pHigh,
                wLow: wLow, w50: w50, wHigh: wHigh
            };

            renderMCResults(cachedMcResults);
        }

        function renderMCResults(data) {
            const { years, successRate, pLow, p50, pHigh, wLow, w50, wHigh } = data;

            const rEl = document.getElementById('success-rate');
            rEl.innerText = (successRate*100).toFixed(1) + "%";
            rEl.className = successRate<0.75?"text-2xl font-bold text-red-600 font-mono-num":(successRate<0.9?"text-2xl font-bold text-yellow-600 font-mono-num":"text-2xl font-bold text-green-600 font-mono-num");

            document.getElementById('res-low').innerText = fmtMoney(pLow[years]);
            document.getElementById('res-p50').innerText = fmtMoney(p50[years]);
            document.getElementById('res-high').innerText = fmtMoney(pHigh[years]);

            const zw = document.getElementById('zero-warning');
            const da = document.getElementById('dynamic-advice');
            
            // ä¿®æ­£ï¼šåªæœ‰ç•¶æˆåŠŸç‡é 100% ä¸” ä¿å®ˆæƒ…å¢ƒæ­¸é›¶æ™‚æ‰è­¦å‘Š
            if(pLow[years]<=0 && successRate < 0.99) {
                zw.classList.remove('hidden');
                da.innerHTML = "<span class='text-red-600 font-bold'>âš ï¸ è­¦å‘Šï¼šä¿å®ˆæƒ…å¢ƒä¸‹é¢è‡¨è³‡ç”¢æ­¸é›¶é¢¨éšªï¼Œè«‹å„ªå…ˆè§£æ±ºã€‚</span>";
            } else {
                zw.classList.add('hidden');
                const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
                da.innerHTML = `<span class="text-gray-600 italic">"${q}"</span>`;
            }

            updateMcChart(years, pLow, p50, pHigh);
            updateTable('mc-detail-table', years, pLow, p50, pHigh);
            updateTable('mc-withdraw-table', years, wLow, w50, wHigh);
            
            const resTargets = ['res-low', 'res-p50', 'res-high'];
            resTargets.forEach(id => {
                const el = document.getElementById(id);
                isPrivacyMode ? el.classList.add('privacy-blur') : el.classList.remove('privacy-blur');
            });
        }

        function updateTable(idPrefix, years, low, mid, high) {
            const head = document.getElementById(idPrefix+'-head');
            const body = document.getElementById(idPrefix+'-body');
            const now = new Date().getFullYear();
            const points = [3,5,10,20,30,40];
            
            let h = '<th class="p-3 w-1/5">æƒ…å¢ƒ / å¹´ä»½</th>';
            let r1 = `<td class="p-3 text-left font-bold text-green-700 bg-green-50">ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)</td>`;
            let r2 = `<td class="p-3 text-left font-bold text-blue-700 bg-blue-50">ä¸­ä½è¶¨å‹¢ (é æœŸ)</td>`;
            let r3 = `<td class="p-3 text-left font-bold text-red-700 bg-red-50">æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)</td>`;

            points.forEach(y => {
                if(y<=years) {
                    h += `<th class="p-3 w-auto">ç¬¬ ${y} å¹´<br><span class="text-xs font-normal text-gray-500">(${now+y}å¹´)</span></th>`;
                    r1 += `<td class="p-3 font-bold text-green-600 privacy-target">${fmtMoney(low[y])}</td>`;
                    r2 += `<td class="p-3 font-bold text-blue-600 privacy-target">${fmtMoney(mid[y])}</td>`;
                    r3 += `<td class="p-3 font-bold text-red-600 privacy-target">${fmtMoney(high[y])}</td>`;
                }
            });
            head.innerHTML = h; body.innerHTML = `<tr>${r1}</tr><tr>${r2}</tr><tr>${r3}</tr>`;
            
            if(isPrivacyMode) {
                document.querySelectorAll('#'+idPrefix+'-body .privacy-target').forEach(el => el.classList.add('privacy-blur'));
            }
        }

        function updateMcChart(years, pLow, p50, pHigh) {
            const labels = Array.from({length: years+1}, (_, i) => i);
            mcChart.data.labels = labels;
            mcChart.data.datasets = [
                { label: 'ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)', data: pLow, borderColor: 'rgba(22, 163, 74, 0.8)', borderWidth: 2, fill: false, pointRadius: 0 },
                { label: 'æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)', data: pHigh, borderColor: 'rgba(239, 68, 68, 0.8)', backgroundColor: 'rgba(253, 224, 71, 0.4)', borderWidth: 2, fill: '-1', pointRadius: 0 },
                { label: 'ä¸­ä½è¶¨å‹¢ (é æœŸ)', data: p50, borderColor: '#2563eb', borderWidth: 3, fill: false, pointRadius: 0 }
            ];
            mcChart.resetZoom();
            mcChart.update();
        }

        window.onload = function() { loadData(); initCharts(); fetchAllData(); };
    </script>
</body>

</html>


