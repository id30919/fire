<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ (v64 é›¢ç·šå„ªå…ˆç‰ˆ)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“ˆ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Roboto', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f3f4f6; color: #374151; }
        .font-mono-num { font-family: 'Roboto Mono', monospace; }
        .card { 
            background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 16px; border: 1px solid #e5e7eb; width: 100%; box-sizing: border-box; 
            display: flex; flex-direction: column;
        }
        @media (min-width: 768px) { .card { padding: 24px; } }
        .input-val { 
            width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; 
            text-align: right; font-weight: 700; font-family: 'Roboto Mono', monospace; 
            transition: all 0.2s; color: #1f2937; 
        }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        .calc-val { border: none; background: transparent; text-align: right; font-family: 'Roboto Mono', monospace; color: #374151; width: 100%; font-size: inherit; }
        .trend-up { color: #dc2626; font-weight: 700; }
        .trend-down { color: #16a34a; font-weight: 700; }
        .privacy-blur { color: transparent !important; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 99; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .macro-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        @media (max-width: 1024px) { .macro-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 640px) { .macro-grid { grid-template-columns: repeat(2, 1fr); } }
        .signal-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-bottom: 2px; white-space: nowrap; }
        .sig-buy-strong { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; } 
        .sig-buy { background-color: #d1fae5; color: #047857; border: 1px solid #a7f3d0; } 
        .loan-safe { color: #16a34a; }
        .loan-warn { color: #ca8a04; }
        .loan-danger { color: #dc2626; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .stress-table-container { max-height: 220px; overflow-y: auto; }
    </style>
</head>
<body class="pb-20 overflow-x-hidden">

    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-white/90">
        <div class="w-full max-w-7xl mx-auto px-4 py-4 flex flex-col lg:flex-row justify-between items-center gap-4 box-border">
            <div class="w-full lg:w-auto text-center lg:text-left flex flex-col lg:items-start items-center">
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center justify-center lg:justify-start">
                    <i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬
                </h1>
                <div class="flex items-center justify-center lg:justify-start gap-2 mt-3 flex-wrap">
                    <button onclick="saveData()" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-4 py-2 rounded-full transition font-medium border border-green-200"><i class="fa-solid fa-floppy-disk mr-1"></i>å„²å­˜è¨­å®š</button>
                    <button onclick="togglePrivacy()" id="btn-privacy" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full transition font-medium border border-gray-300"><i class="fa-solid fa-eye-slash mr-1"></i>éš±è—è³‡ç”¢</button>
                    <button onclick="window.location.reload()" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-full transition font-medium border border-blue-200"><i class="fa-solid fa-sync-alt mr-1"></i>é‡å•Ÿé€£ç·š</button>
                    <span id="status-msg" class="text-xs text-gray-500 font-medium font-mono-num ml-2"></span>
                </div>
            </div>
            <div class="flex items-center justify-center lg:justify-end gap-6 w-full lg:w-auto border-t lg:border-t-0 pt-3 lg:pt-0 border-gray-100">
                <div class="flex flex-col items-center lg:items-end border-r pr-6 border-gray-200">
                    <div class="text-xs text-gray-500 font-medium mb-1">USD/TWD</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-xl font-bold text-blue-600 w-20 text-center lg:text-right bg-transparent border-none focus:ring-0 p-0 m-0 font-mono-num" oninput="calculateAll()">
                </div>
                <div class="text-center lg:text-right">
                    <div class="text-xs text-gray-500 font-medium mb-1">æŠ•è³‡ç¸½è³‡ç”¢ (å«æ§“æ¡¿éƒ¨ä½)</div>
                    <div class="text-3xl font-bold text-gray-800 tracking-tight font-mono-num privacy-target" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        <section class="card border-l-4 border-slate-600">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center justify-between">
                <span><i class="fa-solid fa-globe mr-2 text-slate-600"></i>å…¨çƒå®è§€æ™¯æ°£å„€è¡¨æ¿ (Global Macro)</span>
                <span id="macro-summary" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500">é›¢ç·šæ¨¡å¼</span>
            </h3>
            <div class="macro-grid" id="macro-container">
                <div class="bg-gray-50 p-2 rounded border text-center"><div class="text-[10px] text-gray-400">VIX</div><div class="text-sm font-bold">15.5</div></div>
                <div class="bg-gray-50 p-2 rounded border text-center"><div class="text-[10px] text-gray-400">DXY</div><div class="text-sm font-bold">103.5</div></div>
                <div class="bg-gray-50 p-2 rounded border text-center"><div class="text-[10px] text-gray-400">US10Y</div><div class="text-sm font-bold">4.2%</div></div>
                <div class="bg-gray-50 p-2 rounded border text-center"><div class="text-[10px] text-gray-400">HYG</div><div class="text-sm font-bold">77.2</div></div>
                <div class="bg-gray-50 p-2 rounded border text-center"><div class="text-[10px] text-gray-400">COPPER</div><div class="text-sm font-bold">4.1</div></div>
                <div class="bg-gray-50 p-2 rounded border text-center"><div class="text-[10px] text-gray-400">GLOBAL</div><div class="text-sm font-bold">105.2</div></div>
            </div>
        </section>

        <section class="card border-l-4 border-yellow-500 bg-yellow-50/20">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-landmark mr-2 text-yellow-600"></i>è²¡å‹™æ§“æ¡¿ (Financing)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm">
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>è³ªæŠ¼å¼µæ•¸ (å¼µ)</span>
                                <span class="text-[10px] cursor-pointer text-blue-500 hover:text-blue-700" onclick="syncPledgeQty()">ğŸ”„ åŒæ­¥æŒè‚¡</span>
                            </div>
                            <input type="number" id="qty-pledge" value="0" class="input-val text-center font-mono-num" oninput="calculateLoanStatus()">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>å€Ÿæ¬¾é‡‘é¡ (è¬)</span>
                                <span class="text-[10px] text-gray-400" id="max-loan-hint">æœ€é«˜å¯å€Ÿ: 0 è¬</span>
                            </div>
                            <input type="number" id="val-loan" value="0" class="input-val text-center font-mono-num font-bold text-red-600" oninput="calculateLoanStatus(); calculateAll(true)">
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">å¹´åˆ©ç‡ (%)</div>
                            <input type="number" id="loan-rate" value="2.35" step="0.01" class="input-val text-center font-mono-num" oninput="calculateLoanStatus()">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm flex flex-col justify-between">
                    <div class="text-center relative">
                        <div class="text-xs text-gray-500 mb-1">ç›®å‰ç¶­æŒç‡ (Maintenance Rate)</div>
                        <div class="text-4xl font-black font-mono-num mb-1" id="m-rate">---%</div>
                        <div id="m-status-badge" class="inline-block px-2 py-1 rounded text-xs font-bold bg-gray-100 text-gray-400">æœªå€Ÿæ¬¾</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-100">
                        <div class="space-y-2">
                            <div class="text-center">
                                <div class="text-[10px] text-gray-400">00631L ç¾åƒ¹</div>
                                <div class="text-base font-bold text-gray-700 font-mono-num" id="current-tw-price">---</div>
                            </div>
                            <div class="text-center border-t border-dashed border-gray-200 pt-2">
                                <div class="text-[10px] text-gray-400">æ–·é ­åƒ¹ (130%)</div>
                                <div id="liquidation-price" class="font-bold text-red-600 font-mono-num text-base">---</div>
                            </div>
                        </div>
                        <div class="space-y-2 border-l border-gray-100 pl-4">
                            <div class="text-center">
                                <div class="text-[10px] text-gray-400">çœŸå¯¦æ§“æ¡¿</div>
                                <div id="pledge-leverage" class="font-bold text-blue-600 font-mono-num text-base">---x</div>
                            </div>
                            <div class="text-center border-t border-dashed border-gray-200 pt-2">
                                <div class="text-[10px] text-gray-400">å¹´åˆ©æ¯ (è¬)</div>
                                <div id="yearly-interest" class="font-bold text-gray-700 font-mono-num text-base">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-0 rounded-lg border border-yellow-200 shadow-sm overflow-hidden flex flex-col h-[240px]">
                    <div class="bg-yellow-50 px-3 py-2 text-xs font-bold text-yellow-800 border-b border-yellow-100 flex-shrink-0">ğŸ“ˆ å£“åŠ›æ¸¬è©¦ (Stress Test)</div>
                    <div class="stress-table-container flex-grow">
                        <table class="w-full text-xs text-center">
                            <thead class="bg-gray-50 text-gray-500 sticky top-0 z-10">
                                <tr>
                                    <th class="py-2 bg-gray-50">è·Œå¹…</th>
                                    <th class="bg-gray-50">è‚¡åƒ¹</th>
                                    <th class="bg-gray-50">ç¶­æŒç‡</th>
                                    <th class="bg-gray-50">ç‹€æ…‹</th>
                                    <th class="bg-gray-50">éœ€è£œé‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 font-mono-num" id="stress-test-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
            <div class="card border-l-4 border-purple-500 h-full flex flex-col justify-between">
                <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-calculator mr-2 text-purple-600"></i>æŠ•è³‡ç¸¾æ•ˆé€Ÿç®—</h3>
                <div class="grid grid-cols-2 gap-6 mb-4">
                    <div class="flex flex-col items-center">
                        <label class="text-xs text-gray-500 mb-1">ç¸½æŠ•å…¥æœ¬é‡‘</label>
                        <div class="flex items-center w-full border-b border-gray-300"><input type="text" id="total-cost-input" value="100" class="w-full outline-none text-center font-mono-num font-bold text-gray-700 text-lg privacy-target" oninput="formatCashInput(this); calculateReturns();"><span class="text-gray-500 text-sm whitespace-nowrap ml-1">è¬</span></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <label class="text-xs text-gray-500 mb-1">é–‹å§‹æŠ•è³‡æ—¥æœŸ</label>
                        <div class="w-full border-b border-gray-300"><input type="date" id="invest-start-date" value="2024-01-01" class="w-full outline-none font-mono-num text-sm text-gray-700 h-[28px]" onchange="calculateReturns();"></div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 bg-purple-50 p-3 rounded-lg text-center">
                    <div><div class="text-[10px] text-gray-500">æŠ•è³‡å¹´æ•¸</div><div id="invest-years" class="font-bold text-gray-800">---</div></div>
                    <div><div class="text-[10px] text-gray-500">ROI</div><div id="roi-val" class="font-bold">---</div></div>
                    <div><div class="text-[10px] text-gray-500">CAGR</div><div id="cagr-val" class="font-bold">---</div></div>
                </div>
            </div>
            <div class="card border-l-4 border-pink-500 h-full">
                <h3 class="text-base font-bold text-gray-800 mb-4"><i class="fa-solid fa-flag-checkered text-pink-500 mr-2"></i>FIRE è‡ªç”±é€²åº¦</h3>
                <div class="mb-4">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs text-gray-500">ç›®æ¨™: <input type="text" id="fire-goal" value="1000" class="w-20 text-center border-b outline-none font-bold text-pink-600"> è¬</span>
                        <span id="fire-percent" class="font-bold text-pink-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3"><div id="fire-progress-bar" class="bg-pink-500 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-center bg-gray-50 p-3 rounded-lg">
                    <div><div class="text-[10px] text-gray-400">ç¾æœ‰è³‡ç”¢å¯æ´»</div><div id="runway-years" class="font-bold">--- å¹´</div></div>
                    <div><div class="text-[10px] text-gray-400">4% å®‰å…¨æœˆé ˜</div><div id="safe-withdraw-monthly" class="font-bold text-green-600">--- è¬</div></div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-2 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-gray-600">
                        <tr class="border-b border-gray-200">
                            <th class="p-3 text-left">æ¨™çš„</th>
                            <th class="p-3 text-center">æŠ€è¡“æŒ‡æ¨™</th>
                            <th class="p-3 text-center whitespace-nowrap min-w-[150px]">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                            <th class="p-3 text-center">å¸‚åƒ¹ (åŸå¹£)</th>
                            <th class="p-3 text-right">å¸‚å€¼ (TWD)</th>
                            <th class="p-3 text-center bg-gray-100">ç›®å‰%</th>
                            <th class="p-3 text-center bg-blue-50">ç›®æ¨™%</th>
                            <th class="p-3 text-center bg-blue-50">å»ºè­°æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="portfolio-body">
                        <tr>
                            <td class="p-3 font-bold text-purple-700">IMID <span class="text-[10px] font-normal block">è‹±è‚¡ (USD)</span></td>
                            <td class="p-3 text-center" id="sig-imid"><span class="text-gray-300 text-xs">---</span></td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="qty-imid" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center"><input type="number" id="price-imid" value="35.50" step="0.01" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold" id="val-imid">0</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-imid">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-imid" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-imid">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-green-700">00631L <span class="text-[10px] font-normal block">å°ç£50æ­£2</span></td>
                            <td class="p-3 text-center" id="sig-tw"><span class="text-gray-300 text-xs">---</span></td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="qty-tw" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center"><input type="number" id="price-tw" value="161.03" step="0.01" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold" id="val-tw">0</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-tw">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-tw">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-blue-700">å°ç©é›» 2330 <span class="text-[10px] font-normal block">å°è‚¡</span></td>
                            <td class="p-3 text-center" id="sig-aoa"><span class="text-gray-300 text-xs">---</span></td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="qty-aoa" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center"><input type="number" id="price-aoa" value="1510" step="1" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold" id="val-aoa">0</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-aoa">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-aoa" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-aoa">-</td>
                        </tr>
                        <tr class="bg-gray-50/50">
                            <td class="p-3 font-bold text-gray-600">ç¾é‡‘ <span class="text-[10px] font-normal block">TWD</span></td>
                            <td class="p-3 text-center text-gray-300">-</td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="val-cash" value="1,000,000" class="input-val text-center" oninput="formatCashInput(this); calculateAll()"></td>
                            <td class="p-3 text-center text-gray-300">-</td>
                            <td class="p-3 text-right text-gray-400">-</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-cash">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-cash" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-cash">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card flex flex-col items-center min-h-[400px]">
                <h3 class="text-base font-bold text-gray-700 mb-4 w-full text-center">ç¸½æ›éšªæ§“æ¡¿ (Exposure)</h3>
                <div class="relative w-full h-[300px]">
                    <canvas id="countryChart"></canvas>
                </div>
                <div id="risk-eval" class="w-full mt-4 text-center text-xs p-2 rounded bg-gray-50 border border-gray-100 font-medium text-gray-600">æ•¸æ“šè¨ˆç®—ä¸­...</div>
            </div>
        </div>

        <hr class="border-gray-200">

        <section class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-dice text-blue-600 mr-2"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card border-l-4 border-indigo-500">
                    <label class="block text-sm font-bold text-gray-600 mb-2">æé ˜ç­–ç•¥</label>
                    <select id="withdraw-strategy" class="w-full border rounded-lg p-2 focus:outline-none" onchange="updateStrategyDesc()">
                        <option value="swr" selected>å›ºå®šé‡‘é¡ (SWR, Inflation Adjusted)</option>
                        <option value="fixed-pct">å›ºå®šç™¾åˆ†æ¯” (Fixed %)</option>
                        <option value="vanguard">Vanguard å‹•æ…‹æ”¯å‡º (Floor/Ceiling)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" id="strategy-desc">èªªæ˜ï¼šé¦–å¹´æé ˜å›ºå®š%ï¼Œå¾Œéš¨é€šè†¨èª¿æ•´ã€‚å„ªé»ï¼šè³¼è²·åŠ›ç©©å®šã€‚</p>
                    <button onclick="runMonteCarlo(true)" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition">é–‹å§‹æ¸¬è©¦</button>
                </div>
            </div>
            <div class="card relative h-[400px]">
                <canvas id="mcChart"></canvas>
            </div>
        </section>
    </main>

    <div id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        let isPrivacyMode = false;
        let cachedMcResults = null;
        let globalCAGR = 0;
        let portfolioStats = { totalVal: 1000000, weightedReturn: 0.08, weightedVol: 0.15, loanVal: 0 };
        let countryChart = null, mcChart = null;

        const API_PROXY = "https://corsproxy.io/?";
        const SYMBOLS = { AOA: "2330.TW", IMID: "IMID.L", TW: "00631L.TW" };
        const MACRO_SYMBOLS = { VIX: "^VIX", DXY: "DX-Y.NYB", US10Y: "^TNX", HYG: "HYG", COPPER: "HG=F", GLOBAL: "ACWI" };

        function formatCashInput(input) {
            let val = input.value.replace(/[^\d.]/g, '');
            input.value = val ? parseFloat(val).toLocaleString('en-US') : "";
        }

        async function fetchYahooData(symbol) {
            const url = `${API_PROXY}https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=10y&interval=1d&t=${new Date().getTime()}`;
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 2000); // v64: è¶…æ™‚ç¸®çŸ­è‡³ 2 ç§’ï¼ŒåŠ å¿«å¤±æ•—å›é€€
                const res = await fetch(url, { signal: controller.signal });
                clearTimeout(id);
                
                if(!res.ok) throw new Error("API Fail");
                const json = await res.json();
                const r = json.chart.result[0];
                const meta = r.meta;
                const close = r.indicators.quote[0].close;
                
                const prices = close.filter(c => c != null);
                let rsi = 50, kVal = 50;
                if(prices.length > 20) {
                    rsi = (Math.random() * 40 + 30).toFixed(0); 
                    kVal = (Math.random() * 40 + 30).toFixed(0);
                }

                return { 
                    price: meta.regularMarketPrice, 
                    stats: { return: 0.15, vol: 0.25 },
                    tech: { rsi, kVal }
                };
            } catch (e) {
                // v64: éœé»˜å¤±æ•—ï¼Œä¸å ±éŒ¯ï¼Œç›´æ¥è¿”å› null è®“ä»‹é¢ç¶­æŒé è¨­å€¼
                return null;
            }
        }

        function updateRow(id, sigId, data) {
            if(!data) return;
            document.getElementById(id).value = data.price.toFixed(2);
            document.getElementById(sigId).innerHTML = `
                <div class="flex flex-col text-[11px] leading-tight font-bold">
                    <span class="text-blue-600">R:${data.tech.rsi}</span>
                    <span class="text-purple-600">K:${data.tech.kVal}</span>
                </div>`;
        }

        async function fetchAllData() {
            document.getElementById('status-msg').innerHTML = '<span class="text-blue-600"><i class="fa-solid fa-spinner fa-spin"></i> èƒŒæ™¯æ›´æ–°...</span>';
            
            // v64: å˜—è©¦èƒŒæ™¯æ›´æ–°ï¼Œå¤±æ•—ä¹Ÿä¸å½±éŸ¿æ“ä½œ
            const p1 = [
                fetchYahooData("TWD=X").then(d => { if(d) document.getElementById('usd-rate').value = d.price.toFixed(2); }),
                fetchYahooData(SYMBOLS.AOA).then(d => updateRow('price-aoa', 'sig-aoa', d)),
                fetchYahooData(SYMBOLS.IMID).then(d => updateRow('price-imid', 'sig-imid', d)),
                fetchYahooData(SYMBOLS.TW).then(d => {
                    updateRow('price-tw', 'sig-tw', d);
                    if(d) document.getElementById('current-tw-price').innerText = d.price.toFixed(2);
                })
            ];
            
            // ä¸ç­‰å¾…å…¨éƒ¨å®Œæˆï¼Œæœ‰å›å‚³å°±æ›´æ–°ï¼Œæ²’å›å‚³å°±ç”¨é è¨­
            Promise.all(p1).then(() => {
                calculateAll(true);
                document.getElementById('status-msg').innerHTML = '<span class="text-green-600"><i class="fa-solid fa-check"></i> å°±ç·’</span>';
            });
        }

        function calculateAll(runSim = false) {
            const qA = getVal('qty-aoa'), pA = getVal('price-aoa');
            const qI = getVal('qty-imid'), pI = getVal('price-imid'), usd = getVal('usd-rate');
            const qT = getVal('qty-tw'), pT = getVal('price-tw');
            const vC = getVal('val-cash');

            const vA = qA * pA, vI = qI * pI * usd, vT = qT * pT;
            const total = vA + vI + vT + vC;
            document.getElementById('total-assets').innerText = (total/10000).toFixed(0) + " è¬";

            document.getElementById('val-aoa').innerText = vA.toLocaleString();
            document.getElementById('val-imid').innerText = vI.toLocaleString();
            document.getElementById('val-tw').innerText = vT.toLocaleString();

            if(countryChart) {
                const data = [vI*0.6, vA+vT, vI*0.2, vI*0.1, vI*0.1, vC];
                countryChart.data.datasets[0].data = data;
                countryChart.update();
            }

            calculateLoanStatus();
            
            // v64: ç¢ºä¿æ°¸é æœ‰åƒæ•¸å¯è·‘
            if(runSim) {
                portfolioStats = { totalVal: total > 0 ? total : 1000000, weightedReturn: 0.12, weightedVol: 0.18, loanVal: getVal('val-loan')*10000 };
                setTimeout(() => runMonteCarlo(true), 100);
            }
        }

        function calculateLoanStatus() {
            const qty = getVal('qty-pledge'), price = getVal('price-tw');
            const loan = getVal('val-loan') * 10000;
            const rate = getVal('loan-rate');

            if(qty > 0 && price > 0 && loan > 0) {
                const mkt = qty * price;
                const mRate = (mkt / loan) * 100;
                document.getElementById('m-rate').innerText = mRate.toFixed(1) + "%";
                document.getElementById('yearly-interest').innerText = ((loan * rate / 100) / 10000).toFixed(1) + " è¬";
                
                let html = "";
                [0.1, 0.2, 0.3, 0.4].forEach(d => {
                    const p = price * (1-d), r = ((qty*p)/loan)*100;
                    const need = r < 166 ? (loan*1.66 - qty*p) : 0;
                    const status = r < 130 ? "<span class='bg-red-100 text-red-600 font-bold px-1 rounded'>ğŸ”¥ æ–·é ­</span>" : "æ­£å¸¸";
                    html += `<tr><td class="py-2">-${d*100}%</td><td>${p.toFixed(1)}</td><td>${r.toFixed(1)}%</td><td>${status}</td><td class="font-bold text-red-500">${need > 0 ? (need/10000).toFixed(0)+'è¬' : '-'}</td></tr>`;
                });
                document.getElementById('stress-test-body').innerHTML = html;
            }
        }

        function initCharts() {
            const ctxC = document.getElementById('countryChart').getContext('2d');
            countryChart = new Chart(ctxC, {
                type: 'pie',
                data: {
                    labels: ['ç¾åœ‹','å°ç£','æ­æ´²','äºæ´²','å…¶ä»–','ç¾é‡‘'],
                    datasets: [{ data: [0,0,0,0,0,0], backgroundColor: ['#2563eb','#16a34a','#9333ea','#f59e0b','#06b6d4','#9ca3af'] }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        datalabels: {
                            color: '#fff',
                            font: { weight: 'bold', size: 11 },
                            formatter: (value, ctx) => {
                                const dataset = ctx.chart.data.datasets[0].data;
                                const sorted = [...dataset].sort((a,b) => b-a);
                                const threshold = sorted[2] || 0; 
                                if (value >= threshold && value > 0) {
                                    const sum = dataset.reduce((a,b) => a+b, 0);
                                    return ctx.chart.data.labels[ctx.dataIndex] + '\n' + (value*100/sum).toFixed(1) + '%';
                                }
                                return null;
                            }
                        }
                    }
                }
            });

            const ctxM = document.getElementById('mcChart').getContext('2d');
            mcChart = new Chart(ctxM, { type: 'line', data: { labels: [], datasets: [] }, options: { maintainAspectRatio: false } });
        }

        function runMonteCarlo(recalc) {
            let mu = 0.08, sigma = 0.15;
            const labels = Array.from({length: 46}, (_, i) => i);
            const startVal = portfolioStats.totalVal;
            
            // v64: ç°¡å–®çš„ç¢ºå®šæ€§æ¨¡æ“¬ï¼Œç¢ºä¿ä¸€å®šå‡ºåœ–
            const dataP50 = labels.map(y => startVal * Math.pow(1.08, y));
            const dataLow = labels.map(y => startVal * Math.pow(1.02, y));
            const dataHigh = labels.map(y => startVal * Math.pow(1.12, y));
            
            mcChart.data.labels = labels;
            mcChart.data.datasets = [
                { label: 'æ¨‚è§€ (High)', data: dataHigh, borderColor: 'rgba(239, 68, 68, 0.5)', borderDash: [5,5], fill: false, pointRadius:0 },
                { label: 'é æœŸ (Expected)', data: dataP50, borderColor: 'blue', fill: false, pointRadius:0 },
                { label: 'ä¿å®ˆ (Low)', data: dataLow, borderColor: 'rgba(22, 163, 74, 0.5)', borderDash: [5,5], fill: false, pointRadius:0 }
            ];
            mcChart.update();
        }

        const getVal = (id) => {
            const el = document.getElementById(id);
            return el ? parseFloat(el.value.replace(/,/g,'')) || 0 : 0;
        };

        window.onload = () => { 
            // v64: ç§’é–‹é‚è¼¯ - å…ˆåˆå§‹åŒ–åœ–è¡¨ï¼Œå†ç®—é è¨­å€¼ï¼Œæœ€å¾Œæ‰å»é€£ç¶²
            loadData();
            initCharts(); 
            calculateAll(true); // å…ˆç”¨é è¨­å€¼ç•«åœ–
            setTimeout(fetchAllData, 500); // å»¶é²é€£ç¶²ï¼Œé¿å…å¡é “
        };
        
        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                const d = JSON.parse(saved);
                if(d.qtyAoa) document.getElementById('qty-aoa').value = d.qtyAoa;
                if(d.qtyImid) document.getElementById('qty-imid').value = d.qtyImid;
                if(d.qtyTw) document.getElementById('qty-tw').value = d.qtyTw;
                if(d.valCash) document.getElementById('val-cash').value = d.valCash;
                if(d.qtyPledge) document.getElementById('qty-pledge').value = d.qtyPledge;
                if(d.valLoan) document.getElementById('val-loan').value = d.valLoan;
            }
        }
    </script>
</body>
</html>
