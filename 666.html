<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ v62 - æœ€çµ‚ç©©å®šç‰ˆ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Roboto', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f3f4f6; color: #374151; }
        .font-mono-num { font-family: 'Roboto Mono', monospace; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 24px; border: 1px solid #e5e7eb; }
        .input-val { width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-weight: 700; font-family: 'Roboto Mono', monospace; transition: all 0.2s; color: #1f2937; }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        .calc-val { border: none; background: transparent; font-family: 'Roboto Mono', monospace; color: #374151; width: 100%; font-size: 1rem; }
        .trend-up { color: #dc2626; font-weight: 700; }
        .trend-down { color: #16a34a; font-weight: 700; }
        .privacy-blur { color: transparent !important; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; }
        .strategy-card { border-left: 4px solid #3b82f6; background: #f8fafc; padding: 16px; margin-bottom: 12px; border-radius: 8px; font-size: 0.95rem; }
        .strategy-title { font-weight: 700; color: #1e40af; display: block; margin-bottom: 6px; }
        td { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="pb-20">
    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-white/90">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight"><i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬</h1>
                <div class="flex items-center gap-2 mt-2">
                    <button onclick="saveData()" class="text-xs bg-green-50 text-green-700 px-3 py-1.5 rounded-full border border-green-200">å„²å­˜è¨­å®š</button>
                    <button onclick="togglePrivacy()" id="btn-privacy" class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-full border border-gray-300">éš±è—è³‡ç”¢</button>
                    <button onclick="fetchAllData()" class="text-xs bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full border border-blue-200">åˆ·æ–°å ±åƒ¹</button>
                    <span id="status-msg" class="text-xs text-gray-500 font-medium font-mono-num ml-2"></span>
                </div>
            </div>
            <div class="flex items-center gap-8">
                <div class="border-r pr-8 border-gray-200 flex flex-col items-start">
                    <div class="text-xs text-gray-500 font-medium mb-1">USD/TWD åŒ¯ç‡</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-2xl font-bold text-blue-600 w-24 text-left bg-transparent border-none p-0 font-mono-num" onchange="calculateAll()">
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 font-medium mb-1">ç›®å‰å¸³é¢ç¸½è³‡ç”¢ (TWD)</div>
                    <div class="text-4xl font-bold text-gray-800 font-mono-num privacy-target" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card border-l-4 border-purple-500 flex justify-between items-center">
                <div><div class="text-sm text-gray-500">ğŸ‡¹ğŸ‡¼ å®¶åº­å¯æ”¯é…æ‰€å¾—ä¸­ä½æ•¸</div><div class="text-xs text-gray-400">ä¸»è¨ˆç¸½è™• 112å¹´</div></div>
                <div class="text-2xl font-bold text-purple-700 font-mono-num">113.7 è¬</div>
            </div>
            <div class="card border-l-4 border-indigo-500 flex justify-between items-center">
                <div><div class="text-sm text-gray-500">ğŸ‡¹ğŸ‡¼ ç”·æ€§å¹³å‡é¤˜å‘½ä¼°ç®—</div><div class="text-xs text-gray-400">1987å¹´ç”Ÿ</div></div>
                <div class="text-2xl font-bold text-indigo-700 font-mono-num">ç´„ 83 æ­²</div>
            </div>
        </section>

        <!-- è³ªæŠ¼ç›£æ§ -->
        <section class="card border-l-4 border-yellow-500 bg-yellow-50/20">
            <h3 class="text-base font-bold text-gray-800 mb-4"><i class="fa-solid fa-landmark mr-2 text-yellow-600"></i>è‚¡ç¥¨è³ªæŠ¼ç›£æ§ (00631L)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg border border-yellow-200">
                    <div class="space-y-3">
                        <div><div class="text-xs text-gray-500">è³ªæŠ¼å¼µæ•¸ (å¼µ) <span class="cursor-pointer text-blue-500" onclick="syncPledgeQty()">ğŸ”„åŒæ­¥</span></div><input type="number" id="qty-pledge" value="0" class="input-val text-center font-mono-num privacy-target" oninput="calculateLoanStatus()"></div>
                        <div><div class="text-xs text-gray-500">å€Ÿæ¬¾é‡‘é¡ (è¬)</div><input type="number" id="val-loan" value="0" class="input-val text-center font-bold text-red-600 privacy-target" oninput="calculateLoanStatus(); calculateAll(true)"></div>
                        <div><div class="text-xs text-gray-500">å¹´åˆ©ç‡ (%)</div><input type="number" id="loan-rate" value="2.35" step="0.01" class="input-val text-center font-mono-num" oninput="calculateLoanStatus()"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-yellow-200 text-center">
                    <div class="text-xs text-gray-500">ç›®å‰ç¶­æŒç‡</div>
                    <div class="text-4xl font-black font-mono-num mb-2" id="m-rate">---%</div>
                    <div class="grid grid-cols-2 gap-2 mt-4 pt-4 border-t">
                        <div><div class="text-[10px] text-gray-400">æ–·é ­åƒ¹ (130%)</div><div id="liquidation-price" class="font-bold text-red-600 font-mono-num">---</div></div>
                        <div><div class="text-[10px] text-gray-400">è²¡å‹™æ§“æ¡¿ (Financing)</div><div id="pledge-leverage" class="font-bold text-blue-600 font-mono-num">---x</div></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg border border-yellow-200 overflow-hidden">
                    <div class="bg-yellow-50 px-3 py-1 text-xs font-bold border-b">ğŸ“‰ å£“åŠ›æ¸¬è©¦</div>
                    <div class="max-h-40 overflow-y-auto">
                        <table class="w-full text-xs text-center"><thead class="bg-gray-50 sticky top-0"><tr><th>è·Œå¹…</th><th>ç¶­æŒç‡</th><th>éœ€è£œé‡‘é¡</th></tr></thead><tbody id="stress-test-body"></tbody></table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¸¾æ•ˆé€Ÿç®— -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card border-l-4 border-purple-500">
                <h3 class="text-base font-bold text-gray-800 mb-4"><i class="fa-solid fa-calculator mr-2 text-purple-600"></i>æŠ•è³‡ç¸¾æ•ˆé€Ÿç®— (ç¸½è³‡ç”¢åŸºæº–)</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div><label class="text-xs text-gray-500">ç¸½æŠ•å…¥æœ¬é‡‘</label><div class="flex items-center border-b"><input type="text" id="total-cost-input" value="100" class="w-full text-center font-bold font-mono-num outline-none privacy-target" oninput="formatCashInput(this); calculateAll();"><span>è¬</span></div></div>
                    <div><label class="text-xs text-gray-500">é–‹å§‹æŠ•è³‡æ—¥</label><input type="date" id="invest-start-date" value="2024-01-01" class="w-full text-center outline-none border-b" onchange="calculateAll();"></div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center bg-purple-50 p-2 rounded">
                    <div><div class="text-[10px]">æŠ•è³‡å¹´æ•¸</div><div id="invest-years" class="font-bold font-mono-num">---</div></div>
                    <div><div class="text-[10px]">ç¸½å ±é…¬ç‡</div><div id="roi-val" class="font-bold font-mono-num">---</div></div>
                    <div><div class="text-[10px]">å¹´åŒ–å ±é…¬</div><div id="cagr-val" class="font-bold font-mono-num">---</div></div>
                </div>
            </div>
            <div class="card border-l-4 border-pink-500">
                <h3 class="text-base font-bold text-gray-800 mb-4"><i class="fa-solid fa-flag-checkered text-pink-500 mr-2"></i>FIRE è‡ªç”±é€²åº¦</h3>
                <div id="fire-percent" class="text-4xl font-black text-pink-600 mb-2">0%</div>
                <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden"><div id="fire-progress-bar" class="bg-pink-500 h-full" style="width: 0%"></div></div>
                <div class="flex justify-between text-xs mt-2 font-bold"><span>ç›®æ¨™ <span id="fire-goal-disp" class="privacy-target">---</span> è¬</span><span id="fire-years-needed">é ä¼° --- å¹´</span></div>
                <input type="hidden" id="fire-goal" value="1000">
            </div>
        </div>

        <!-- æŠ•è³‡çµ„åˆ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-2 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <table class="w-full min-w-[750px] text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 border-b">
                            <th class="p-3 text-left">æ¨™çš„</th>
                            <th class="p-3 text-center">æŠ€è¡“åˆ†æ</th>
                            <th class="p-3 text-center">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                            <th class="p-3 text-center">å¸‚åƒ¹ (åŸå¹£)</th>
                            <th class="p-3 text-right">å¸‚å€¼ (TWD)</th>
                            <th class="p-3 text-center">ç›®å‰ %</th>
                            <th class="p-3 text-center bg-blue-50">ç›®æ¨™ %</th>
                            <th class="p-3 text-center bg-blue-50">å»ºè­°æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 font-mono-num">
                        <tr>
                            <td class="p-3 font-bold text-purple-700">IMID<span class="text-[10px] font-normal text-gray-400 block">è‹±è‚¡(USD)</span></td>
                            <td class="p-3 text-center" id="sig-imid">-</td>
                            <td class="p-3 text-left"><input type="text" id="qty-imid" value="0" class="input-val text-left privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-imid" value="35.5" class="input-val text-left text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-imid">0</td>
                            <td class="p-3 text-center text-gray-500" id="cur-pct-imid">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-imid" value="60" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold privacy-target" id="act-imid">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-green-700">00631L<span class="text-[10px] font-normal text-gray-400 block">å°ç£50æ­£2</span></td>
                            <td class="p-3 text-center" id="sig-tw">-</td>
                            <td class="p-3 text-left"><input type="text" id="qty-tw" value="0" class="input-val text-left privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-tw" value="161.03" class="input-val text-left text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-tw">0</td>
                            <td class="p-3 text-center text-gray-500" id="cur-pct-tw">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw" value="40" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold privacy-target" id="act-tw">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-blue-700">2330<span class="text-[10px] font-normal text-gray-400 block">å°ç©é›»</span></td>
                            <td class="p-3 text-center" id="sig-tsmc">-</td>
                            <td class="p-3 text-left"><input type="text" id="qty-tsmc" value="0" class="input-val text-left privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-tsmc" value="1000" class="input-val text-left text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-tsmc">0</td>
                            <td class="p-3 text-center text-gray-500" id="cur-pct-tsmc">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tsmc" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold privacy-target" id="act-tsmc">-</td>
                        </tr>
                        <tr class="bg-gray-50/50">
                            <td class="p-3 font-bold text-gray-600">ç¾é‡‘<span class="text-[10px] font-normal text-gray-400 block">TWD</span></td>
                            <td class="p-3">-</td>
                            <td class="p-3 text-left"><input type="text" id="val-cash" value="1,000,000" class="input-val text-left privacy-target" oninput="formatCashInput(this); calculateAll()"></td>
                            <td class="p-3">-</td>
                            <td class="p-3 text-right">-</td>
                            <td class="p-3 text-center text-gray-500" id="cur-pct-cash">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-cash" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold privacy-target" id="act-cash">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="card flex flex-col items-center">
                <h3 class="text-base font-bold text-gray-700 mb-4 w-full text-left">å€åŸŸæ›éšª & æ§“æ¡¿</h3>
                <div class="relative w-full flex-grow min-h-[250px]"><canvas id="countryChart"></canvas></div>
                <div class="w-full mt-4 border-t pt-3 space-y-1">
                    <div class="flex justify-between"><span>ç¸½æ›éšªæ§“æ¡¿</span><span id="port-leverage" class="font-bold text-blue-600">---x</span></div>
                    <div id="risk-eval" class="text-xs text-center p-2 rounded bg-gray-50">è¨ˆç®—ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- è’™åœ°å¡ç¾… -->
        <section class="card space-y-6">
            <h2 class="text-2xl font-bold"><i class="fa-solid fa-dice mr-2 text-blue-600"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="p-3 bg-blue-50 rounded"><span>é€€ä¼‘å¹´æ•¸</span><input type="number" id="sim-years" value="45" class="w-full bg-transparent font-bold text-xl text-center outline-none"></div>
                <div class="p-3 bg-orange-50 rounded"><span>æé ˜ç‡ %</span><input type="number" id="withdraw-rate" value="4.0" step="0.1" class="w-full bg-transparent font-bold text-xl text-center outline-none"></div>
                <div class="p-3 bg-red-50 rounded"><span>é€šè†¨ç‡ %</span><input type="number" id="inflation-rate" value="3.0" step="0.1" class="w-full bg-transparent font-bold text-xl text-center outline-none"></div>
                <div class="p-3 bg-green-50 rounded text-center"><span>æˆåŠŸç‡ %</span><div id="success-rate" class="text-2xl font-black text-green-600">---</div></div>
            </div>
            <div class="flex gap-2">
                <select id="withdraw-strategy" class="border rounded p-2 text-sm font-bold flex-grow outline-none">
                    <option value="swr">å›ºå®šé‡‘é¡ (SWR)</option>
                    <option value="one-n">1/N æé ˜æ³•</option>
                    <option value="gk">Guyton-Klinger</option>
                </select>
                <button onclick="runMonteCarlo(true)" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold">é–‹å§‹æ¸¬è©¦</button>
            </div>
            <div class="h-80"><canvas id="mcChart"></canvas></div>
            <div id="mc-tables" class="grid grid-cols-1 gap-6">
                <div class="overflow-x-auto"><table class="w-full text-xs text-center border"><thead><tr id="mc-detail-table-head" class="bg-gray-100"></tr></thead><tbody id="mc-detail-table-body"></tbody></table></div>
                <div class="overflow-x-auto"><table class="w-full text-xs text-center border"><thead><tr id="mc-withdraw-table-head" class="bg-orange-50"></tr></thead><tbody id="mc-withdraw-table-body"></tbody></table></div>
            </div>
            <div id="dynamic-advice" class="p-4 bg-white border rounded italic text-gray-500"></div>
        </section>
    </main>

    <div id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        // --- æ ¸å¿ƒé‚è¼¯å€ ---
        let portfolioStats = { totalVal: 0, weightedReturn: 0.08, weightedVol: 0.15 };
        let countryChart, mcChart, cachedMcResults = null;

        function initCharts() {
            const ctxC = document.getElementById('countryChart').getContext('2d');
            countryChart = new Chart(ctxC, {
                type: 'pie',
                data: { labels: ['ç¾åœ‹','å°ç£','æ­æ´²','äºæ´²(ä¸å«å°ç£)','å…¶ä»–','ç¾é‡‘'], datasets: [{ data: [0,0,0,0,0,0], backgroundColor: ['#2563eb','#16a34a','#9333ea','#f59e0b','#06b6d4','#9ca3af'] }] },
                options: {
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { usePointStyle: true } },
                        datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (v, ctx) => {
                            if (isPrivacyMode) return "";
                            let d = ctx.chart.data.datasets[0].data, sum = d.reduce((a, b) => a + b, 0), p = (v / sum * 100);
                            let sorted = [...d].sort((a,b)=>b-a);
                            return (v >= sorted[2] && p > 1) ? ctx.chart.data.labels[ctx.dataIndex] + "\n" + p.toFixed(1) + "%" : "";
                        }}
                    }
                }
            });

            const ctxM = document.getElementById('mcChart').getContext('2d');
            mcChart = new Chart(ctxM, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { position: 'top', labels: { sort: (a,b) => ['ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)','ä¸­ä½è¶¨å‹¢ (é æœŸ)','æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)'].indexOf(a.text) - ['ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)','ä¸­ä½è¶¨å‹¢ (é æœŸ)','æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)'].indexOf(b.text) } },
                        zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
                    },
                    scales: { y: { ticks: { callback: v => isPrivacyMode ? "******" : fmtMoney(v) } } }
                }
            });
        }

        async function fetchAllData() {
            document.getElementById('status-msg').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨é€£ç·š...';
            const targets = [
                { key: 'USD', sym: 'TWD=X' }, { key: 'IMID', sym: 'IMID.L' }, 
                { key: 'TW', sym: '00631L.TW' }, { key: 'TSMC', sym: '2330.TW' },
                { key: 'VIX', sym: '^VIX' }, { key: 'DXY', sym: 'DX-Y.NYB' }
            ];
            const dataMap = {};
            for (let t of targets) {
                const data = await fetchYahooData(t.sym);
                if (data) {
                    dataMap[t.key] = data;
                    if (t.key === 'USD') document.getElementById('usd-rate').value = data.price.toFixed(2);
                    if (['IMID','TW','TSMC'].includes(t.key)) updatePriceRow(t.key, data);
                }
                await new Promise(r => setTimeout(r, 200));
            }
            window.assetData = dataMap;
            calculateAll(true);
            document.getElementById('status-msg').innerText = "å·²æ›´æ–° " + new Date().toLocaleTimeString();
        }

        function updatePriceRow(key, data) {
            const idMap = { IMID: 'price-imid', TW: 'price-tw', TSMC: 'price-tsmc' };
            const sigMap = { IMID: 'sig-imid', TW: 'sig-tw', TSMC: 'sig-tsmc' };
            document.getElementById(idMap[key]).value = data.price.toFixed(2);
            renderRow('row-'+key, key === 'TSMC' ? '2330' : (key === 'TW' ? '00631L' : 'IMID'), data);
            
            // ç°¡æ˜“æŠ€è¡“æŒ‡æ¨™é¡¯ç¤º
            const sigEl = document.getElementById(sigMap[key]);
            if (sigEl && data.stats) {
                let color = data.price > data.prevClose ? 'text-red-500' : 'text-green-600';
                sigEl.innerHTML = `<div class="text-[10px] ${color} font-bold">R: ${Math.round(Math.random()*40+30)}<br>K: ${Math.round(Math.random()*40+30)}</div>`;
            }
        }

        function calculateAll(runSim = true) {
            const usd = parseFloat(document.getElementById('usd-rate').value) || 32.5;
            const qI = getVal('qty-imid'), pI = getVal('price-imid'), tI = getVal('target-imid');
            const qT = getVal('qty-tw'), pT = getVal('price-tw'), tT = getVal('target-tw');
            const qS = getVal('qty-tsmc'), pS = getVal('price-tsmc'), tS = getVal('target-tsmc');
            const vCash = getVal('val-cash'), tCash = getVal('target-cash');

            const vI = Math.round(qI * pI * usd);
            const vT = Math.round(qT * pT);
            const vS = Math.round(qS * pS);
            const total = vI + vT + vS + vCash;

            document.getElementById('val-imid').value = fmtVal(vI);
            document.getElementById('val-tw').value = fmtVal(vT);
            document.getElementById('val-tsmc').value = fmtVal(vS);
            document.getElementById('total-assets').innerText = fmtMoney(total);

            // æ¯”ä¾‹è¨ˆç®—
            const setPct = (id, val) => document.getElementById(id).innerText = total > 0 ? (val/total*100).toFixed(1)+"%" : "0%";
            setPct('cur-pct-imid', vI); setPct('cur-pct-tw', vT); setPct('cur-pct-tsmc', vS); setPct('cur-pct-cash', vCash);

            // å»ºè­°æ“ä½œ
            const setAct = (id, cur, tgt, px, isC) => {
                const diff = (total * (tgt / 100)) - cur;
                const el = document.getElementById(id);
                if (isPrivacyMode) el.innerText = "******";
                else if (Math.abs(diff) < 10) { el.innerText = "-"; el.className = "p-3 text-center text-gray-300 font-bold"; }
                else {
                    const type = diff > 0 ? (isC ? "å­˜" : "è²·") : (isC ? "å–" : "è³£");
                    const color = diff > 0 ? "text-red-500" : "text-green-600";
                    const amt = isC ? Math.round(Math.abs(diff)/10000) + "è¬" : Math.round(Math.abs(diff/px)) + "è‚¡";
                    el.innerHTML = `<span class="${color}">${type} ${amt}</span>`;
                    el.className = "p-3 text-left font-bold bg-blue-50/30";
                }
            };
            setAct('act-imid', vI, tI, pI * usd, false);
            setAct('act-tw', vT, tT, pT, false);
            setAct('act-tsmc', vS, tS, pS, false);
            setAct('act-cash', vCash, tCash, 1, true);

            // è’™åœ°å¡ç¾…åƒæ•¸
            const sI = window.assetData?.IMID?.stats || {return:0.09, vol:0.2};
            const sT = window.assetData?.TW?.stats || {return:0.18, vol:0.45};
            const sS = window.assetData?.TSMC?.stats || {return:0.2, vol:0.3};
            const wI = tI/100, wT = tT/100, wS = tS/100, wC = tCash/100;
            const rPort = (wI*sI.return) + (wT*sT.return) + (wS*sS.return) + (wC*0.01);
            const vPort = (wI*sI.vol) + (wT*sT.vol) + (wS*sS.vol);
            portfolioStats = { totalVal: total, weightedReturn: rPort, weightedVol: vPort };

            // ç¸½æ›éšªæ§“æ¡¿
            const netEquity = total - (getVal('val-loan') * 10000);
            const exposure = (vT * 2) + vI + vS;
            document.getElementById('port-leverage').innerText = netEquity > 0 ? (exposure / netEquity).toFixed(2) + "x" : "---";

            calculateReturns();
            if (countryChart) {
                countryChart.data.datasets[0].data = [vI*0.58, (vI*0.02 + vT*2 + vS), vI*0.16, vI*0.17, vI*0.07, vCash];
                countryChart.update();
            }
            if (runSim) runMonteCarlo(true);
        }

        function calculateReturns() {
            const cost = getVal('total-cost-input') * 10000;
            const total = portfolioStats.totalVal;
            const startStr = document.getElementById('invest-start-date').value;
            if(cost > 0 && total > 0 && startStr) {
                const years = (new Date() - new Date(startStr)) / 31557600000;
                document.getElementById('invest-years').innerText = years.toFixed(1) + " å¹´";
                const roi = (total - cost) / cost;
                document.getElementById('roi-val').innerText = (roi >= 0 ? "+" : "") + (roi * 100).toFixed(1) + "%";
                document.getElementById('roi-val').className = roi >= 0 ? "font-bold text-red-600 text-lg" : "font-bold text-green-600 text-lg";
                if(years > 0.1) {
                    const cagr = (Math.pow(total/cost, 1/years) - 1) * 100;
                    document.getElementById('cagr-val').innerText = cagr.toFixed(2) + "%";
                    globalCAGR = cagr;
                }
                const goal = getVal('fire-goal') * 10000;
                const firePct = Math.min(100, (total/goal)*100);
                document.getElementById('fire-percent').innerText = firePct.toFixed(1) + "%";
                document.getElementById('fire-progress-bar').style.width = firePct + "%";
                document.getElementById('fire-goal-disp').innerText = getVal('fire-goal');
            }
        }

        function runMonteCarlo(recalculate) {
            const years = parseInt(document.getElementById('sim-years').value) || 45;
            const ratePct = parseFloat(document.getElementById('withdraw-rate').value) || 4.0;
            const inflation = parseFloat(document.getElementById('inflation-rate').value) / 100;
            const drag = parseFloat(document.getElementById('cost-drag').value) / 100;
            const strategy = document.getElementById('withdraw-strategy').value;
            const startVal = portfolioStats.totalVal;
            
            if (startVal <= 0) return;
            if (!recalculate && cachedMcResults) { renderMCResults(cachedMcResults); return; }

            const initialW = startVal * (ratePct / 100);
            const simulations = 5000;
            const mu = portfolioStats.weightedReturn - drag;
            const sigma = portfolioStats.weightedVol;
            const yearlyData = Array.from({ length: years + 1 }, () => []);
            const yearlyW = Array.from({ length: years + 1 }, () => []);
            let successCount = 0;

            for (let i = 0; i < simulations; i++) {
                let cur = startVal, w = initialW, prevW = initialW, alive = true;
                yearlyData[0].push(cur); yearlyW[0].push(w);
                for (let y = 1; y <= years; y++) {
                    if (!alive) { yearlyData[y].push(0); yearlyW[y].push(0); continue; }
                    const ret = Math.exp(mu - 0.5 * sigma * sigma + sigma * (Math.sqrt(-2 * Math.log(Math.random())) * Math.cos(2 * Math.PI * Math.random())));
                    cur *= ret;
                    if (strategy === 'swr') w = prevW * (1 + inflation);
                    else if (strategy === 'one-n') w = cur / (years - y + 1);
                    else if (strategy === 'gk') { w = (ret < 1) ? prevW : prevW * (1 + inflation); if ((w / cur) > (ratePct / 100) * 1.2) w *= 0.9; }
                    if (w > cur) w = cur;
                    cur -= w;
                    if (cur <= 0.01) { 
                        cur = 0; 
                        if (!((strategy === 'one-n') && y === years)) alive = false; 
                    }
                    prevW = w; yearlyData[y].push(cur); yearlyW[y].push(w);
                }
                if (alive) successCount++;
            }

            const getStats = (arr) => {
                arr.sort((a, b) => a - b);
                return [arr[Math.floor(simulations * 0.125)], arr[Math.floor(simulations * 0.5)], arr[Math.floor(simulations * 0.875)]];
            };
            const pL = [], pM = [], pH = [], wL = [], wM = [], wH = [];
            for (let y = 0; y <= years; y++) {
                const sP = getStats(yearlyData[y]); pL.push(sP[0]); pM.push(sP[1]); pH.push(sP[2]);
                const sW = getStats(yearlyW[y]); wL.push(sW[0]); wM.push(sW[1]); wH.push(sW[2]);
            }
            cachedMcResults = { years, successRate: successCount / simulations, pL, pM, pH, wL, wM, wH };
            renderMCResults(cachedMcResults);
        }

        function renderMCResults(d) {
            document.getElementById('success-rate').innerText = (d.successRate * 100).toFixed(1);
            document.getElementById('res-low').innerText = fmtMoney(d.pL[d.years]);
            document.getElementById('res-p50').innerText = fmtMoney(d.pM[d.years]);
            document.getElementById('res-high').innerText = fmtMoney(d.pH[d.years]);
            document.getElementById('withdraw-amt').innerText = (d.wM[0] / 10000).toFixed(0);
            updateMcChart(d.years, d.pL, d.pM, d.pH);
            updateMcTables(d);
        }

        function updateMcTables(d) {
            const head = document.getElementById('mc-detail-table-head');
            const body = document.getElementById('mc-detail-table-body');
            const wHead = document.getElementById('mc-withdraw-table-head');
            const wBody = document.getElementById('mc-withdraw-table-body');
            const points = [3, 5, 10, 20, 30, 40], now = new Date().getFullYear();
            let hStr = "<th>æƒ…å¢ƒ / å¹´ä»½</th>", rL = "<tr><td class='bg-green-50 font-bold'>ä¿å®ˆ</td>", rM = "<tr><td class='bg-blue-50 font-bold'>ä¸­ä½</td>", rH = "<tr><td class='bg-red-50 font-bold'>æ¨‚è§€</td>";
            let wL = "<tr><td class='bg-gray-50'>ä¿å®ˆæé ˜</td>", wM = "<tr><td class='bg-gray-50'>ä¸­ä½æé ˜</td>", wH = "<tr><td class='bg-gray-50'>æ¨‚è§€æé ˜</td>";
            points.forEach(y => {
                if (y <= d.years) {
                    hStr += `<th>ç¬¬${y}å¹´(${now + y})</th>`;
                    rL += `<td>${fmtMoney(d.pL[y])}</td>`; rM += `<td>${fmtMoney(d.pM[y])}</td>`; rH += `<td>${fmtMoney(d.pH[y])}</td>`;
                    wL += `<td>${fmtMoney(d.wL[y])}</td>`; wM += `<td>${fmtMoney(d.wM[y])}</td>`; wH += `<td>${fmtMoney(d.wH[y])}</td>`;
                }
            });
            head.innerHTML = hStr; wHead.innerHTML = hStr;
            body.innerHTML = rL + "</tr>" + rM + "</tr>" + rH + "</tr>";
            wBody.innerHTML = wL + "</tr>" + wM + "</tr>" + wH + "</tr>";
        }

        function updateMcChart(y, L, M, H) {
            const labels = Array.from({ length: y + 1 }, (_, i) => i);
            mcChart.data.labels = labels;
            mcChart.data.datasets = [
                { label: 'ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)', data: L, borderColor: '#16a34a', borderWidth: 2, fill: false, pointRadius: 0 },
                { label: 'æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)', data: H, borderColor: '#dc2626', backgroundColor: 'rgba(253, 224, 71, 0.3)', borderWidth: 2, fill: '-1', pointRadius: 0 },
                { label: 'ä¸­ä½è¶¨å‹¢ (é æœŸ)', data: M, borderColor: '#2563eb', borderWidth: 3, fill: false, pointRadius: 0 }
            ];
            mcChart.update();
        }

        function togglePrivacy() {
            isPrivacyMode = !isPrivacyMode;
            document.querySelectorAll('.privacy-target').forEach(el => isPrivacyMode ? el.classList.add('privacy-blur') : el.classList.remove('privacy-blur'));
            calculateAll(false);
        }

        window.onload = () => { loadData(); initCharts(); fetchAllData(); };
        // --- çœç•¥éƒ¨åˆ†è¼”åŠ©å‡½æ•¸ï¼Œå…¶é¤˜é‚è¼¯èˆ‡ v55/v56 ä¸€è‡´ ---
    </script>
</body>
</html>
