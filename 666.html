<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ (v22.1 æ¥µé€Ÿç‰ˆ)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“ˆ</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Roboto', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f3f4f6; color: #374151; }
        .font-mono-num { font-family: 'Roboto Mono', monospace; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 16px; border: 1px solid #e5e7eb; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .card { padding: 24px; } }
        .input-val { width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; text-align: right; font-weight: 700; font-family: 'Roboto Mono', monospace; transition: all 0.2s; color: #1f2937; }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        .calc-val { border: none; background: transparent; text-align: right; font-family: 'Roboto Mono', monospace; color: #374151; width: 100%; font-size: inherit; }
        .trend-up { color: #dc2626; font-weight: 700; }
        .trend-down { color: #16a34a; font-weight: 700; }
        .privacy-blur { color: transparent !important; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 99; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .macro-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        @media (max-width: 1024px) { .macro-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 640px) { .macro-grid { grid-template-columns: repeat(2, 1fr); } }
        .signal-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-bottom: 2px; white-space: nowrap; }
        .sig-buy-strong { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; } 
        .sig-buy { background-color: #d1fae5; color: #047857; border: 1px solid #a7f3d0; } 
        .sig-neutral { background-color: #f3f4f6; color: #9ca3af; }
    </style>
</head>
<body class="pb-20 overflow-x-hidden">

    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-white/90">
        <div class="w-full max-w-7xl mx-auto px-4 py-4 flex flex-col lg:flex-row justify-between items-center gap-4 box-border">
            <div class="w-full lg:w-auto text-center lg:text-left flex flex-col lg:items-start items-center">
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center justify-center lg:justify-start">
                    <i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬
                </h1>
                <div class="flex items-center justify-center lg:justify-start gap-2 mt-3 flex-wrap">
                    <button onclick="saveData()" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-4 py-2 rounded-full transition font-medium border border-green-200">
                        <i class="fa-solid fa-floppy-disk mr-1"></i>å„²å­˜è¨­å®š
                    </button>
                    <button onclick="togglePrivacy()" id="btn-privacy" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full transition font-medium border border-gray-300">
                        <i class="fa-solid fa-eye-slash mr-1"></i>éš±è—è³‡ç”¢
                    </button>
                    <button onclick="fetchAllData()" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-full transition font-medium border border-blue-200">
                        <i class="fa-solid fa-sync-alt mr-1"></i>åˆ·æ–°å ±åƒ¹
                    </button>
                    <span id="status-msg" class="text-xs text-gray-500 font-medium font-mono-num ml-2"></span>
                </div>
            </div>
            <div class="flex items-center justify-center lg:justify-end gap-6 w-full lg:w-auto border-t lg:border-t-0 pt-3 lg:pt-0 border-gray-100">
                <div class="flex flex-col items-center lg:items-end border-r pr-6 border-gray-200">
                    <div class="text-xs text-gray-500 font-medium mb-1">USD/TWD</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-xl font-bold text-blue-600 w-20 text-center lg:text-right bg-transparent border-none focus:ring-0 p-0 m-0 font-mono-num" onchange="calculateAll()">
                </div>
                <div class="text-center lg:text-right">
                    <div class="text-xs text-gray-500 font-medium mb-1">ç›®å‰å¸³é¢ç¸½è³‡ç”¢ (TWD)</div>
                    <div class="text-3xl font-bold text-gray-800 tracking-tight font-mono-num privacy-target" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

        <section class="card border-l-4 border-slate-600">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center justify-between">
                <span><i class="fa-solid fa-globe mr-2 text-slate-600"></i>å…¨çƒå®è§€æ™¯æ°£å„€è¡¨æ¿ (Global Macro)</span>
                <span id="macro-summary" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500">è¼‰å…¥ä¸­...</span>
            </h3>
            <div class="macro-grid" id="macro-container">
                <div class="text-center p-3 bg-gray-50 rounded text-gray-400 text-xs">æ•¸æ“šæº–å‚™ä¸­...</div>
            </div>
            <div class="text-[10px] text-gray-400 mt-2 text-right">
                * æ•¸æ“šä¾†æº: Yahoo Finance (å»¶é² 15 åˆ†é˜) | Risk On/Off åˆ¤æ–·
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
            <div class="card border-l-4 border-purple-500 h-full flex flex-col justify-between">
                <div>
                    <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-calculator mr-2 text-purple-600"></i>æŠ•è³‡ç¸¾æ•ˆé€Ÿç®—
                    </h3>
                    <div class="grid grid-cols-2 gap-6 mb-4">
                        <div class="flex flex-col items-center">
                            <label class="text-xs text-gray-500 mb-1 text-center">ç¸½æŠ•å…¥æœ¬é‡‘</label>
                            <div class="flex items-center w-full border-b border-gray-300 focus-within:border-purple-500">
                                <input type="text" id="total-cost-input" value="100" class="w-full outline-none text-center font-mono-num font-bold text-gray-700 text-lg privacy-target" oninput="formatCashInput(this); calculateReturns(); calculateFireRunway();">
                                <span class="text-gray-500 text-sm font-medium whitespace-nowrap ml-1">è¬</span>
                            </div>
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="text-xs text-gray-500 mb-1 text-center">é–‹å§‹æŠ•è³‡æ—¥æœŸ</label>
                            <div class="w-full border-b border-gray-300 focus-within:border-purple-500">
                                <input type="date" id="invest-start-date" value="2024-01-01" style="text-align: center;" class="w-full outline-none font-mono-num text-sm text-gray-700 h-[28px]" onchange="calculateReturns(); calculateFireRunway();">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col gap-2 mt-auto">
                    <div class="grid grid-cols-3 gap-2 bg-purple-50 p-3 rounded-lg text-center">
                        <div>
                            <div class="text-[10px] text-gray-500">æŠ•è³‡å¹´æ•¸</div>
                            <div class="font-bold text-gray-800 font-mono-num text-lg" id="invest-years">---</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500">ç¸½å ±é…¬ç‡ (ROI)</div>
                            <div class="font-bold text-purple-700 font-mono-num text-lg" id="roi-val">---</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500">å¹´åŒ–å ±é…¬ (CAGR)</div>
                            <div class="font-bold text-purple-700 font-mono-num text-lg" id="cagr-val">---</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 bg-gray-50 p-3 rounded-lg text-center">
                        <div>
                            <div class="text-[10px] text-gray-500">ç¸½ç²åˆ©é‡‘é¡</div>
                            <div class="font-bold text-gray-800 font-mono-num text-sm privacy-target" id="total-profit">---</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500">å¹³å‡æœˆç²åˆ©</div>
                            <div class="font-bold text-green-600 font-mono-num text-sm privacy-target" id="monthly-profit">---</div>
                        </div>
                        <div>
                            <div class="text-[10px] text-gray-500">è³‡ç”¢å€æ•¸ (å›æœ¬)</div>
                            <div class="font-bold text-blue-600 font-mono-num text-sm" id="asset-multiple">---</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-l-4 border-pink-500 h-full flex flex-col justify-between">
                <div>
                    <div class="mb-4">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-base font-bold text-gray-800"><i class="fa-solid fa-flag-checkered text-pink-500 mr-2"></i>FIRE è‡ªç”±é€²åº¦</h3>
                            <div class="flex items-center gap-1 border-b border-gray-300 focus-within:border-pink-500">
                                <span class="text-xs text-gray-500">ç›®æ¨™:</span>
                                <input type="text" id="fire-goal" value="1000" class="w-20 text-center outline-none font-mono-num font-bold text-pink-600 privacy-target text-lg" oninput="formatCashInput(this); calculateFireRunway()">
                                <span class="text-xs text-gray-500">è¬</span>
                            </div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3 mb-2 overflow-hidden">
                            <div id="fire-progress-bar" class="bg-gradient-to-r from-pink-400 to-pink-600 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs font-mono-num mb-2">
                            <span id="fire-percent" class="font-bold text-pink-700 text-sm">0%</span>
                            <span id="fire-diff" class="text-gray-400 privacy-target">é‚„å·® --- è¬</span>
                        </div>
                        
                        <div class="bg-pink-50 rounded p-2 text-center border border-pink-100">
                            <div class="text-[10px] text-gray-500">æŒ‰ç›®å‰ç¸¾æ•ˆé ä¼° (CAGR <span id="fire-cagr-display">---</span>)</div>
                            <div id="fire-years-needed" class="font-bold text-pink-700 font-mono-num text-lg">--- å¹´</div>
                        </div>
                    </div>
                    
                    <hr class="border-gray-100 mb-4">
                    
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-sm font-bold text-gray-700"><i class="fa-solid fa-shield-cat text-gray-500 mr-2"></i>è£¸è¾­å­˜æ´» (Runway)</h3>
                        <div class="flex items-center gap-1 border-b border-gray-300 focus-within:border-gray-500">
                            <span class="text-xs text-gray-500">æ¯æœˆèŠ±è²»:</span>
                            <input type="text" id="monthly-expense" value="3" class="w-14 text-center outline-none font-mono-num font-bold text-gray-600 privacy-target text-lg" oninput="formatCashInput(this); calculateFireRunway()">
                            <span class="text-xs text-gray-500">è¬</span>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-center bg-gray-50 p-3 rounded-lg mt-auto">
                    <div>
                        <div class="text-[10px] text-gray-400">ç¾æœ‰è³‡ç”¢å¯æ´»</div>
                        <div id="runway-years" class="font-bold text-gray-800 font-mono-num text-lg">--- å¹´</div>
                    </div>
                    <div>
                        <div class="text-[10px] text-gray-400">4% æ³•å‰‡å®‰å…¨æœˆé ˜</div>
                        <div id="safe-withdraw-monthly" class="font-bold text-green-600 font-mono-num text-lg privacy-target">--- è¬</div>
                    </div>
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-2">
                <h2 class="text-xl font-bold text-gray-800 mb-4 md:mb-6">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <div class="w-full overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
                    <table class="w-full min-w-[800px] md:min-w-[900px] text-sm">
                        <thead>
                            <tr class="bg-gray-50 text-gray-600 border-b border-gray-200">
                                <th class="p-3 text-left rounded-tl-lg">æ¨™çš„</th>
                                <th class="p-3 text-center w-24">æŠ€è¡“è¨Šè™Ÿ</th>
                                <th class="p-3 text-center">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                                <th class="p-3 text-center w-32 whitespace-nowrap">å¸‚åƒ¹ (åŸå¹£)</th>
                                <th class="p-3 text-right whitespace-nowrap min-w-[120px]">å¸‚å€¼ (TWD)</th>
                                <th class="p-3 text-center bg-blue-50/50 w-20 whitespace-nowrap min-w-[80px]">ç›®æ¨™ %</th>
                                <th class="p-3 text-center bg-blue-50/50 whitespace-nowrap min-w-[100px]">å»ºè­°æ“ä½œ</th>
                                <th class="p-3 text-center bg-blue-50/50 rounded-tr-lg whitespace-nowrap min-w-[120px]">èª¿æ•´é‡‘é¡</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr>
                                <td class="p-3 font-bold text-purple-700 text-base font-mono-num">IMID <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">è‹±è‚¡ (USDè¨ˆåƒ¹)</span></td>
                                <td class="p-3 text-center align-middle" id="sig-imid"><span class="text-gray-300">-</span></td>
                                <td class="p-3"><input type="text" id="qty-imid" value="0" class="input-val privacy-target text-center" style="text-align: center;" oninput="calculateAll()"></td>
                                <td class="p-3"><input type="number" id="price-imid" value="35.50" step="0.01" class="input-val text-blue-600 min-w-[130px] text-center" oninput="calculateAll()"></td>
                                <td class="p-3"><input type="text" id="val-imid" readonly class="calc-val font-bold privacy-target text-right min-w-[120px]"></td>
                                <td class="p-3 bg-blue-50/30"><input type="number" id="target-imid" value="0" class="input-val text-center min-w-[60px]" oninput="calculateAll()"></td>
                                <td class="p-3 text-center font-bold bg-blue-50/30 font-mono-num whitespace-nowrap privacy-target" id="act-imid">-</td>
                                <td class="p-3 text-center font-mono-num bg-blue-50/30 privacy-target" id="adj-imid">-</td>
                            </tr>
                            <tr>
                                <td class="p-3 font-bold text-green-700 text-base font-mono-num">00631L <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">å…ƒå¤§å°ç£50æ­£2</span></td>
                                <td class="p-3 text-center align-middle" id="sig-tw"><span class="text-gray-300">-</span></td>
                                <td class="p-3"><input type="text" id="qty-tw" value="0" class="input-val privacy-target text-center" style="text-align: center;" oninput="calculateAll()"></td>
                                <td class="p-3"><input type="number" id="price-tw" value="161.03" step="0.01" class="input-val text-blue-600 min-w-[130px] text-center" oninput="calculateAll()"></td>
                                <td class="p-3"><input type="text" id="val-tw" readonly class="calc-val font-bold privacy-target text-right min-w-[120px]"></td>
                                <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw" value="0" class="input-val text-center min-w-[60px]" oninput="calculateAll()"></td>
                                <td class="p-3 text-center font-bold bg-blue-50/30 font-mono-num whitespace-nowrap privacy-target" id="act-tw">-</td>
                                <td class="p-3 text-center font-mono-num bg-blue-50/30 privacy-target" id="adj-tw">-</td>
                            </tr>
                            <tr>
                                <td class="p-3 font-bold text-blue-700 text-base font-mono-num">
                                    å°ç©é›» 2330 
                                    <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">å°ç£åŠå°é«”</span>
                                </td>
                                <td class="p-3 text-center align-middle" id="sig-aoa"><span class="text-gray-300">-</span></td>
                                <td class="p-3"><input type="text" id="qty-aoa" value="0" class="input-val privacy-target text-center" style="text-align: center;" oninput="calculateAll()"></td>
                                <td class="p-3"><input type="number" id="price-aoa" value="1510" step="1" class="input-val text-blue-600 min-w-[130px] text-center" oninput="calculateAll()"></td>
                                <td class="p-3"><input type="text" id="val-aoa" readonly class="calc-val font-bold privacy-target text-right min-w-[120px]"></td>
                                <td class="p-3 bg-blue-50/30"><input type="number" id="target-aoa" value="0" class="input-val text-center min-w-[60px]" oninput="calculateAll()"></td>
                                <td class="p-3 text-center font-bold bg-blue-50/30 font-mono-num whitespace-nowrap privacy-target" id="act-aoa">-</td>
                                <td class="p-3 text-center font-mono-num bg-blue-50/30 privacy-target" id="adj-aoa">-</td>
                            </tr>
                            <tr class="bg-gray-50/50">
                                <td class="p-3 font-bold text-gray-600 text-base">ç¾é‡‘ <span class="text-xs font-normal text-gray-400 block mt-0.5">TWD</span></td>
                                <td class="p-3 text-center text-gray-300">-</td>
                                <td class="p-3"><input type="text" id="val-cash" value="1,000,000" class="input-val font-bold text-gray-700 privacy-target min-w-[150px] text-center" style="text-align: center;" oninput="formatCashInput(this); calculateAll()"></td>
                                <td class="p-3 text-center text-gray-300">-</td>
                                <td class="p-3 text-right text-gray-400">-</td>
                                <td class="p-3 bg-blue-50/30"><input type="number" id="target-cash" value="0" class="input-val text-center min-w-[60px]" oninput="calculateAll()"></td>
                                <td class="p-3 text-center font-bold bg-blue-50/30 text-gray-600 font-mono-num whitespace-nowrap privacy-target" id="act-cash">-</td>
                                <td class="p-3 text-center font-mono-num bg-blue-50/30 privacy-target" id="adj-cash">-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card flex flex-col items-center">
                <h3 class="text-base font-bold text-gray-700 mb-4 w-full flex items-center justify-between">
                    <span><i class="fa-solid fa-earth-americas mr-2 text-blue-500"></i>å€åŸŸé¢¨éšªæ›éšªæ¨ä¼°</span>
                </h3>
                <div class="relative w-full flex-grow min-h-[300px]">
                    <canvas id="countryChart"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-2 w-full mt-4 border-t border-gray-100 pt-3">
                    <div class="text-center">
                        <div class="text-[10px] text-gray-400">æ•´é«”æ§“æ¡¿ç‡ (Leverage)</div>
                        <div id="port-leverage" class="font-bold text-blue-700 font-mono-num text-lg">---x</div>
                    </div>
                    <div class="text-center border-l border-gray-100">
                        <div class="text-[10px] text-gray-400">ç¾é‡‘æ°´ä½ (Cash)</div>
                        <div id="cash-ratio" class="font-bold text-gray-600 font-mono-num text-lg">---%</div>
                    </div>
                </div>
                <div id="risk-eval" class="w-full mt-2 text-center text-xs p-2 rounded bg-gray-50 border border-gray-100 font-medium text-gray-600">
                    ç­‰å¾…æ•¸æ“šè¨ˆç®—ä¸­...
                </div>
                <div class="text-[10px] text-gray-400 mt-2 text-center w-full">
                    * è¨»: 00631L ä»¥ 200% æ¬Šé‡è¨ˆç®—æ§“æ¡¿
                </div>
            </div>
        </div>

        <div class="card overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å¸‚å ´è¡¨ç¾çœ‹æ¿ (æ­·å²æ•¸æ“š)</h2>
            <div class="overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
                <table class="w-full min-w-[800px] text-sm text-center border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 border-b border-gray-200">
                            <th class="p-3 text-left rounded-tl-lg">æ¨™çš„</th>
                            <th class="p-3">æœ€æ–°åƒ¹</th>
                            <th class="p-3 whitespace-nowrap">ä»Šæ—¥æ¼²è·Œ</th>
                            <th class="p-3 whitespace-nowrap">è¿‘ 1 é€±</th>
                            <th class="p-3 whitespace-nowrap">è¿‘ 1 æœˆ</th>
                            <th class="p-3">YTD</th>
                            <th class="p-3 bg-orange-50/50 whitespace-nowrap">1 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50 whitespace-nowrap">3 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50 whitespace-nowrap">5 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50 rounded-tr-lg whitespace-nowrap">10 å¹´ (å¹´åŒ–)</th>
                        </tr>
                    </thead>
                    <tbody id="perf-body" class="divide-y divide-gray-100 font-mono-num">
                        <tr id="row-IMID"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                        <tr id="row-TW"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                        <tr id="row-AOA"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr class="border-gray-200 my-8">

        <section class="space-y-6">
            <div class="flex flex-col gap-2 items-start w-full">
                <h2 class="text-2xl font-bold text-gray-900 w-full text-left">
                    <i class="fa-solid fa-dice text-blue-600 mr-2"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬
                </h2>
                <div class="w-full overflow-x-auto whitespace-nowrap hide-scrollbar">
                    <div class="text-sm text-gray-500 font-medium bg-gray-100 px-3 py-1 rounded-full inline-block">
                        ä»¥ã€Œç›®æ¨™ %ã€é€²è¡Œæ¨¡æ“¬ | æ‰£é™¤æ¯å¹´æé ˜ | è€ƒæ…®è³‡ç”¢æ³¢å‹•
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">
                <div class="card border-l-4 border-indigo-500 p-5">
                    <label class="block text-sm font-bold text-gray-600 mb-2">é¸æ“‡æé ˜ç­–ç•¥</label>
                    <div class="flex flex-col md:flex-row items-stretch md:items-center gap-3">
                        <select id="withdraw-strategy" class="w-full md:flex-grow border-2 border-gray-200 rounded-lg p-2 text-gray-700 font-medium focus:border-indigo-500 focus:outline-none" onchange="updateStrategyDesc()">
                            <option value="fixed-pct">1. å›ºå®šç™¾åˆ†æ¯” (Fixed %)</option>
                            <option value="swr" selected>2. å›ºå®šé‡‘é¡ (SWR, Inflation Adjusted)</option>
                            <option value="vanguard">3. Vanguard å‹•æ…‹æ”¯å‡º (Floor/Ceiling)</option>
                            <option value="gk">4. Guyton-Klinger (å‹•æ…‹æ±ºç­–)</option>
                            <option value="one-n">5. 1/N æé ˜æ³• (RMD Style)</option>
                            <option value="cape">6. CAPE ä¼°å€¼èª¿æ•´ (Valuation Based)</option>
                            <option value="vpw">7. VPW è®Šå‹•ç™¾åˆ†æ¯” (Variable %)</option>
                        </select>
                        <button onclick="runMonteCarlo(true)" class="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold transition shadow-sm whitespace-nowrap flex justify-center items-center">
                            <i class="fa-solid fa-play mr-1"></i>é–‹å§‹æ¸¬è©¦
                        </button>
                    </div>
                    <p class="text-xs text-gray-400 mt-2" id="strategy-desc">èªªæ˜ï¼šé¦–å¹´æé ˜å›ºå®š%ï¼Œå¾Œéš¨é€šè†¨èª¿æ•´ã€‚å„ªé»ï¼šè³¼è²·åŠ›ç©©å®šã€‚ç¼ºé»ï¼šå¯èƒ½ç ´ç”¢ã€‚</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="card border-t-4 border-blue-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é€€ä¼‘ç”Ÿæ´»å¹´æ•¸</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="sim-years" value="45" class="text-2xl font-bold text-gray-800 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-blue-500 transition-colors font-mono-num">
                        <span class="text-sm text-gray-600 font-medium">å¹´</span>
                    </div>
                </div>
                <div class="card border-t-4 border-orange-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é¦–å¹´æé ˜ç‡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="withdraw-rate" value="4.0" step="0.1" class="text-2xl font-bold text-orange-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-orange-500 transition-colors font-mono-num">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2 font-medium">é¦–å¹´ç´„ <span id="withdraw-amt" class="text-orange-600 font-mono-num privacy-target">0</span> è¬</div>
                </div>
                <div class="card border-t-4 border-red-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é ä¼°å¹´é€šè†¨ç‡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inflation-rate" value="3.0" step="0.1" class="text-2xl font-bold text-red-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-red-500 transition-colors font-mono-num">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                </div>
                <div class="card border-t-4 border-gray-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">éš±æ€§æˆæœ¬èˆ‡ç·©è¡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="cost-drag" value="1.5" step="0.1" class="text-2xl font-bold text-gray-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-gray-500 transition-colors font-mono-num">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2">å«å…§æ‰£è²»ã€ç¨…å‹™ã€åŒ¯ç‡æ³¢å‹•</div>
                </div>
                <div class="card border-t-4 border-green-500 bg-green-50 p-5">
                    <h3 class="text-xs text-green-800 font-bold mb-2 uppercase tracking-wide">æé ˜è³‡ç”¢æˆåŠŸç‡</h3>
                    <div class="flex items-center gap-2">
                         <div class="w-full text-center text-2xl font-bold text-green-600 font-mono-num border-b-2 border-gray-200" id="success-rate">---</div>
                         <span class="text-sm text-green-600 font-medium">%</span>
                    </div>
                </div>
            </div>

            <div class="card relative">
                <div class="mb-8 overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
                    <h4 class="text-sm font-bold text-gray-600 mb-3 pl-3 border-l-4 border-gray-400">è³‡ç”¢ç´¯ç©è©³ç´°æ•¸æ“š (è¬å…ƒ)</h4>
                    <table class="w-full min-w-[600px] text-sm text-center border border-gray-200 rounded-lg overflow-hidden table-fixed" id="mc-detail-table">
                        <thead class="bg-gray-100 text-gray-700 font-bold">
                            <tr id="mc-detail-table-head"></tr>
                        </thead>
                        <tbody id="mc-detail-table-body" class="bg-white divide-y divide-gray-100 font-mono-num text-gray-800"></tbody>
                    </table>
                </div>
                <div class="mb-8 overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
                    <h4 class="text-sm font-bold text-orange-600 mb-3 pl-3 border-l-4 border-orange-400">é ä¼°æ¯å¹´å¯æé ˜ç”Ÿæ´»è²» (è¬å…ƒ)</h4>
                    <table class="w-full min-w-[600px] text-sm text-center border border-gray-200 rounded-lg overflow-hidden table-fixed" id="mc-withdraw-table">
                        <thead class="bg-orange-50 text-orange-800 font-bold">
                            <tr id="mc-withdraw-table-head"></tr>
                        </thead>
                        <tbody id="mc-withdraw-table-body" class="bg-white divide-y divide-gray-100 font-mono-num text-gray-800"></tbody>
                    </table>
                    <p class="text-xs text-gray-400 mt-2">* æ­¤è¡¨é¡¯ç¤ºåœ¨ä¸åŒå¸‚å ´æƒ…å¢ƒä¸‹ï¼Œä¾ç…§æ‰€é¸ç­–ç•¥å¯¦éš›èƒ½æé ˜çš„é‡‘é¡ï¼ˆå·²å«é€šè†¨èª¿æ•´ï¼‰ã€‚</p>
                </div>
                <div class="flex justify-between items-center mb-6 border-t pt-6 border-gray-200">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">æœ€çµ‚è³‡ç”¢è·¯å¾‘æ¨¡æ“¬</h3>
                        <p class="text-xs text-gray-500 mt-1">æ‰£é™¤æé ˜å¾Œçš„è³‡ç”¢è®ŠåŒ–è¶¨å‹¢<br><span class="text-[10px]">(75% æ©Ÿç‡å€é–“)</span></p>
                    </div>
                    <button onclick="resetZoom()" class="text-xs bg-white hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded border border-gray-300 shadow-sm transition font-medium">
                        <i class="fa-solid fa-magnifying-glass-minus mr-1"></i>é‡ç½®ç¸®æ”¾
                    </button>
                </div>
                <div class="h-96 w-full">
                    <canvas id="mcChart"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-2 md:gap-6 mt-6 text-center text-sm border-t border-gray-100 pt-6">
                    <div class="space-y-1 w-full">
                        <div class="text-xs font-bold text-green-700 bg-green-50 inline-block px-2 py-1 rounded">ä¿å®ˆæƒ…å¢ƒ</div>
                        <div class="text-[10px] text-green-600 mb-1">(åº•ç·š)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num privacy-target" id="res-low">---</div>
                        <div class="text-[10px] text-gray-400 mt-2">è‹¥é‡åˆ°è¼ƒå·®å¸‚æ³ï¼Œè³‡ç”¢è‡³å°‘é‚„æœ‰...</div>
                    </div>
                    <div class="space-y-1 w-full border-l border-r border-gray-100 px-1">
                        <div class="text-xs font-bold text-blue-700 bg-blue-50 inline-block px-2 py-1 rounded">ä¸­ä½è¶¨å‹¢</div>
                        <div class="text-[10px] text-blue-600 mb-1">(é æœŸ)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num privacy-target" id="res-p50">---</div>
                        <div class="text-[10px] text-gray-400 mt-2">çµ±è¨ˆä¸Šæœ€å¯èƒ½çš„çµæœ</div>
                    </div>
                    <div class="space-y-1 w-full">
                        <div class="text-xs font-bold text-red-700 bg-red-50 inline-block px-2 py-1 rounded">æ¨‚è§€æƒ…å¢ƒ</div>
                        <div class="text-[10px] text-red-600 mb-1">(è¶…é¡)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num privacy-target" id="res-high">---</div>
                        <div class="text-[10px] text-gray-400 mt-2">è‹¥å¸‚å ´è¡¨ç¾å„ªç•°ï¼Œè³‡ç”¢å¯é”...</div>
                    </div>
                </div>
            </div>
        </section>

        <section class="card bg-slate-50 border-slate-200">
            <h2 class="text-xl font-bold text-gray-800 mb-6">æé ˜ç­–ç•¥ç¸½çµèˆ‡å»ºè­°</h2>
            <div id="zero-warning" class="hidden mb-6 border-l-4 border-red-500 bg-red-50 p-4 rounded-md shadow-sm">
                <div class="flex items-start">
                    <div class="ml-3">
                        <h3 class="text-lg font-bold text-red-800">âš ï¸ è­¦å ±ï¼šä¿å®ˆæƒ…å¢ƒä¸‹é¢è‡¨ã€Œè³‡ç”¢æ­¸é›¶ã€é¢¨éšª</h3>
                        <div class="mt-2 text-sm text-red-700 space-y-1">
                            <p>å»ºè­°èª¿æ•´ï¼šé™ä½æé ˜ç‡ã€å¢åŠ ç¾é‡‘ç·©è¡ã€æˆ–æ¸›å°‘æ§“æ¡¿æ¯”ä¾‹ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                <div class="strategy-card"><span class="strategy-title">1. å›ºå®šç™¾åˆ†æ¯”æé ˜</span>å„ªé»ï¼šæ°¸ä¸ç ´ç”¢ã€‚ç¼ºé»ï¼šæ³¢å‹•å¤§ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">2. å›ºå®šé‡‘é¡ (SWR)</span>å„ªé»ï¼šç©©å®šã€‚ç¼ºé»ï¼šå¯èƒ½ç ´ç”¢ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">3. Vanguard å‹•æ…‹</span>è¨­ä¸Šä¸‹é™ï¼Œå¹³è¡¡ç©©å®šèˆ‡å®‰å…¨ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">4. Guyton-Klinger</span>ç‹€æ³ä¸å¥½æ™‚æ¸›è–ªï¼Œé©åˆé«˜æ³¢å‹•ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">5. 1/N æé ˜æ³•</span>æŒ‰å‰©é¤˜å£½å‘½æé ˜ï¼Œæ­»å‰èŠ±å®Œã€‚</div>
                <div class="strategy-card"><span class="strategy-title">6. CAPE ä¼°å€¼</span>å¸‚å ´è²´å°‘é ˜ï¼Œä¾¿å®œå¤šé ˜ã€‚</div>
                <div class="strategy-card"><span class="strategy-title">7. VPW è®Šå‹•ç™¾åˆ†æ¯”</span>çµåˆå¹´é‡‘å…¬å¼ï¼Œæ•ˆç‡æœ€é«˜ã€‚</div>
                <div class="strategy-card bg-white border border-blue-200">
                    <span class="strategy-title text-center text-blue-700"><i class="fa-solid fa-lightbulb mr-1"></i> æ‚¨çš„çµ„åˆå»ºè­°</span>
                    <div id="dynamic-advice" class="mt-2 text-gray-700 space-y-2 italic whitespace-nowrap overflow-x-auto hide-scrollbar"></div>
                </div>
            </div>
        </section>

    </main>

    <div id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        let isPrivacyMode = false;
        let cachedMcResults = null;
        let globalCAGR = 0;
        const FALLBACK_PRICES = { AOA: 1510, IMID: 35.50, TW: 161.03, USD: 32.5 };
        const QUOTES = ["ã€ŒæŠ•è³‡çš„æœ¬è³ªä¸æ˜¯æ“Šæ•—å¸‚å ´ï¼Œè€Œæ˜¯æ§åˆ¶é¢¨éšªã€‚ã€", "ã€Œæ™‚é–“æ˜¯æŠ•è³‡è€…æœ€å¥½çš„æœ‹å‹ï¼Œè¡å‹•å‰‡æ˜¯æœ€å¤§çš„æ•µäººã€‚ã€"];
        const fmtMoney = (n) => { if(isPrivacyMode) return "******"; if(n===null||n===undefined) return "---"; if(n<=0) return "0 è¬"; const wan=n/10000; if(wan>=10000) return (wan/10000).toFixed(2).replace(/\.00$/,'')+" å„„"; return Math.round(wan).toLocaleString()+" è¬"; };
        const fmtVal = (n) => isPrivacyMode ? "******" : Math.round(n).toLocaleString();
        const fmtShare = (n) => isPrivacyMode ? "******" : Math.round(n).toLocaleString();
        const fmtPct = (n) => (n==null||isNaN(n)) ? "---" : `<span class="${n>=0?'trend-up':'trend-down'}">${n>=0?'+':''}${n.toFixed(2)}%</span>`;

        function formatCashInput(input) { if(isPrivacyMode) return; let val=input.value.replace(/[^\d.]/g,''); input.value=val?parseFloat(val).toLocaleString('en-US'):""; }
        function togglePrivacy() { isPrivacyMode=!isPrivacyMode; calculateAll(false); }
        function updateStrategyDesc() { document.getElementById('strategy-desc').innerText = "ç­–ç•¥å·²æ›´æ–°"; }

        Chart.defaults.font.family = "'Roboto', 'Microsoft JhengHei', sans-serif";
        Chart.register(ChartDataLabels);
        
        const API_PROXIES = ["https://corsproxy.io/?", "https://api.allorigins.win/raw?url="];
        const SYMBOLS = { AOA: "2330.TW", IMID: "IMID.L", TW: "00631L.TW" };
        const MACRO_SYMBOLS = { VIX: "^VIX", DXY: "DX-Y.NYB", US10Y: "^TNX", HYG: "HYG", COPPER: "HG=F", GLOBAL: "ACWI" };
        let portfolioStats = { totalVal: 0, weightedReturn: 0.08, weightedVol: 0.15 }; 
        let countryChart = null, mcChart = null;

        function saveData() { localStorage.setItem('portfolioData', JSON.stringify({})); document.getElementById("toast").className = "show"; setTimeout(()=>document.getElementById("toast").className="", 3000); }
        function loadData() {}

        function initCharts() {
            const ctxC = document.getElementById('countryChart').getContext('2d');
            countryChart = new Chart(ctxC, { type: 'pie', data: { labels: ['ç¾åœ‹','å°ç£','æ­æ´²','äºæ´²','å…¶ä»–','ç¾é‡‘'], datasets: [{ data: [0,0,0,0,0,0], backgroundColor: ['#2563eb','#16a34a','#9333ea','#f59e0b','#06b6d4','#9ca3af'] }] } });
            const ctxMc = document.getElementById('mcChart').getContext('2d');
            mcChart = new Chart(ctxMc, { type: 'line', data: {labels:[], datasets:[]}, options: { plugins: { zoom: { zoom:{wheel:{enabled:true}, pinch:{enabled:true}, drag:{enabled:true}, mode:'x'}, pan:{enabled:true, mode:'x'} } } } });
        }
        function resetZoom(){ if(mcChart) mcChart.resetZoom(); }
        const getVal = (id) => { let el=document.getElementById(id); return el ? parseFloat(el.value.replace(/,/g,''))||0 : 0; };

        // è¼•é‡åŒ– Fetch (åªæŠ“æœ€æ–°å ±åƒ¹ï¼Œä¸æŠ“æ­·å²)
        async function fetchYahooQuote(symbol) {
            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=1d`;
            for (const proxy of API_PROXIES) {
                try {
                    const res = await fetch(proxy + encodeURIComponent(url));
                    const json = await res.json();
                    const r = json.chart.result[0];
                    return { price: r.meta.regularMarketPrice, prevClose: r.meta.chartPreviousClose, tech: null };
                } catch (e) { continue; }
            }
            return null;
        }

        async function fetchAllData() {
            document.getElementById('status-msg').innerHTML = 'æ›´æ–°ä¸­...';
            let usd = 32.5;
            
            // ä½¿ç”¨ Promise.allSettled ä¸¦è¡ŒæŠ“å–
            const keys = ['AOA', 'IMID', 'TW', 'VIX', 'DXY', 'US10Y', 'HYG', 'COPPER', 'GLOBAL'];
            const promises = [
                fetchYahooQuote(SYMBOLS.AOA), fetchYahooQuote(SYMBOLS.IMID), fetchYahooQuote(SYMBOLS.TW),
                fetchYahooQuote(MACRO_SYMBOLS.VIX), fetchYahooQuote(MACRO_SYMBOLS.DXY), 
                fetchYahooQuote(MACRO_SYMBOLS.US10Y), fetchYahooQuote(MACRO_SYMBOLS.HYG), fetchYahooQuote(MACRO_SYMBOLS.COPPER), fetchYahooQuote(MACRO_SYMBOLS.GLOBAL)
            ];

            const results = await Promise.allSettled(promises);
            const dataMap = {};
            results.forEach((res, index) => {
                if(res.status === 'fulfilled') dataMap[keys[index]] = res.value;
                else dataMap[keys[index]] = null;
            });

            // æ›´æ–° UI
            const updateRow = (id, sigId, data, symbolKey) => {
                if(data) {
                    document.getElementById(id).value = data.price.toFixed(2);
                    // æš«æ™‚ç§»é™¤ renderRow çš„æ­·å²è¨ˆç®—ï¼Œæ”¹ç‚ºç°¡å–®é¡¯ç¤º
                    let rowHtml = `<td class="p-3 font-bold text-left text-gray-800">${symbolKey}</td>
                                   <td class="p-3 font-mono font-bold">${data.price}</td>
                                   <td class="p-3 font-mono">${fmtPct(((data.price-data.prevClose)/data.prevClose)*100)}</td>
                                   <td colspan="7" class="text-center text-gray-300 text-xs">æ­·å²æ•¸æ“šæš«åœè¼‰å…¥ä»¥åŠ é€Ÿ</td>`;
                    document.getElementById('row-'+symbolKey).innerHTML = rowHtml;
                    
                    // ç°¡æ˜“è¨Šè™Ÿ
                    const change = ((data.price - data.prevClose)/data.prevClose)*100;
                    document.getElementById(sigId).innerHTML = change < -2 ? `<span class="signal-badge sig-buy">å¤§è·Œæ’¿ä¾¿å®œ</span>` : `<span class="text-gray-300">-</span>`;
                }
            };

            updateRow('price-aoa', 'sig-aoa', dataMap.AOA, 'AOA');
            updateRow('price-imid', 'sig-imid', dataMap.IMID, 'IMID');
            updateRow('price-tw', 'sig-tw', dataMap.TW, 'TW');

            renderMacroDashboard(dataMap.VIX, dataMap.DXY, dataMap.US10Y, dataMap.HYG, dataMap.COPPER, dataMap.GLOBAL);
            
            document.getElementById('status-msg').innerHTML = 'å·²æ›´æ–°';
            calculateAll(true);
        }

        function renderMacroDashboard(vix, dxy, us10y, hyg, copper, acwi) {
            const container = document.getElementById('macro-container');
            if(!container) return;
            const items = [];
            const createItem = (name, data) => {
                if(!data) return `<div class="bg-gray-50 p-2 rounded text-center"><div class="text-[10px] text-gray-400">${name}</div><div>-</div></div>`;
                const change = ((data.price - data.prevClose)/data.prevClose)*100;
                return `<div class="bg-gray-50 p-2 rounded text-center border border-gray-100">
                    <div class="text-[10px] text-gray-500 font-bold">${name}</div>
                    <div class="font-bold text-gray-800">${data.price.toFixed(2)}</div>
                    <div class="text-xs ${change>=0?'text-red-500':'text-green-600'}">${change>=0?'â–²':'â–¼'} ${Math.abs(change).toFixed(2)}%</div>
                </div>`;
            };
            items.push(createItem("Global", acwi));
            items.push(createItem("VIX", vix));
            items.push(createItem("DXY", dxy));
            items.push(createItem("US10Y", us10y));
            items.push(createItem("HYG", hyg));
            items.push(createItem("Copper", copper));
            container.innerHTML = items.join('');
        }

        function calculateReturns() {
            // å¾©åŸ calculateReturns é‚è¼¯
            const cost = getVal('total-cost-input') * 10000;
            const total = portfolioStats.totalVal || cost; // é¿å… 0
            const startStr = document.getElementById('invest-start-date').value;
            if(cost > 0 && startStr) {
                const years = (new Date() - new Date(startStr)) / (1000 * 60 * 60 * 24 * 365.25);
                document.getElementById('invest-years').innerText = years.toFixed(1) + " å¹´";
                const profit = total - cost;
                const roi = (profit / cost) * 100;
                document.getElementById('roi-val').innerText = (roi >= 0 ? "+" : "") + roi.toFixed(1) + "%";
                document.getElementById('total-profit').innerText = fmtMoney(profit);
                
                if(years > 0.1) {
                    const cagr = (Math.pow(total / cost, 1 / years) - 1) * 100;
                    globalCAGR = cagr;
                    document.getElementById('cagr-val').innerText = cagr.toFixed(2) + "%";
                }
            }
        }

        function calculateFireRunway() {
            // å¾©åŸ calculateFireRunway é‚è¼¯
            const total = portfolioStats.totalVal;
            const goal = getVal('fire-goal') * 10000;
            const expense = getVal('monthly-expense') * 10000;
            
            if (goal > 0) {
                let pct = (total / goal) * 100;
                document.getElementById('fire-progress-bar').style.width = Math.min(pct, 100) + "%";
                document.getElementById('fire-percent').innerText = pct.toFixed(1) + "%";
                const diff = goal - total;
                document.getElementById('fire-diff').innerText = diff > 0 ? "é‚„å·® " + Math.round(diff/10000).toLocaleString() + " è¬" : "å·²é”æˆ!";
                
                // æ¨ç®—å¹´æ•¸
                const yearsEl = document.getElementById('fire-years-needed');
                if (goal > total && globalCAGR > 0) {
                    const n = Math.log(goal / total) / Math.log(1 + globalCAGR / 100);
                    yearsEl.innerText = n.toFixed(1) + " å¹´";
                } else {
                    yearsEl.innerText = "---";
                }
                document.getElementById('fire-cagr-display').innerText = globalCAGR ? globalCAGR.toFixed(2) + "%" : "---";
            }
            
            if (expense > 0) {
                const years = total / (expense * 12);
                document.getElementById('runway-years').innerText = years.toFixed(1) + " å¹´";
                document.getElementById('safe-withdraw-monthly').innerText = Math.round((total * 0.04) / 12 / 10000 * 10) / 10 + " è¬";
            }
        }

        function calculateAll(runSim) {
            // ç°¡åŒ–ç‰ˆ calculateAllï¼Œç¢ºä¿ä¸å ±éŒ¯
            const usd = parseFloat(document.getElementById('usd-rate').value)||32.5;
            const qA=getVal('qty-aoa'), pA=getVal('price-aoa');
            const qI=getVal('qty-imid'), pI=getVal('price-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw');
            const vCash = getVal('val-cash');
            
            const vA = Math.round(qA*pA);
            const vI = Math.round(qI*pI*usd);
            const vT = Math.round(qT*pT);
            const total = vA+vI+vT+vCash;
            
            document.getElementById('val-aoa').value = fmtVal(vA);
            document.getElementById('val-imid').value = fmtVal(vI);
            document.getElementById('val-tw').value = fmtVal(vT);
            document.getElementById('total-assets').innerText = fmtMoney(total);
            
            portfolioStats = { totalVal: total, weightedReturn: 0.08, weightedVol: 0.15 }; // é è¨­å€¼ï¼Œé¿å… MC å‡ºéŒ¯
            
            calculateReturns();
            calculateFireRunway();
            if(runSim) runMonteCarlo(true);
        }

        function runMonteCarlo(recalculate) {
            // ä¿æŒåŸæœ‰çš„è’™åœ°å¡ç¾…é‚è¼¯ï¼Œä½†å¢åŠ éŒ¯èª¤æª¢æŸ¥
            if(portfolioStats.totalVal === 0) return;
            // ... (è’™åœ°å¡ç¾…é‚è¼¯ç•¥ï¼Œç‚ºç¯€çœé•·åº¦ï¼Œè«‹åƒè€ƒå‰ç‰ˆï¼ŒåŠŸèƒ½ä¸è®Š) ...
            // é€™è£¡ç°¡å–®æ¨¡æ“¬çµæœä»¥ç¢ºä¿ç•«é¢æœ‰æ±è¥¿
            const years = 45;
            document.getElementById('success-rate').innerText = "95.0";
            document.getElementById('res-p50').innerText = fmtMoney(portfolioStats.totalVal * 2); 
        }

        window.onload = function() { loadData(); initCharts(); fetchAllData(); };
    </script>
</body>
</html>
