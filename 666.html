<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ & è’™åœ°å¡ç¾…é€€ä¼‘æ¨¡æ“¬ (åœ–ä¾‹æ’åºç‰ˆ)</title>
    
    <!-- å¼•å…¥ Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { 
            font-family: 'Roboto', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; 
            background-color: #f3f4f6; 
            color: #374151;
        }
        .font-mono-num { font-family: 'Roboto Mono', monospace; }
        .card { 
            background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            padding: 24px; border: 1px solid #e5e7eb; 
        }
        .input-val { 
            width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; 
            text-align: right; font-weight: 700; font-family: 'Roboto Mono', monospace;
            transition: all 0.2s; color: #1f2937;
        }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        .calc-val { 
            border: none; background: transparent; text-align: right; 
            font-family: 'Roboto Mono', monospace; color: #374151; width: 100%; font-size: 1rem;
        }
        .trend-up { color: #dc2626; font-weight: 700; }
        .trend-down { color: #16a34a; font-weight: 700; }
        .strategy-card { 
            border-left: 4px solid #3b82f6; background: #f8fafc; padding: 16px; margin-bottom: 12px; 
            border-radius: 8px; font-size: 0.95rem; line-height: 1.5;
        }
        .strategy-title { font-weight: 700; color: #1e40af; display: block; margin-bottom: 6px; font-size: 1.05rem; }
        th { font-weight: 700; letter-spacing: 0.02em; }
        td { font-variant-numeric: tabular-nums; }
        
        #toast {
            visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333;
            color: #fff; text-align: center; border-radius: 2px; padding: 16px;
            position: fixed; z-index: 1; left: 50%; bottom: 30px; font-size: 17px;
        }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="pb-20">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-white/90">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight"><i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬</h1>
                <div class="flex items-center gap-2 mt-2">
                    <button onclick="saveData()" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full transition font-medium border border-green-200">
                        <i class="fa-solid fa-floppy-disk mr-1"></i>å„²å­˜è¨­å®š
                    </button>
                    <button onclick="fetchAllData()" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full transition font-medium border border-blue-200">
                        <i class="fa-solid fa-sync-alt mr-1"></i>åˆ·æ–°å ±åƒ¹
                    </button>
                    <span id="status-msg" class="text-xs text-gray-500 font-medium font-mono-num ml-2"></span>
                </div>
            </div>
            <div class="flex items-center gap-8">
                <div class="text-right border-r pr-8 border-gray-200">
                    <div class="text-xs text-gray-500 font-medium mb-1">USD/TWD åŒ¯ç‡</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-2xl font-bold text-blue-600 w-24 text-right bg-transparent border-none focus:ring-0 p-0 m-0 font-mono-num" onchange="calculateAll()">
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 font-medium mb-1">ç›®å‰å¸³é¢ç¸½è³‡ç”¢ (TWD)</div>
                    <div class="text-4xl font-bold text-gray-800 tracking-tight font-mono-num" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

        <!-- 1. å°ç£çµ±è¨ˆæ•¸æ“š -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="card border-l-4 border-purple-500 flex justify-between items-center">
                <div>
                    <div class="text-sm text-gray-500 font-medium">ğŸ‡¹ğŸ‡¼ å®¶åº­å¯æ”¯é…æ‰€å¾— (ä¸­ä½æ•¸)</div>
                    <div class="text-xs text-gray-400 mt-1">ä¸»è¨ˆç¸½è™• 112å¹´</div>
                </div>
                <div class="text-2xl font-bold text-purple-700 font-mono-num">113.7 è¬</div>
            </div>
            <div class="card border-l-4 border-indigo-500 flex justify-between items-center">
                <div>
                    <div class="text-sm text-gray-500 font-medium">ğŸ‡¹ğŸ‡¼ ç”·æ€§å¹³å‡é¤˜å‘½ (1987å¹´ç”Ÿä¼°ç®—)</div>
                    <div class="text-xs text-gray-400 mt-1">å…§æ”¿éƒ¨æ•¸æ“š + å¥åº·èª¿æ•´</div>
                </div>
                <div class="text-2xl font-bold text-indigo-700 font-mono-num">ç´„ 83 æ­²</div>
            </div>
        </section>

        <!-- 2. è³‡ç”¢é…ç½® -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-2 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <table class="w-full min-w-[700px] text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 border-b border-gray-200">
                            <th class="p-3 text-left rounded-tl-lg">æ¨™çš„</th>
                            <th class="p-3 text-right">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                            <th class="p-3 text-right w-32">å¸‚åƒ¹ (åŸå¹£)</th>
                            <th class="p-3 text-right">å¸‚å€¼ (TWD)</th>
                            <th class="p-3 text-right bg-blue-50/50 w-24">ç›®æ¨™ %</th>
                            <th class="p-3 text-right bg-blue-50/50 rounded-tr-lg">å»ºè­°æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <tr>
                            <td class="p-3 font-bold text-blue-700 text-base font-mono-num">AOA <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">ç¾è‚¡ ETF</span></td>
                            <td class="p-3"><input type="number" id="qty-aoa" value="2180" class="input-val" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="number" id="price-aoa" value="0" step="0.01" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="text" id="val-aoa" readonly class="calc-val text-base font-bold"></td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-aoa" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold bg-blue-50/30 text-base font-mono-num whitespace-nowrap" id="act-aoa">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-purple-700 text-base font-mono-num">IMID <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">è‹±è‚¡ (USDè¨ˆåƒ¹)</span></td>
                            <td class="p-3"><input type="number" id="qty-imid" value="0" class="input-val" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="number" id="price-imid" value="0" step="0.01" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="text" id="val-imid" readonly class="calc-val text-base font-bold"></td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-imid" value="60" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold bg-blue-50/30 text-base font-mono-num whitespace-nowrap" id="act-imid">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-green-700 text-base font-mono-num">00631L <span class="text-xs font-normal text-gray-400 block mt-0.5 font-sans">å…ƒå¤§å°ç£50æ­£2</span></td>
                            <td class="p-3"><input type="number" id="qty-tw" value="15500" class="input-val" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="number" id="price-tw" value="0" step="0.01" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3"><input type="text" id="val-tw" readonly class="calc-val text-base font-bold"></td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw" value="40" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold bg-blue-50/30 text-base font-mono-num whitespace-nowrap" id="act-tw">-</td>
                        </tr>
                        <tr class="bg-gray-50/50">
                            <td class="p-3 font-bold text-gray-600 text-base">ç¾é‡‘ <span class="text-xs font-normal text-gray-400 block mt-0.5">TWD</span></td>
                            <td class="p-3"><input type="text" id="val-cash" value="3,000,000" class="input-val font-bold text-gray-700" oninput="formatCashInput(this); calculateAll()"></td>
                            <td class="p-3 text-center text-gray-300">-</td>
                            <td class="p-3 text-right text-gray-400">-</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-cash" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold bg-blue-50/30 text-base text-gray-600 font-mono-num whitespace-nowrap" id="act-cash">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card flex flex-col items-center">
                <h3 class="text-base font-bold text-gray-700 mb-4 w-full flex items-center justify-between">
                    <span><i class="fa-solid fa-earth-americas mr-2 text-blue-500"></i>å€åŸŸé¢¨éšªæ›éšªæ¨ä¼°</span>
                </h3>
                <div class="relative w-full flex-grow min-h-[300px]">
                    <canvas id="countryChart"></canvas>
                </div>
                <div class="text-[10px] text-gray-400 mt-3 text-center bg-gray-50 p-2 rounded w-full">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i>
                    æ³¨æ„ï¼šæ­¤åœ–è¡¨é¡¯ç¤ºã€Œåç›®æ›éšªé‡‘é¡ã€ï¼Œå…¶ä¸­ <strong>00631L</strong> å·²æŒ‰ <strong>200%</strong> æ§“æ¡¿æ¬Šé‡è¨ˆç®—ã€‚
                </div>
            </div>
        </div>

        <!-- 3. å¸‚å ´è¡¨ç¾çœ‹æ¿ -->
        <div class="card overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å¸‚å ´è¡¨ç¾çœ‹æ¿ (æ­·å²æ•¸æ“š)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-center border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 border-b border-gray-200">
                            <th class="p-3 text-left rounded-tl-lg">æ¨™çš„</th>
                            <th class="p-3">æœ€æ–°åƒ¹</th>
                            <th class="p-3">ä»Šæ—¥æ¼²è·Œ</th>
                            <th class="p-3">è¿‘ 1 é€±</th>
                            <th class="p-3">è¿‘ 1 æœˆ</th>
                            <th class="p-3">YTD</th>
                            <th class="p-3 bg-orange-50/50">1 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50">3 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50">5 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50 rounded-tr-lg">10 å¹´ (å¹´åŒ–)</th>
                        </tr>
                    </thead>
                    <tbody id="perf-body" class="divide-y divide-gray-100 font-mono-num">
                        <tr id="row-AOA"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·šå–å¾—è³‡æ–™...</td></tr>
                        <tr id="row-IMID"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·šå–å¾—è³‡æ–™...</td></tr>
                        <tr id="row-TW"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·šå–å¾—è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </div>
            <p class="text-xs text-gray-400 mt-3 font-medium flex items-center">
                <i class="fa-solid fa-circle-info mr-1"></i> æ©˜è‰²æ¬„ä½ç‚ºè¤‡åˆ©å¹´åŒ–å ±é…¬ç‡ (CAGR)ï¼ŒçŸ­å¤©æœŸç‚ºç´¯ç©æ¼²è·Œå¹…ã€‚
            </p>
        </div>

        <hr class="border-gray-200 my-8">

        <!-- 4. è’™åœ°å¡ç¾…æ¨¡æ“¬å€å¡Š -->
        <section class="space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-dice text-blue-600 mr-2"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬</h2>
                <div class="text-sm text-gray-500 font-medium bg-gray-100 px-3 py-1 rounded-full">
                    ä»¥ã€Œç›®æ¨™ %ã€é€²è¡Œæ¨¡æ“¬ | æ‰£é™¤æ¯å¹´æé ˜ | è€ƒæ…®è³‡ç”¢æ³¢å‹•
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <!-- é€€ä¼‘å¹´æ•¸ -->
                <div class="card border-t-4 border-blue-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é€€ä¼‘ç”Ÿæ´»å¹´æ•¸</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="sim-years" value="45" class="text-2xl font-bold text-gray-800 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-blue-500 transition-colors font-mono-num" onchange="runMonteCarlo()">
                        <span class="text-sm text-gray-600 font-medium">å¹´</span>
                    </div>
                </div>
                <!-- é¦–å¹´æé ˜ç‡ -->
                <div class="card border-t-4 border-orange-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é¦–å¹´æé ˜ç‡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="withdraw-rate" value="4.0" step="0.1" class="text-2xl font-bold text-orange-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-orange-500 transition-colors font-mono-num" onchange="runMonteCarlo()">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2 font-medium">é¦–å¹´ç´„ <span id="withdraw-amt" class="text-orange-600 font-mono-num">0</span> è¬</div>
                </div>
                <!-- é€šè†¨ç‡ -->
                <div class="card border-t-4 border-red-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">é ä¼°å¹´é€šè†¨ç‡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inflation-rate" value="3.0" step="0.1" class="text-2xl font-bold text-red-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-red-500 transition-colors font-mono-num" onchange="runMonteCarlo()">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                </div>
                <!-- éš±æ€§æˆæœ¬ -->
                <div class="card border-t-4 border-gray-500 p-5">
                    <h3 class="text-xs text-gray-500 font-bold mb-2 uppercase tracking-wide">éš±æ€§æˆæœ¬èˆ‡ç·©è¡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="cost-drag" value="1.5" step="0.1" class="text-2xl font-bold text-gray-600 w-full border-b-2 border-gray-200 text-center focus:outline-none focus:border-gray-500 transition-colors font-mono-num" onchange="runMonteCarlo()">
                        <span class="text-sm text-gray-600 font-medium">%</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2">å«å…§æ‰£è²»ã€ç¨…å‹™ã€åŒ¯ç‡æ³¢å‹•</div>
                </div>
                <!-- æˆåŠŸç‡ -->
                <div class="card border-t-4 border-green-500 bg-green-50 p-5">
                    <h3 class="text-xs text-green-800 font-bold mb-2 uppercase tracking-wide">ç´¯ç©è³‡ç”¢æˆåŠŸç‡</h3>
                    <div class="flex items-center gap-2 h-[34px]">
                         <div class="text-2xl font-bold text-green-600 font-mono-num" id="success-rate">---%</div>
                    </div>
                </div>
            </div>

            <div class="card relative">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">æœ€çµ‚è³‡ç”¢è·¯å¾‘æ¨¡æ“¬</h3>
                        <p class="text-xs text-gray-500 mt-1">åŒ…å«é€šè†¨èª¿æ•´èˆ‡æé ˜å¾Œçš„å¯¦è³ªè³¼è²·åŠ›</p>
                    </div>
                    <button onclick="resetZoom()" class="text-xs bg-white hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded border border-gray-300 shadow-sm transition font-medium">
                        <i class="fa-solid fa-magnifying-glass-minus mr-1"></i>é‡ç½®ç¸®æ”¾
                    </button>
                </div>
                <div class="h-96 w-full">
                    <canvas id="mcChart"></canvas>
                </div>
                
                <!-- å„ªåŒ–å¾Œçš„æ•¸æ“šå‘ˆç¾å€ (å·²æ›´æ–°æ¨™é¡Œ) -->
                <div class="grid grid-cols-3 gap-6 mt-6 text-center text-sm border-t border-gray-100 pt-6">
                    <div class="space-y-1">
                        <div class="text-xs font-bold text-green-700 bg-green-50 inline-block px-2 py-1 rounded">ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num" id="res-low">---</div>
                        <div class="text-[10px] text-gray-400">è‹¥é‡åˆ°è¼ƒå·®å¸‚æ³ï¼Œè³‡ç”¢è‡³å°‘é‚„æœ‰...</div>
                    </div>
                    <div class="space-y-1 border-l border-r border-gray-100">
                        <div class="text-xs font-bold text-blue-700 bg-blue-50 inline-block px-2 py-1 rounded">ä¸­ä½è¶¨å‹¢ (é æœŸ)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num" id="res-p50">---</div>
                        <div class="text-[10px] text-gray-400">çµ±è¨ˆä¸Šæœ€å¯èƒ½çš„çµæœ</div>
                    </div>
                    <div class="space-y-1">
                        <div class="text-xs font-bold text-red-700 bg-red-50 inline-block px-2 py-1 rounded">æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)</div>
                        <div class="font-bold text-gray-800 text-2xl font-mono-num" id="res-high">---</div>
                        <div class="text-[10px] text-gray-400">è‹¥å¸‚å ´è¡¨ç¾å„ªç•°ï¼Œè³‡ç”¢å¯é”...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. æé ˜ç­–ç•¥å»ºè­° -->
        <section class="card bg-slate-50 border-slate-200">
            <h2 class="text-xl font-bold text-gray-800 mb-6">æé ˜ç­–ç•¥ç¸½çµèˆ‡å»ºè­°</h2>
            
            <!-- è³‡ç”¢æ­¸é›¶è­¦ç¤ºå¡ç‰‡ -->
            <div id="zero-warning" class="hidden mb-6 border-l-4 border-red-500 bg-red-50 p-4 rounded-md shadow-sm">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <i class="fa-solid fa-triangle-exclamation text-red-600 mt-1"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-lg font-bold text-red-800">âš ï¸ è­¦å ±ï¼šä¿å®ˆæƒ…å¢ƒä¸‹é¢è‡¨ã€Œè³‡ç”¢æ­¸é›¶ã€é¢¨éšª</h3>
                        <div class="mt-2 text-sm text-red-700 space-y-2">
                            <p><strong>é—œéµåŸå› ï¼š</strong> æ‚¨æŒæœ‰é«˜æ¯”ä¾‹çš„æ§“æ¡¿ ETF (00631L)ã€‚ç•¶é‡åˆ°é€£çºŒç†Šå¸‚å¤§è·Œæ™‚ï¼Œæ§“æ¡¿çš„æ³¢å‹•è€—æåŠ ä¸Šæ‚¨æŒçºŒå¾ä¸­æé ˜ç”Ÿæ´»è²»ï¼Œæœƒé€ æˆã€Œé †åºé¢¨éšª (Sequence of Risk)ã€ï¼Œå°è‡´æœ¬é‡‘åœ¨æ—©æœŸè¿…é€Ÿè€—ç›¡ï¼Œç„¡æ³•åƒèˆ‡å¾ŒçºŒåå½ˆã€‚</p>
                            <p><strong>å»ºè­°èª¿æ•´æ–¹å‘ï¼š</strong>
                                <ul class="list-disc pl-5 mt-1">
                                    <li><strong>é™ä½æé ˜ç‡ï¼š</strong>å°‡æé ˜ç‡å¾ 4% é™è‡³ 3% æˆ–æ›´ä½ã€‚</li>
                                    <li><strong>å¢åŠ ç¾é‡‘ç·©è¡ï¼š</strong>ç¢ºä¿æ‰‹ä¸Šæœ‰ 3-5 å¹´çš„ç”Ÿæ´»è²» (ç¾é‡‘éƒ¨ä½)ï¼Œåœ¨è‚¡å¸‚å¤§è·Œæ™‚æš«åœè³£è‚¡ï¼ŒåªèŠ±ç¾é‡‘ã€‚</li>
                                    <li><strong>é™ä½æ§“æ¡¿æ¯”ä¾‹ï¼š</strong>è€ƒæ…®æ¸›å°‘ 00631L çš„æŒæœ‰ä½”æ¯”ã€‚</li>
                                </ul>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="strategy-card">
                    <span class="strategy-title">1. å›ºå®šç™¾åˆ†æ¯”æé ˜ (4%)</span>
                    æ¯å¹´æé ˜ç•¶ä¸‹è³‡ç”¢çš„ 4%ã€‚<br>
                    <span class="text-green-600 font-bold">å„ªé»ï¼š</span> æ°¸é ä¸æœƒç ´ç”¢ã€‚<br>
                    <span class="text-red-500 font-bold">ç¼ºé»ï¼š</span> ç”Ÿæ´»è²»æ³¢å‹•å¤§ã€‚
                </div>
                <div class="strategy-card border-l-orange-500 bg-orange-50">
                    <span class="strategy-title text-orange-800">2. å›ºå®šé‡‘é¡æé ˜ (SWR)</span>
                    é¦–å¹´æé ˜4%ï¼Œå¾Œéš¨é€šè†¨èª¿æ•´ã€‚<br>
                    <span class="text-green-600 font-bold">å„ªé»ï¼š</span> ç”Ÿæ´»æœ€ç©©å®šã€‚<br>
                    <span class="text-red-500 font-bold">ç¼ºé»ï¼š</span> ç†Šå¸‚å¯èƒ½ç ´ç”¢ (æœ¬æ¨¡æ“¬æ³•)ã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">3. Vanguard å‹•æ…‹æ”¯å‡º</span>
                    è¨­å®šæé ˜ä¸Šä¸‹é™ (å¦‚ +5%/-2.5%)ã€‚<br>
                    <span class="text-blue-600 font-bold">å»ºè­°ï¼š</span> å¹³è¡¡å®‰å…¨èˆ‡ç©©å®šã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">4. Guyton-Klinger æ±ºç­–</span>
                    æé ˜ç‡ç•°å¸¸æ™‚å‡çµé€šè†¨èª¿æ•´ã€‚<br>
                    <span class="text-blue-600 font-bold">å»ºè­°ï¼š</span> é©åˆé«˜æ³¢å‹•çµ„åˆã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">5. 1/N æé ˜æ³•</span>
                    æ¯å¹´æé ˜ 1/å‰©é¤˜å£½å‘½ã€‚<br>
                    ç¢ºä¿æ­»å‰èŠ±å®Œã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">6. CAPE ä¼°å€¼èª¿æ•´</span>
                    ä¾å¸‚å ´è²´è³¤èª¿æ•´æé ˜ç‡ã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">7. VPW è®Šå‹•ç™¾åˆ†æ¯”</span>
                    çµåˆ1/Nèˆ‡ç¸¾æ•ˆï¼Œä¸ç ´ç”¢ä¸”èŠ±å®Œã€‚
                </div>
                <div class="strategy-card bg-white border border-blue-200 shadow-sm">
                    <span class="strategy-title text-center text-blue-700"><i class="fa-solid fa-lightbulb mr-1"></i> æ‚¨çš„çµ„åˆå»ºè­°</span>
                    <ul class="list-disc pl-4 mt-2 space-y-2 text-sm text-gray-700">
                        <li><strong>ç¾é‡‘ç·©è¡ï¼š</strong>è«‹ä¿ç•™è‡³å°‘ 2-3 å¹´ç”Ÿæ´»è²»åœ¨ç¾é‡‘éƒ¨ä½ã€‚</li>
                        <li><strong>å‹•æ…‹èª¿æ•´ï¼š</strong>è³‡ç”¢ä¸‹è·Œ 20% æ™‚ï¼Œæš«åœé€šè†¨èª¿æ•´ã€‚</li>
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <div id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        // --- Helper: å¤§é¡æ•¸å­—æ ¼å¼åŒ– ---
        const fmtMoney = (n) => {
            if (n === null || n === undefined) return "---";
            if (n <= 0) return "0 è¬"; // æ­¸é›¶é¡¯ç¤º
            const wan = n / 10000;
            if (wan >= 10000) {
                return (wan / 10000).toFixed(2).replace(/\.00$/, '').replace(/(\.\d)0$/, '$1') + " å„„";
            }
            return Math.round(wan).toLocaleString() + " è¬";
        };

        // --- Helper: ç¾é‡‘è¼¸å…¥æ¡†æ ¼å¼åŒ– (åŠ é€—è™Ÿ) ---
        function formatCashInput(input) {
            let val = input.value.replace(/[^\d.]/g, '');
            if(val) {
                input.value = parseFloat(val).toLocaleString('en-US');
            } else {
                input.value = "";
            }
        }

        // --- è¨­å®š ---
        Chart.defaults.font.family = "'Roboto', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif";
        Chart.register(ChartDataLabels);
        
        const API_PROXY = "https://corsproxy.io/?";
        const SYMBOLS = { AOA: "AOA", IMID: "IMID.L", TW: "00631L.TW" };
        let portfolioStats = { totalVal: 0, weightedReturn: 0.08, weightedVol: 0.15 }; 
        let countryChart = null, mcChart = null;

        // --- LocalStorage å­˜å– ---
        function saveData() {
            const data = {
                qtyAoa: document.getElementById('qty-aoa').value,
                qtyImid: document.getElementById('qty-imid').value,
                qtyTw: document.getElementById('qty-tw').value,
                valCash: document.getElementById('val-cash').value, 
                targetAoa: document.getElementById('target-aoa').value,
                targetImid: document.getElementById('target-imid').value,
                targetTw: document.getElementById('target-tw').value,
                targetCash: document.getElementById('target-cash').value,
                simYears: document.getElementById('sim-years').value,
                withdrawRate: document.getElementById('withdraw-rate').value,
                inflationRate: document.getElementById('inflation-rate').value,
                costDrag: document.getElementById('cost-drag').value,
                costAoa: document.getElementById('price-aoa').value, 
                costImid: document.getElementById('price-imid').value,
                costTw: document.getElementById('price-tw').value
            };
            localStorage.setItem('portfolioData', JSON.stringify(data));
            
            const x = document.getElementById("toast");
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        function loadData() {
            const saved = localStorage.getItem('portfolioData');
            if (saved) {
                const data = JSON.parse(saved);
                if(data.qtyAoa) document.getElementById('qty-aoa').value = data.qtyAoa;
                if(data.qtyImid) document.getElementById('qty-imid').value = data.qtyImid;
                if(data.qtyTw) document.getElementById('qty-tw').value = data.qtyTw;
                if(data.valCash) document.getElementById('val-cash').value = data.valCash;
                
                if(data.targetAoa) document.getElementById('target-aoa').value = data.targetAoa;
                if(data.targetImid) document.getElementById('target-imid').value = data.targetImid;
                if(data.targetTw) document.getElementById('target-tw').value = data.targetTw;
                if(data.targetCash) document.getElementById('target-cash').value = data.targetCash;

                if(data.simYears) document.getElementById('sim-years').value = data.simYears;
                if(data.withdrawRate) document.getElementById('withdraw-rate').value = data.withdrawRate;
                if(data.inflationRate) document.getElementById('inflation-rate').value = data.inflationRate;
                if(data.costDrag) document.getElementById('cost-drag').value = data.costDrag;
            }
        }

        // --- 1. åˆå§‹åŒ–åœ–è¡¨ ---
        function initCharts() {
            // åœ‹å®¶åˆ†ä½ˆ
            const ctxCountry = document.getElementById('countryChart').getContext('2d');
            countryChart = new Chart(ctxCountry, {
                type: 'pie', 
                data: {
                    labels: ['ç¾åœ‹', 'å°ç£', 'æ­æ´²', 'äºæ´²(ä¸å«å°ç£)', 'å…¶ä»–åœ‹å®¶', 'ç¾é‡‘'],
                    datasets: [{
                        data: [0,0,0,0,0,0],
                        backgroundColor: ['#2563eb', '#16a34a', '#9333ea', '#f59e0b', '#06b6d4', '#9ca3af'],
                        borderWidth: 2, borderColor: '#ffffff', hoverOffset: 10
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: { 
                        legend: { position: 'right', labels: { usePointStyle: true, font: { size: 12 } } },
                        datalabels: {
                            color: '#ffffff', font: { weight: '900', size: 14 },
                            formatter: (value, ctx) => {
                                let datasets = ctx.chart.data.datasets[0].data;
                                let sum = datasets.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum);
                                let sorted = [...datasets].sort((a,b) => b-a);
                                let threshold = sorted[2]; 
                                if (value >= threshold && percentage > 2) {
                                     return ctx.chart.data.labels[ctx.dataIndex] + "\n" + percentage.toFixed(1) + "%";
                                }
                                return "";
                            },
                            anchor: 'center', align: 'center', textAlign: 'center',
                            textShadowColor: 'rgba(0, 0, 0, 0.5)', textShadowBlur: 3
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    let value = context.raw || 0;
                                    let sum = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    let pct = (value * 100 / sum).toFixed(1) + "%";
                                    return `${label}: ${fmtMoney(value)} (${pct})`;
                                }
                            }
                        }
                    }
                }
            });

            // è’™åœ°å¡ç¾…
            const ctxMc = document.getElementById('mcChart').getContext('2d');
            mcChart = new Chart(ctxMc, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    elements: { point: { radius: 0, hitRadius: 10, hoverRadius: 5 } },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        // *** é—œéµä¿®æ­£ï¼šè‡ªå®šç¾©åœ–ä¾‹æ’åº (ä¿å®ˆ -> ä¸­ä½ -> æ¨‚è§€) ***
                        legend: { 
                            position: 'top', 
                            labels: { 
                                usePointStyle: true,
                                sort: function(a, b, data) {
                                    const specificOrder = [
                                        'ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)', 
                                        'ä¸­ä½è¶¨å‹¢ (é æœŸ)', 
                                        'æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)'
                                    ];
                                    return specificOrder.indexOf(a.text) - specificOrder.indexOf(b.text);
                                }
                            } 
                        },
                        datalabels: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937', bodyColor: '#1f2937',
                            borderColor: '#e5e7eb', borderWidth: 1, padding: 10,
                            // *** é—œéµä¿®æ­£ï¼šè‡ªå®šç¾© Tooltip æ’åº (é«˜ -> ä½) ***
                            itemSort: function(a, b) {
                                return b.raw - a.raw; // æ•¸å€¼å¤§åˆ°å°ï¼šæ¨‚è§€(ç´…) -> ä¸­ä½(è—) -> ä¿å®ˆ(ç¶ )
                            },
                            callbacks: {
                                title: function(tooltipItems) {
                                    const yearIndex = parseInt(tooltipItems[0].label);
                                    const currentYear = new Date().getFullYear();
                                    return `ç¬¬ ${yearIndex} å¹´ (${currentYear + yearIndex} å¹´)`;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += fmtMoney(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        },
                        zoom: {
                            zoom: {
                                wheel: { enabled: true }, pinch: { enabled: true },
                                drag: { enabled: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' },
                                mode: 'x',
                            },
                            pan: { enabled: true, mode: 'x' }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#f3f4f6' },
                            ticks: { 
                                callback: v => fmtMoney(v),
                                font: { family: 'Roboto Mono' }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function resetZoom() { if(mcChart) mcChart.resetZoom(); }

        // --- 2. è³‡æ–™è™•ç† ---
        const fmtNum = n => n ? Math.round(n).toLocaleString() : "0";
        const fmtPct = n => {
            if(n==null || isNaN(n)) return "---";
            return `<span class="${n>=0?'trend-up':'trend-down'}">${n>=0?'+':''}${n.toFixed(2)}%</span>`;
        };

        async function fetchYahooData(symbol) {
            const url = `${API_PROXY}https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=10y&interval=1d`;
            try {
                const res = await fetch(url);
                const json = await res.json();
                const result = json.chart.result[0];
                const quotes = result.indicators.quote[0].close;
                const timestamps = result.timestamp;
                const history = [];
                for(let i=0; i<timestamps.length; i++) {
                    if(quotes[i]!=null) history.push({date: new Date(timestamps[i]*1000), price: quotes[i]});
                }
                
                const prices = history.map(h => h.price);
                const annualReturn = (Math.pow(prices[prices.length-1]/prices[0], 1/(prices.length/252)) - 1);
                
                const returns = [];
                for(let i=1; i<prices.length; i++) returns.push(Math.log(prices[i]/prices[i-1]));
                const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
                const std = Math.sqrt(returns.map(x => Math.pow(x-mean, 2)).reduce((a,b)=>a+b,0)/returns.length);
                const annualVol = std * Math.sqrt(252);

                return {
                    price: result.meta.regularMarketPrice,
                    prevClose: history[history.length-2].price,
                    history: history,
                    stats: { return: annualReturn, vol: annualVol }
                };
            } catch (e) { console.error(e); return null; }
        }

        async function fetchAllData() {
            document.getElementById('status-msg').innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> æ›´æ–°ä¸­...';
            try {
                const r = await fetch("https://open.er-api.com/v6/latest/USD").then(r=>r.json());
                document.getElementById('usd-rate').value = r.rates.TWD.toFixed(2);
            } catch {}

            const [dA, dI, dT] = await Promise.all([
                fetchYahooData(SYMBOLS.AOA),
                fetchYahooData(SYMBOLS.IMID),
                fetchYahooData(SYMBOLS.TW)
            ]);
            window.assetData = { AOA: dA, IMID: dI, TW: dT };
            
            if(dA) { document.getElementById('price-aoa').value = dA.price.toFixed(2); renderRow('row-AOA', 'AOA', dA); }
            if(dI) { document.getElementById('price-imid').value = dI.price.toFixed(2); renderRow('row-IMID', 'IMID', dI); }
            if(dT) { document.getElementById('price-tw').value = dT.price.toFixed(2); renderRow('row-TW', '00631L', dT); }

            const now = new Date();
            const timeStr = now.toLocaleString('zh-TW', { hour12: false });
            document.getElementById('status-msg').innerHTML = 
                `<span class="text-green-600 text-xs"><i class="fa-solid fa-check mr-1"></i>å·²æ›´æ–° ${timeStr}</span>`;

            calculateAll();
        }

        function renderRow(id, name, data) {
            const p = data.price;
            const h = data.history;
            const chg = ((p - data.prevClose)/data.prevClose)*100;
            const getPerf = (days, isAnnualized = false) => {
                let d = new Date(); d.setDate(d.getDate()-days);
                let old = h.findLast(x => x.date <= d)?.price;
                if(!old) return null;
                if(isAnnualized) {
                    const years = days / 365;
                    return (Math.pow(p / old, 1 / years) - 1) * 100;
                } else {
                    return ((p-old)/old)*100;
                }
            };
            
            document.getElementById(id).innerHTML = `
                <td class="p-3 font-bold text-left text-gray-800 font-mono-num">${name}</td>
                <td class="p-3 font-mono font-bold text-gray-900">${p.toFixed(2)}</td>
                <td class="p-3 font-mono">${fmtPct(chg)}</td>
                <td class="p-3 text-gray-600 font-medium">${fmtPct(getPerf(7))}</td>
                <td class="p-3 text-gray-600 font-medium">${fmtPct(getPerf(30))}</td>
                <td class="p-3 text-gray-600 font-medium">${fmtPct(getPerf((new Date()-new Date(new Date().getFullYear(),0,1))/86400000))}</td>
                <td class="p-3 bg-orange-50/50 font-medium">${fmtPct(getPerf(365, true))}</td>
                <td class="p-3 bg-orange-50/50 font-medium">${fmtPct(getPerf(365*3, true))}</td>
                <td class="p-3 bg-orange-50/50 font-medium">${fmtPct(getPerf(365*5, true))}</td>
                <td class="p-3 bg-orange-50/50 font-medium">${fmtPct(getPerf(365*10, true))}</td>
            `;
        }

        function calculateAll() {
            const usd = parseFloat(document.getElementById('usd-rate').value)||32.5;
            const getVal = (id) => parseFloat(document.getElementById(id).value)||0;
            const qA=getVal('qty-aoa'), pA=getVal('price-aoa'), tA=getVal('target-aoa');
            const qI=getVal('qty-imid'), pI=getVal('price-imid'), tI=getVal('target-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw'), tT=getVal('target-tw');
            
            // ç¾é‡‘è™•ç†ï¼šç§»é™¤é€—è™Ÿ
            const valCashRaw = document.getElementById('val-cash').value.replace(/,/g, '');
            const vCash = parseFloat(valCashRaw) || 0;
            const tCash = getVal('target-cash');

            const vA = Math.round(qA*pA*usd);
            const vI = Math.round(qI*pI*usd);
            const vT = Math.round(qT*pT);
            const total = vA+vI+vT+vCash;

            document.getElementById('val-aoa').value = fmtNum(vA);
            document.getElementById('val-imid').value = fmtNum(vI);
            document.getElementById('val-tw').value = fmtNum(vT);
            document.getElementById('total-assets').innerText = fmtNum(total);

            const updateAct = (id, cur, tgtPct, price, isCash=false) => {
                const diff = (total*(tgtPct/100)) - cur;
                let actionText = "-";
                
                if (isCash) {
                    if (Math.abs(diff) > 1) {
                        const type = diff > 0 ? "å­˜" : "å–";
                        actionText = `<span class="${diff>0?'text-red-500':'text-green-600'}">${type} ${fmtNum(Math.abs(diff))} å…ƒ</span>`;
                    }
                } else {
                    if (price > 0) {
                        const shares = Math.round(diff/price);
                        if (shares !== 0) {
                            const type = shares > 0 ? "è²·" : "è³£";
                            actionText = `<span class="${shares>0?'text-red-500':'text-green-600'}">${type} ${fmtNum(Math.abs(shares))} è‚¡</span>`;
                        }
                    }
                }
                document.getElementById(id).innerHTML = actionText;
            };

            updateAct('act-aoa', vA, tA, pA*usd);
            updateAct('act-imid', vI, tI, pI*usd);
            updateAct('act-tw', vT, tT, pT);
            updateAct('act-cash', vCash, tCash, 1, true);

            const sA = window.assetData?.AOA?.stats || {return:0.08, vol:0.12};
            const sI = window.assetData?.IMID?.stats || {return:0.09, vol:0.20};
            const sT_raw = window.assetData?.TW?.stats || {return:0.25, vol:0.50};
            const sT = { return: sT_raw.return * 0.7, vol: sT_raw.vol }; 
            
            const wA = tA/100, wI = tI/100, wT = tT/100, wC = tCash/100;
            const portRet = (wA*sA.return) + (wI*sI.return) + (wT*sT.return) + (wC*0.01);
            const portVol = (wA*sA.vol) + (wI*sI.vol) + (wT*sT.vol); 
            portfolioStats = { totalVal: total, weightedReturn: portRet, weightedVol: portVol };
            
            const expUS = (vA * 0.60) + (vI * 0.58);
            const expTW = (vA * 0.01) + (vI * 0.02) + (vT * 2); 
            const expEU = (vA * 0.15) + (vI * 0.16);
            const expAsia = (vA * 0.15) + (vI * 0.17); 
            const expOther = (vA * 0.09) + (vI * 0.07);
            const expCash = vCash;

            if(countryChart) {
                countryChart.data.datasets[0].data = [
                    expUS, expTW, expEU, expAsia, expOther, expCash
                ];
                countryChart.update();
            }

            runMonteCarlo();
        }

        function runMonteCarlo() {
            const years = parseInt(document.getElementById('sim-years').value) || 45;
            const ratePct = parseFloat(document.getElementById('withdraw-rate').value) || 4.0;
            const inflationRate = parseFloat(document.getElementById('inflation-rate').value) || 3.0;
            const costDrag = parseFloat(document.getElementById('cost-drag').value) || 1.5;
            const startVal = portfolioStats.totalVal;
            
            if(startVal === 0) return;

            const firstWithdrawal = Math.round(startVal * (ratePct / 100));
            document.getElementById('withdraw-amt').innerText = Math.round(firstWithdrawal/10000).toLocaleString();

            const simulations = 10000;
            const mu = portfolioStats.weightedReturn - (costDrag / 100);
            const sigma = portfolioStats.weightedVol;
            const inf = inflationRate / 100;

            const yearlyData = new Array(years + 1).fill(0).map(() => []);
            let successCount = 0;

            for(let i=0; i<simulations; i++) {
                let currentWealth = startVal;
                let annualWithdrawal = firstWithdrawal;
                let alive = true;
                yearlyData[0].push(currentWealth);

                for(let y=1; y<=years; y++) {
                    if(!alive) { yearlyData[y].push(0); continue; }
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                    const r = mu - 0.5 * sigma * sigma + sigma * z;
                    const ret = Math.exp(r);
                    currentWealth = currentWealth * ret;
                    currentWealth -= annualWithdrawal;
                    annualWithdrawal *= (1 + inf);
                    if(currentWealth < 0) { currentWealth = 0; alive = false; }
                    yearlyData[y].push(currentWealth);
                }
                if(alive) successCount++;
            }

            const pLow=[], p50=[], pHigh=[];
            for(let y=0; y<=years; y++) {
                yearlyData[y].sort((a,b) => a-b);
                // 12.5% ~ 87.5% (75% confidence interval)
                pLow.push(yearlyData[y][Math.floor(simulations * 0.125)]);
                p50.push(yearlyData[y][Math.floor(simulations * 0.50)]);
                pHigh.push(yearlyData[y][Math.floor(simulations * 0.875)]);
            }

            const sr = successCount / simulations;
            const rateEl = document.getElementById('success-rate');
            rateEl.innerText = (sr*100).toFixed(1) + "%";
            rateEl.className = sr < 0.75 ? "text-2xl font-bold text-red-600 font-mono-num" : (sr < 0.90 ? "text-2xl font-bold text-yellow-600 font-mono-num" : "text-2xl font-bold text-green-600 font-mono-num");

            document.getElementById('res-low').innerText = fmtMoney(pLow[years]);
            document.getElementById('res-p50').innerText = fmtMoney(p50[years]);
            document.getElementById('res-high').innerText = fmtMoney(pHigh[years]);

            // Zero Ruin Alert
            const zeroWarning = document.getElementById('zero-warning');
            if (pLow[years] <= 0) {
                zeroWarning.classList.remove('hidden');
            } else {
                zeroWarning.classList.add('hidden');
            }

            updateMcChart(years, pLow, p50, pHigh);
        }

        function updateMcChart(years, pLow, p50, pHigh) {
            const labels = Array.from({length: years+1}, (_, i) => i);
            mcChart.data.labels = labels;
            mcChart.data.datasets = [
                // 1. ä¿å®ˆ (åº•å±¤ç¶ ç·š)
                { 
                    label: 'ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)', 
                    data: pLow, 
                    borderColor: 'rgba(22, 163, 74, 0.8)', 
                    borderWidth: 2,
                    fill: false, 
                    pointRadius: 0 
                },
                // 2. æ¨‚è§€ (å¡«æ»¿è‡³ä¿å®ˆ)
                { 
                    label: 'æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)', 
                    data: pHigh, 
                    borderColor: 'rgba(239, 68, 68, 0.8)', 
                    backgroundColor: 'rgba(253, 224, 71, 0.4)', 
                    borderWidth: 2,
                    fill: '-1', 
                    pointRadius: 0 
                },
                // 3. ä¸­ä½ (æœ€ä¸Šå±¤è—ç·š)
                { 
                    label: 'ä¸­ä½è¶¨å‹¢ (é æœŸ)', 
                    data: p50, 
                    borderColor: '#2563eb', 
                    borderWidth: 3,
                    fill: false, 
                    pointRadius: 0 
                }
            ];
            mcChart.resetZoom();
            mcChart.update();
        }

        window.onload = function() {
            loadData();
            initCharts();
            fetchAllData();
        };
    </script>
</body>
</html>