<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ & è’™åœ°å¡ç¾…é€€ä¼‘æ¨¡æ“¬ (å°ˆæ¥­ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Zoom Plugin éœ€è¦ Hammer.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: system-ui, -apple-system, sans-serif; background-color: #f3f4f6; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 20px; border: 1px solid #e5e7eb; }
        .input-val { width: 100%; padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 6px; text-align: right; font-weight: bold; font-family: monospace; }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        .calc-val { border: none; background: transparent; text-align: right; font-family: monospace; color: #374151; width: 100%; }
        .trend-up { color: #dc2626; font-weight: 600; }
        .trend-down { color: #16a34a; font-weight: 600; }
        .strategy-card { border-left: 4px solid #3b82f6; background: #f8fafc; padding: 15px; margin-bottom: 10px; border-radius: 8px; font-size: 0.9rem; }
        .strategy-title { font-weight: bold; color: #1e40af; display: block; margin-bottom: 4px; font-size: 1rem; }
    </style>
</head>
<body class="pb-20 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬</h1>
                <div class="flex gap-2 mt-1">
                    <button onclick="fetchAllData()" class="text-xs bg-blue-100 hover:bg-blue-200 text-blue-700 px-2 py-1 rounded transition">
                        <i class="fa-solid fa-sync-alt mr-1"></i>åˆ·æ–°å ±åƒ¹
                    </button>
                    <span id="status-msg" class="text-xs text-gray-500 flex items-center"></span>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-right border-r pr-6 border-gray-200">
                    <div class="text-xs text-gray-500">USD/TWD åŒ¯ç‡</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-xl font-bold text-blue-600 font-mono w-24 text-right bg-transparent border-none focus:ring-0" onchange="calculateAll()">
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500">ç›®å‰å¸³é¢ç¸½è³‡ç”¢ (TWD)</div>
                    <div class="text-3xl font-bold text-gray-800 font-mono" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-6">

        <!-- 1. å°ç£çµ±è¨ˆæ•¸æ“š (ç²¾ç°¡ç‰ˆ) -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="card border-l-4 border-purple-500 flex justify-between items-center py-4">
                <div>
                    <div class="text-xs text-gray-500">ğŸ‡¹ğŸ‡¼ å®¶åº­å¯æ”¯é…æ‰€å¾— (ä¸­ä½æ•¸)</div>
                    <div class="text-xs text-gray-400">ä¸»è¨ˆç¸½è™• 112å¹´</div>
                </div>
                <div class="text-xl font-bold text-purple-700">113.7 è¬</div>
            </div>
            <div class="card border-l-4 border-indigo-500 flex justify-between items-center py-4">
                <div>
                    <div class="text-xs text-gray-500">ğŸ‡¹ğŸ‡¼ ç”·æ€§å¹³å‡é¤˜å‘½ (1987å¹´ç”Ÿä¼°ç®—)</div>
                    <div class="text-xs text-gray-400">å…§æ”¿éƒ¨æ•¸æ“š + å¥åº·èª¿æ•´</div>
                </div>
                <div class="text-xl font-bold text-indigo-700">ç´„ 83 æ­²</div>
            </div>
        </section>

        <!-- 2. è³‡ç”¢é…ç½®èˆ‡å€åŸŸæ›éšª -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- å·¦å´ï¼šè³‡ç”¢æ˜ç´° -->
            <div class="card lg:col-span-2 overflow-x-auto">
                <h2 class="text-lg font-bold text-gray-800 mb-4">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <table class="w-full min-w-[600px] text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 border-b">
                            <th class="p-2 text-left">æ¨™çš„</th>
                            <th class="p-2 text-right">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                            <th class="p-2 text-right w-24">å¸‚åƒ¹ (åŸå¹£)</th>
                            <th class="p-2 text-right">å¸‚å€¼ (TWD)</th>
                            <th class="p-2 text-right bg-blue-50 w-20">ç›®æ¨™%</th>
                            <th class="p-2 text-right bg-blue-50">å»ºè­°æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        <!-- AOA -->
                        <tr>
                            <td class="p-2 font-bold text-blue-700">AOA <span class="text-xs font-normal text-gray-400 block">ç¾è‚¡ ETF</span></td>
                            <td class="p-2"><input type="number" id="qty-aoa" value="2180" class="input-val" oninput="calculateAll()"></td>
                            <td class="p-2"><input type="number" id="price-aoa" value="0" step="0.01" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-2"><input type="text" id="val-aoa" readonly class="calc-val"></td>
                            <td class="p-2 bg-blue-50"><input type="number" id="target-aoa" value="25" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-2 text-right font-bold bg-blue-50" id="act-aoa">-</td>
                        </tr>
                        <!-- IMID -->
                        <tr>
                            <td class="p-2 font-bold text-purple-700">IMID <span class="text-xs font-normal text-gray-400 block">è‹±è‚¡ (USDè¨ˆåƒ¹)</span></td>
                            <td class="p-2"><input type="number" id="qty-imid" value="0" class="input-val" oninput="calculateAll()"></td>
                            <td class="p-2"><input type="number" id="price-imid" value="0" step="0.01" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-2"><input type="text" id="val-imid" readonly class="calc-val"></td>
                            <td class="p-2 bg-blue-50"><input type="number" id="target-imid" value="25" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-2 text-right font-bold bg-blue-50" id="act-imid">-</td>
                        </tr>
                        <!-- 00631L -->
                        <tr>
                            <td class="p-2 font-bold text-green-700">00631L <span class="text-xs font-normal text-gray-400 block">å…ƒå¤§å°ç£50æ­£2</span></td>
                            <td class="p-2"><input type="number" id="qty-tw" value="15500" class="input-val" oninput="calculateAll()"></td>
                            <td class="p-2"><input type="number" id="price-tw" value="0" step="0.01" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-2"><input type="text" id="val-tw" readonly class="calc-val"></td>
                            <td class="p-2 bg-blue-50"><input type="number" id="target-tw" value="25" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-2 text-right font-bold bg-blue-50" id="act-tw">-</td>
                        </tr>
                        <!-- Cash -->
                        <tr class="bg-gray-50">
                            <td class="p-2 font-bold text-gray-600">ç¾é‡‘ <span class="text-xs font-normal text-gray-400 block">TWD</span></td>
                            <td class="p-2"><input type="number" id="val-cash" value="3000000" class="input-val font-bold" oninput="calculateAll()"></td>
                            <td class="p-2 text-center text-gray-300">-</td>
                            <td class="p-2 text-right text-gray-400">-</td>
                            <td class="p-2 bg-blue-50"><input type="number" id="target-cash" value="25" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-2 text-right font-bold bg-blue-50 text-gray-600" id="act-cash">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- å³å´ï¼šåœ‹å®¶æ›éšª (æ–°åŠŸèƒ½) -->
            <div class="card flex flex-col">
                <h3 class="text-sm font-bold text-gray-600 mb-3"><i class="fa-solid fa-globe mr-1"></i>é ä¼°æŠ•è³‡å€åŸŸæ›éšª (Top 5)</h3>
                <div class="flex-grow flex items-center justify-center">
                    <canvas id="countryChart"></canvas>
                </div>
                <div class="text-[10px] text-gray-400 mt-2 text-center">
                    * åŸºæ–¼ ETF æŒè‚¡æ¬Šé‡ä¼°ç®— (00631Lè¦–ç‚º100%å°ç£, AOA/IMIDåƒè€ƒMSCIæ¬Šé‡)
                </div>
            </div>
        </div>

        <!-- 3. å¸‚å ´è¡¨ç¾çœ‹æ¿ -->
        <div class="card overflow-hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-4">å¸‚å ´è¡¨ç¾çœ‹æ¿ (æ­·å²æ•¸æ“š)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-center border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 border-b-2 border-gray-200">
                            <th class="p-3 text-left">æ¨™çš„</th>
                            <th class="p-3">æœ€æ–°åƒ¹</th>
                            <th class="p-3">ä»Šæ—¥æ¼²è·Œ</th>
                            <th class="p-3">è¿‘1é€±</th>
                            <th class="p-3">è¿‘1æœˆ</th>
                            <th class="p-3">YTD</th>
                            <th class="p-3 bg-orange-50">1å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50">3å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50">5å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50">10å¹´ (å¹´åŒ–)</th>
                        </tr>
                    </thead>
                    <tbody id="perf-body" class="divide-y divide-gray-100">
                        <tr id="row-AOA"><td colspan="10" class="p-4 italic text-gray-400">Loading...</td></tr>
                        <tr id="row-IMID"><td colspan="10" class="p-4 italic text-gray-400">Loading...</td></tr>
                        <tr id="row-TW"><td colspan="10" class="p-4 italic text-gray-400">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr class="border-gray-300 my-8">

        <!-- 4. è’™åœ°å¡ç¾…æ¨¡æ“¬å€å¡Š -->
        <section class="space-y-6">
            <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-dice text-blue-600 mr-2"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬</h2>
                <div class="text-sm text-gray-500">æ¨¡æ“¬ 10,000 æ¬¡ | æ‰£é™¤æ¯å¹´æé ˜ | è€ƒæ…®è³‡ç”¢æ³¢å‹•</div>
            </div>

            <!-- æ¨¡æ“¬åƒæ•¸è¨­å®š -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- åƒæ•¸1 -->
                <div class="card border-t-4 border-blue-500 p-4">
                    <h3 class="text-xs text-gray-500 font-bold mb-1">é€€ä¼‘ç”Ÿæ´»å¹´æ•¸</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="sim-years" value="45" class="text-xl font-bold text-gray-800 w-16 border-b border-gray-300 text-center focus:outline-none" onchange="runMonteCarlo()">
                        <span class="text-sm text-gray-600">å¹´</span>
                    </div>
                </div>
                <!-- åƒæ•¸2 -->
                <div class="card border-t-4 border-orange-500 p-4">
                    <h3 class="text-xs text-gray-500 font-bold mb-1">é¦–å¹´æé ˜ç‡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="withdraw-rate" value="4.0" step="0.1" class="text-xl font-bold text-orange-600 w-16 border-b border-gray-300 text-center focus:outline-none" onchange="runMonteCarlo()">
                        <span class="text-sm text-gray-600">%</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-1">é¦–å¹´ç´„ <span id="withdraw-amt">0</span> è¬</div>
                </div>
                <!-- åƒæ•¸3 (æ–°åŠŸèƒ½ï¼šé€šè†¨) -->
                <div class="card border-t-4 border-red-500 p-4">
                    <h3 class="text-xs text-gray-500 font-bold mb-1">é ä¼°å¹´é€šè†¨ç‡</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" id="inflation-rate" value="3.0" step="0.1" class="text-xl font-bold text-red-600 w-16 border-b border-gray-300 text-center focus:outline-none" onchange="runMonteCarlo()">
                        <span class="text-sm text-gray-600">%</span>
                    </div>
                </div>
                <!-- çµæœ -->
                <div class="card border-t-4 border-green-500 bg-green-50 p-4">
                    <h3 class="text-xs text-green-800 font-bold mb-1">ç´¯ç©è³‡ç”¢æˆåŠŸç‡</h3>
                    <div class="text-3xl font-bold text-green-600" id="success-rate">---%</div>
                </div>
            </div>

            <!-- æ¨¡æ“¬åœ–è¡¨ (å« Zoom) -->
            <div class="card relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">æœ€çµ‚è³‡ç”¢åˆ†å¸ƒæ¨¡æ“¬ (æ‰£é™¤æé ˜å¾Œ)</h3>
                    <button onclick="resetZoom()" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 py-1 rounded transition">
                        <i class="fa-solid fa-magnifying-glass-minus mr-1"></i>é‡ç½®ç¸®æ”¾
                    </button>
                </div>
                <div class="h-96 w-full">
                    <canvas id="mcChart"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-4 text-center text-sm border-t pt-4">
                    <div>
                        <div class="text-gray-500 text-xs">è¼ƒå·®çš„æƒ…æ³ (P25)</div>
                        <div class="font-bold text-green-600 text-lg" id="res-p25">---</div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs">ä¸­ä½æ•¸ (P50)</div>
                        <div class="font-bold text-blue-600 text-lg" id="res-p50">---</div>
                    </div>
                    <div>
                        <div class="text-gray-500 text-xs">è¼ƒå¥½çš„æƒ…æ³ (P75)</div>
                        <div class="font-bold text-red-500 text-lg" id="res-p75">---</div>
                    </div>
                </div>
                <div class="mt-2 text-center text-[10px] text-gray-400">
                    <i class="fa-solid fa-hand-pointer mr-1"></i> æ‚¨å¯ä»¥ç”¨æ»‘é¼ åœ¨åœ–è¡¨ä¸Š<b>æ‹–æ›³é¸å–</b>ä»¥æ”¾å¤§ç‰¹å®šå€é–“ (ä¾‹å¦‚æŸ¥çœ‹æœ€å¾Œ10å¹´)ï¼Œæˆ–æŒ‰é‡ç½®æŒ‰éˆ•é‚„åŸã€‚
                </div>
            </div>
        </section>

        <!-- 5. æé ˜ç­–ç•¥å»ºè­° -->
        <section class="card bg-gray-50">
            <h2 class="text-xl font-bold text-gray-800 mb-4">æé ˜ç­–ç•¥ç¸½çµèˆ‡å»ºè­°</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="strategy-card">
                    <span class="strategy-title">1. å›ºå®šç™¾åˆ†æ¯”æé ˜ (4%)</span>
                    æ¯å¹´æé ˜ç•¶ä¸‹è³‡ç”¢çš„ 4%ã€‚<br>
                    <span class="text-green-600">å„ªé»ï¼š</span> æ°¸é ä¸æœƒç ´ç”¢ã€‚<br>
                    <span class="text-red-500">ç¼ºé»ï¼š</span> å¸‚å ´å¤§è·Œæ™‚ï¼Œç”Ÿæ´»è²»æœƒåŠ‡çƒˆç¸®æ°´ï¼Œç”Ÿæ´»å“è³ªä¸ç©©ã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">2. å›ºå®šé‡‘é¡æé ˜ (SWR)</span>
                    é¦–å¹´æé ˜ 4%ï¼Œä¹‹å¾Œæ¯å¹´éš¨é€šè†¨èª¿æ•´é‡‘é¡ (æœ¬æ¬¡æ¨¡æ“¬ä½¿ç”¨æ­¤æ³•)ã€‚<br>
                    <span class="text-green-600">å„ªé»ï¼š</span> ç”Ÿæ´»å“è³ªæœ€ç©©å®šã€‚<br>
                    <span class="text-red-500">ç¼ºé»ï¼š</span> è‹¥é‡é•·æœŸç†Šå¸‚ï¼Œè³‡ç”¢æœ‰æ­¸é›¶é¢¨éšªã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">3. Vanguard å‹•æ…‹æ”¯å‡º</span>
                    è¨­å®šæé ˜ä¸Šä¸‹é™ (ä¾‹å¦‚æ¼²ä¸è¶…é5%ï¼Œè·Œä¸è¶…é2.5%)ã€‚<br>
                    <span class="text-blue-600">å»ºè­°ï¼š</span> å¹³è¡¡äº†è³‡ç”¢å®‰å…¨èˆ‡ç”Ÿæ´»è²»çš„ç©©å®šæ€§ã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">4. Guyton-Klinger æ±ºç­–</span>
                    ç•¶æé ˜ç‡å‡å¤ªé«˜æ™‚ (è³‡ç”¢ç¸®æ°´)ï¼Œå‡çµé€šè†¨èª¿æ•´æˆ–æ¸›è–ª 10%ã€‚<br>
                    <span class="text-blue-600">å»ºè­°ï¼š</span> å°æ–¼é«˜æ³¢å‹•çµ„åˆ (å¦‚æ‚¨æŒæœ‰æ­£2) éå¸¸æœ‰æ•ˆã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">5. 1/N æé ˜æ³•</span>
                    æ¯å¹´æé ˜ 1 / (å‰©é¤˜é æœŸå£½å‘½)ã€‚<br>
                    éš¨è‘—å¹´é½¡å¢é•·æé ˜æ¯”ä¾‹å¢åŠ ï¼Œç¢ºä¿æ­»å‰èŠ±å®Œã€‚<br>
                    <span class="text-gray-500">é©åˆï¼š</span> æ²’æœ‰éºç”¢å‹•æ©Ÿè€…ã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">6. CAPE ä¼°å€¼èª¿æ•´</span>
                    æ ¹æ“šå¸‚å ´æœ¬ç›Šæ¯” (CAPE) èª¿æ•´æé ˜ç‡ã€‚<br>
                    å¸‚å ´è²´æ™‚å°‘é ˜ï¼Œä¾¿å®œæ™‚å¤šé ˜ã€‚<br>
                    <span class="text-gray-500">é©åˆï¼š</span> é€²éšæŠ•è³‡äººã€‚
                </div>
                <div class="strategy-card">
                    <span class="strategy-title">7. VPW è®Šå‹•ç™¾åˆ†æ¯”</span>
                    çµåˆ 1/N èˆ‡æŠ•è³‡ç¸¾æ•ˆçš„å„ªåŒ–ç‰ˆã€‚<br>
                    ä¸æœƒç ´ç”¢ä¸”èƒ½èŠ±æ‰å¤§éƒ¨åˆ†è³‡ç”¢ï¼Œä½†ç¾é‡‘æµæ³¢å‹•å¤§ã€‚
                </div>
                <div class="strategy-card bg-white border border-blue-200">
                    <span class="strategy-title text-center text-blue-700">ğŸ’¡ æ‚¨çš„çµ„åˆå»ºè­°</span>
                    <p class="mt-2 text-gray-700 text-sm">æ‚¨çš„çµ„åˆ (00631L + IMID) æ³¢å‹•è¼ƒå¤§ã€‚</p>
                    <ul class="list-disc pl-4 mt-2 space-y-1 text-sm">
                        <li><strong>ç¾é‡‘ç·©è¡ï¼š</strong>è«‹ä¿ç•™è‡³å°‘ 2-3 å¹´ç”Ÿæ´»è²»åœ¨ç¾é‡‘éƒ¨ä½ (TWD)ï¼Œé¿å…åœ¨è‚¡å¸‚å¤§è·Œæ™‚è¢«è¿«è³£å‡ºæ­£2ã€‚</li>
                        <li><strong>å‹•æ…‹èª¿æ•´ï¼š</strong>è‹¥è³‡ç”¢ä¸‹è·Œè¶…é 20%ï¼Œå»ºè­°ç•¶å¹´æš«åœé€šè†¨èª¿æ•´ï¼Œæˆ–æ¸›å°‘æé ˜ 10%ã€‚</li>
                    </ul>
                </div>
            </div>
        </section>

    </main>

    <script>
        // --- è¨­å®š ---
        Chart.register(ChartDataLabels);
        const API_PROXY = "https://corsproxy.io/?";
        const SYMBOLS = { AOA: "AOA", IMID: "IMID.L", TW: "00631L.TW" };
        
        // å…¨å±€è®Šæ•¸
        let portfolioStats = { totalVal: 0, weightedReturn: 0.08, weightedVol: 0.15 }; 
        let countryExposure = { US: 0, TW: 0, Other: 0 };
        let mcChart = null, countryChart = null;

        // --- 1. åœ–è¡¨åˆå§‹åŒ– ---
        function initCharts() {
            // åœ‹å®¶åˆ†ä½ˆæŸ±ç‹€åœ– (Top 5)
            const ctxCountry = document.getElementById('countryChart').getContext('2d');
            countryChart = new Chart(ctxCountry, {
                type: 'bar',
                data: {
                    labels: ['ç¾åœ‹', 'å°ç£', 'å…¶ä»–æˆç†Ÿ', 'æ–°èˆˆå¸‚å ´', 'ç¾é‡‘'],
                    datasets: [{
                        label: 'è³‡ç”¢é…ç½® %',
                        data: [0,0,0,0,0],
                        backgroundColor: ['#3b82f6', '#10b981', '#6366f1', '#f59e0b', '#d1d5db'],
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // æ©«å‘æŸ±ç‹€åœ–
                    maintainAspectRatio: false,
                    scales: { x: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });

            // è’™åœ°å¡ç¾…åœ–
            const ctxMc = document.getElementById('mcChart').getContext('2d');
            mcChart = new Chart(ctxMc, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    elements: { point: { radius: 0, hitRadius: 10, hoverRadius: 5 } },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: { display: false },
                        tooltip: {
                            callbacks: {
                                // ç§»é™¤å°æ•¸é»ï¼ŒåŠ ä¸Š "è¬"
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += Math.round(context.parsed.y / 10000).toLocaleString() + ' è¬';
                                    }
                                    return label;
                                }
                            }
                        },
                        // Zoom æ’ä»¶è¨­å®š
                        zoom: {
                            zoom: {
                                wheel: { enabled: true }, // å…è¨±æ»¾è¼ªç¸®æ”¾ (éœ€æŒ‰ Ctrl)
                                pinch: { enabled: true },
                                drag: { enabled: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }, // å…è¨±æ‹–æ›³æ¡†é¸
                                mode: 'x',
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            grid: { color: '#f3f4f6' },
                            ticks: { 
                                callback: v => (v/10000).toFixed(0) + "è¬" // Yè»¸åˆ»åº¦
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function resetZoom() {
            if(mcChart) mcChart.resetZoom();
        }

        // --- 2. è³‡æ–™è™•ç† ---
        const fmtNum = n => n ? Math.round(n).toLocaleString() : "0";
        const fmtPct = n => {
            if(n==null || isNaN(n)) return "---";
            return `<span class="${n>=0?'trend-up':'trend-down'}">${n>=0?'+':''}${n.toFixed(2)}%</span>`;
        };

        async function fetchYahooData(symbol) {
            const url = `${API_PROXY}https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=10y&interval=1d`;
            try {
                const res = await fetch(url);
                const json = await res.json();
                const result = json.chart.result[0];
                const quotes = result.indicators.quote[0].close;
                const timestamps = result.timestamp;
                const history = [];
                for(let i=0; i<timestamps.length; i++) {
                    if(quotes[i]!=null) history.push({date: new Date(timestamps[i]*1000), price: quotes[i]});
                }
                
                // è¨ˆç®—åƒæ•¸
                const prices = history.map(h => h.price);
                const annualReturn = (Math.pow(prices[prices.length-1]/prices[0], 1/(prices.length/252)) - 1);
                
                // æ³¢å‹•ç‡
                const returns = [];
                for(let i=1; i<prices.length; i++) returns.push(Math.log(prices[i]/prices[i-1]));
                const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
                const std = Math.sqrt(returns.map(x => Math.pow(x-mean, 2)).reduce((a,b)=>a+b,0)/returns.length);
                const annualVol = std * Math.sqrt(252);

                return {
                    price: result.meta.regularMarketPrice,
                    prevClose: history[history.length-2].price,
                    history: history,
                    stats: { return: annualReturn, vol: annualVol }
                };
            } catch (e) { console.error(e); return null; }
        }

        async function fetchAllData() {
            document.getElementById('status-msg').innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
            
            try {
                const r = await fetch("https://open.er-api.com/v6/latest/USD").then(r=>r.json());
                document.getElementById('usd-rate').value = r.rates.TWD.toFixed(2);
            } catch {}

            const [dA, dI, dT] = await Promise.all([
                fetchYahooData(SYMBOLS.AOA),
                fetchYahooData(SYMBOLS.IMID),
                fetchYahooData(SYMBOLS.TW)
            ]);

            window.assetData = { AOA: dA, IMID: dI, TW: dT };
            
            if(dA) { document.getElementById('price-aoa').value = dA.price.toFixed(2); renderRow('row-AOA', 'AOA', dA); }
            if(dI) { document.getElementById('price-imid').value = dI.price.toFixed(2); renderRow('row-IMID', 'IMID', dI); }
            if(dT) { document.getElementById('price-tw').value = dT.price.toFixed(2); renderRow('row-TW', '00631L', dT); }

            document.getElementById('status-msg').innerHTML = '';
            calculateAll();
        }

        function renderRow(id, name, data) {
            const p = data.price;
            const h = data.history;
            const chg = ((p - data.prevClose)/data.prevClose)*100;
            const getPerf = (days) => {
                let d = new Date(); d.setDate(d.getDate()-days);
                let old = h.findLast(x => x.date <= d)?.price;
                return old ? ((p-old)/old)*100 : null;
            };
            
            document.getElementById(id).innerHTML = `
                <td class="p-3 font-bold text-left">${name}</td>
                <td class="p-3 font-mono font-bold">${p.toFixed(2)}</td>
                <td class="p-3 font-mono">${fmtPct(chg)}</td>
                <td class="p-3 text-gray-600">${fmtPct(getPerf(7))}</td>
                <td class="p-3 text-gray-600">${fmtPct(getPerf(30))}</td>
                <td class="p-3 text-gray-600">${fmtPct(getPerf((new Date()-new Date(new Date().getFullYear(),0,1))/86400000))}</td>
                <td class="p-3 bg-orange-50">${fmtPct(getPerf(365))}</td>
                <td class="p-3 bg-orange-50">${fmtPct(getPerf(365*3))}</td>
                <td class="p-3 bg-orange-50">${fmtPct(getPerf(365*5))}</td>
                <td class="p-3 bg-orange-50">${fmtPct(getPerf(365*10))}</td>
            `;
        }

        function calculateAll() {
            const usd = parseFloat(document.getElementById('usd-rate').value)||32.5;
            
            const getVal = (id) => parseFloat(document.getElementById(id).value)||0;
            const qA=getVal('qty-aoa'), pA=getVal('price-aoa'), tA=getVal('target-aoa');
            const qI=getVal('qty-imid'), pI=getVal('price-imid'), tI=getVal('target-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw'), tT=getVal('target-tw');
            const vCash=getVal('val-cash'), tCash=getVal('target-cash');

            const vA = Math.round(qA*pA*usd);
            const vI = Math.round(qI*pI*usd);
            const vT = Math.round(qT*pT);
            const total = vA+vI+vT+vCash;

            document.getElementById('val-aoa').value = fmtNum(vA);
            document.getElementById('val-imid').value = fmtNum(vI);
            document.getElementById('val-tw').value = fmtNum(vT);
            document.getElementById('total-assets').innerText = fmtNum(total);

            // å»ºè­°æ“ä½œ
            const updateAct = (id, cur, tgtPct, price) => {
                const diff = (total*(tgtPct/100)) - cur;
                const shares = price>0 ? Math.round(diff/price) : 0;
                const el = document.getElementById(id);
                if(shares===0) { el.innerText="-"; el.className="p-2 text-right bg-blue-50 text-gray-400"; }
                else {
                    el.innerHTML = `<span class="${shares>0?'text-red-500':'text-green-600'}">${shares>0?'è²·':'è³£'} ${fmtNum(Math.abs(shares))}</span>`;
                }
            };
            updateAct('act-aoa', vA, tA, pA*usd);
            updateAct('act-imid', vI, tI, pI*usd);
            updateAct('act-tw', vT, tT, pT);
            const cashDiff = (total*(tCash/100)) - vCash;
            document.getElementById('act-cash').innerHTML = `<span class="${cashDiff>0?'text-red-500':'text-green-600'}">${cashDiff>0?'å­˜':'å–'} ${fmtNum(Math.abs(cashDiff))}</span>`;

            // è¨ˆç®—çµ„åˆåƒæ•¸
            const sA = window.assetData?.AOA?.stats || {return:0.08, vol:0.12};
            const sI = window.assetData?.IMID?.stats || {return:0.09, vol:0.20};
            const sT = window.assetData?.TW?.stats || {return:0.25, vol:0.50};
            
            const wA = vA/total, wI = vI/total, wT = vT/total, wC = vCash/total;
            const portRet = (wA*sA.return) + (wI*sI.return) + (wT*sT.return) + (wC*0.01);
            const portVol = (wA*sA.vol) + (wI*sI.vol) + (wT*sT.vol); 

            portfolioStats = { totalVal: total, weightedReturn: portRet, weightedVol: portVol };
            
            // è¨ˆç®—åœ‹å®¶æ›éšª (ä¼°ç®—å€¼)
            // AOA: ~60% US, ~2% TW
            // IMID: ~60% US, ~4% UK, ~2% TW
            // TW: 100% TW (Leveraged, but exposure for pie chart usually means allocation)
            // Cash: 100% Cash
            const valUS = (vA * 0.60) + (vI * 0.60);
            const valTW = (vA * 0.01) + (vI * 0.02) + vT; // 00631L å…¨ç®—å°ç£
            const valOther = (vA * 0.39) + (vI * 0.38); // å…¶ä»–
            const valCashPos = vCash; 

            // æ›´æ–°åœ‹å®¶åœ–è¡¨
            if(countryChart) {
                const sum = total || 1;
                countryChart.data.datasets[0].data = [
                    (valUS/sum*100).toFixed(1),
                    (valTW/sum*100).toFixed(1),
                    (valOther/sum*100).toFixed(1),
                    0, // æ–°èˆˆå¸‚å ´å«åœ¨å…¶ä»–
                    (valCashPos/sum*100).toFixed(1)
                ];
                countryChart.update();
            }

            runMonteCarlo();
        }

        // --- 3. è’™åœ°å¡ç¾…æ¨¡æ“¬ ---
        function runMonteCarlo() {
            const years = parseInt(document.getElementById('sim-years').value) || 45;
            const ratePct = parseFloat(document.getElementById('withdraw-rate').value) || 4.0;
            const inflationRate = parseFloat(document.getElementById('inflation-rate').value) || 3.0; // ä½¿ç”¨è€…è¼¸å…¥
            const startVal = portfolioStats.totalVal;
            
            if(startVal === 0) return;

            // é¦–å¹´æé ˜ (é¡¯ç¤ºç”¨ï¼Œå–®ä½ï¼šè¬)
            const firstWithdrawal = Math.round(startVal * (ratePct / 100));
            document.getElementById('withdraw-amt').innerText = Math.round(firstWithdrawal/10000).toLocaleString();

            const simulations = 10000;
            const mu = portfolioStats.weightedReturn;
            const sigma = portfolioStats.weightedVol;
            const inf = inflationRate / 100; // è½‰å°æ•¸

            const yearlyData = new Array(years + 1).fill(0).map(() => []);
            let successCount = 0;

            for(let i=0; i<simulations; i++) {
                let currentWealth = startVal;
                let annualWithdrawal = firstWithdrawal; // åˆå§‹æé ˜é¡
                let alive = true;

                yearlyData[0].push(currentWealth);

                for(let y=1; y<=years; y++) {
                    if(!alive) {
                        yearlyData[y].push(0);
                        continue;
                    }

                    // 1. è³‡ç”¢å¢é•· (å¹¾ä½•å¸ƒæœ—é‹å‹•)
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
                    const r = mu - 0.5 * sigma * sigma + sigma * z;
                    const ret = Math.exp(r);
                    currentWealth = currentWealth * ret;

                    // 2. æ‰£é™¤æé ˜ (æ¯å¹´ä¾é€šè†¨èª¿æ•´)
                    currentWealth -= annualWithdrawal;

                    // 3. æº–å‚™ä¸‹ä¸€å¹´æé ˜é¡
                    annualWithdrawal *= (1 + inf);

                    if(currentWealth < 0) {
                        currentWealth = 0;
                        alive = false;
                    }
                    yearlyData[y].push(currentWealth);
                }
                if(alive) successCount++;
            }

            // ç™¾åˆ†ä½æ•¸
            const p25 = [], p50 = [], p75 = [];
            for(let y=0; y<=years; y++) {
                yearlyData[y].sort((a,b) => a-b);
                p25.push(yearlyData[y][Math.floor(simulations * 0.25)]);
                p50.push(yearlyData[y][Math.floor(simulations * 0.50)]);
                p75.push(yearlyData[y][Math.floor(simulations * 0.75)]);
            }

            // é¡¯ç¤ºçµæœ
            const successRate = (successCount / simulations * 100).toFixed(1);
            const rateEl = document.getElementById('success-rate');
            rateEl.innerText = successRate + "%";
            rateEl.className = successCount/simulations < 0.75 ? "text-3xl font-bold text-red-600" : (successCount/simulations < 0.90 ? "text-3xl font-bold text-yellow-600" : "text-3xl font-bold text-green-600");

            document.getElementById('res-p25').innerText = (p25[years]/10000).toFixed(0) + " è¬";
            document.getElementById('res-p50').innerText = (p50[years]/10000).toFixed(0) + " è¬";
            document.getElementById('res-p75').innerText = (p75[years]/10000).toFixed(0) + " è¬";

            updateMcChart(years, p25, p50, p75);
        }

        function updateMcChart(years, p25, p50, p75) {
            const labels = Array.from({length: years+1}, (_, i) => i);
            mcChart.data.labels = labels;
            mcChart.data.datasets = [
                {
                    label: 'è¼ƒå¥½çš„æƒ…æ³ (P75)',
                    data: p75,
                    borderColor: 'rgba(239, 68, 68, 0)',
                    fill: false,
                    pointRadius: 0
                },
                {
                    label: 'P25 - P75 å€é–“',
                    data: p75,
                    backgroundColor: 'rgba(253, 224, 71, 0.4)',
                    borderColor: 'rgba(0,0,0,0)',
                    fill: '-2', // Fill to dataset index 2 (P25)
                    pointRadius: 0
                },
                {
                    label: 'è¼ƒå·®çš„æƒ…æ³ (P25)',
                    data: p25,
                    borderColor: '#16a34a',
                    borderWidth: 1,
                    fill: false,
                    pointRadius: 0
                },
                {
                    label: 'ä¸­ä½æ•¸ (P50)',
                    data: p50,
                    borderColor: '#2563eb',
                    borderWidth: 2,
                    fill: false,
                    pointRadius: 0
                }
            ];
            mcChart.resetZoom(); // æ›´æ–°æ•¸æ“šæ™‚é‡ç½®ç¸®æ”¾
            mcChart.update();
        }

        window.onload = function() {
            initCharts();
            fetchAllData();
        };
    </script>
</body>
</html>