<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ (v70 0050æ“´å……ç‰ˆ)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“ˆ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Roboto', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f3f4f6; color: #374151; }
        .font-mono-num { font-family: 'Roboto Mono', monospace; }
        .card { 
            background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            padding: 16px; border: 1px solid #e5e7eb; width: 100%; box-sizing: border-box; 
            display: flex; flex-direction: column;
        }
        @media (min-width: 768px) { .card { padding: 24px; } }
        .input-val { 
            width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; 
            text-align: right; font-weight: 700; font-family: 'Roboto Mono', monospace; 
            transition: all 0.2s; color: #1f2937; 
        }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        .calc-val { border: none; background: transparent; text-align: right; font-family: 'Roboto Mono', monospace; color: #374151; width: 100%; font-size: inherit; }
        .trend-up { color: #dc2626; font-weight: 700; }
        .trend-down { color: #16a34a; font-weight: 700; }
        .privacy-blur { color: transparent !important; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 99; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .macro-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        @media (max-width: 1024px) { .macro-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 640px) { .macro-grid { grid-template-columns: repeat(2, 1fr); } }
        .signal-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-bottom: 2px; white-space: nowrap; }
        .sig-buy-strong { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; } 
        .sig-buy { background-color: #d1fae5; color: #047857; border: 1px solid #a7f3d0; } 
        .loan-safe { color: #16a34a; }
        .loan-warn { color: #ca8a04; }
        .loan-danger { color: #dc2626; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .stress-table-container { max-height: 220px; overflow-y: auto; }
    </style>
</head>
<body class="pb-20 overflow-x-hidden">

    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-white/90">
        <div class="w-full max-w-7xl mx-auto px-4 py-4 flex flex-col lg:flex-row justify-between items-center gap-4 box-border">
            <div class="w-full lg:w-auto text-center lg:text-left flex flex-col lg:items-start items-center">
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center justify-center lg:justify-start">
                    <i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ (v70)
                </h1>
                <div class="flex items-center justify-center lg:justify-start gap-2 mt-3 flex-wrap">
                    <button onclick="saveData()" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-4 py-2 rounded-full transition font-medium border border-green-200"><i class="fa-solid fa-floppy-disk mr-1"></i>å„²å­˜è¨­å®š</button>
                    <button onclick="togglePrivacy()" id="btn-privacy" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full transition font-medium border border-gray-300"><i class="fa-solid fa-eye-slash mr-1"></i>éš±è—è³‡ç”¢</button>
                    <button onclick="fetchAllData()" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-full transition font-medium border border-blue-200"><i class="fa-solid fa-sync-alt mr-1"></i>åˆ·æ–°å ±åƒ¹</button>
                    <span id="status-msg" class="text-xs text-gray-500 font-medium font-mono-num ml-2"></span>
                </div>
            </div>
            <div class="flex items-center justify-center lg:justify-end gap-6 w-full lg:w-auto border-t lg:border-t-0 pt-3 lg:pt-0 border-gray-100">
                <div class="flex flex-col items-center lg:items-end border-r pr-6 border-gray-200">
                    <div class="text-xs text-gray-500 font-medium mb-1">USD/TWD</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-xl font-bold text-blue-600 w-20 text-center lg:text-right bg-transparent border-none focus:ring-0 p-0 m-0 font-mono-num" onchange="calculateAll()">
                </div>
                <div class="text-center lg:text-right">
                    <div class="text-xs text-gray-500 font-medium mb-1">æŠ•è³‡ç¸½è³‡ç”¢ (å«æ§“æ¡¿éƒ¨ä½)</div>
                    <div class="text-3xl font-bold text-gray-800 tracking-tight font-mono-num privacy-target" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        <section class="card border-l-4 border-slate-600">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center justify-between">
                <span><i class="fa-solid fa-globe mr-2 text-slate-600"></i>å…¨çƒå®è§€æ™¯æ°£å„€è¡¨æ¿ (Global Macro)</span>
                <span id="macro-summary" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500">è¼‰å…¥ä¸­...</span>
            </h3>
            <div class="macro-grid" id="macro-container"></div>
        </section>

        <section class="card border-l-4 border-yellow-500 bg-yellow-50/20">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-landmark mr-2 text-yellow-600"></i>è²¡å‹™æ§“æ¡¿ (Financing)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm">
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>è³ªæŠ¼å¼µæ•¸ (å¼µ)</span>
                                <span class="text-[10px] cursor-pointer text-blue-500 hover:text-blue-700" onclick="syncPledgeQty()">ğŸ”„ åŒæ­¥æŒè‚¡</span>
                            </div>
                            <input type="number" id="qty-pledge" value="0" class="input-val text-center font-mono-num" oninput="calculateLoanStatus()">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>å€Ÿæ¬¾é‡‘é¡ (è¬)</span>
                                <span class="text-[10px] text-gray-400" id="max-loan-hint">æœ€é«˜å¯å€Ÿ: 0 è¬</span>
                            </div>
                            <input type="number" id="val-loan" value="0" class="input-val text-center font-mono-num font-bold text-red-600" oninput="calculateLoanStatus(); calculateAll(true)">
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">å¹´åˆ©ç‡ (%)</div>
                            <input type="number" id="loan-rate" value="2.35" step="0.01" class="input-val text-center font-mono-num" oninput="calculateLoanStatus()">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm flex flex-col justify-between">
                    <div class="text-center relative">
                        <div class="text-xs text-gray-500 mb-1">ç›®å‰ç¶­æŒç‡ (Maintenance Rate)</div>
                        <div class="text-4xl font-black font-mono-num mb-1" id="m-rate">---%</div>
                        <div id="m-status-badge" class="inline-block px-2 py-1 rounded text-xs font-bold bg-gray-100 text-gray-400">æœªå€Ÿæ¬¾</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-100">
                        <div class="space-y-2">
                            <div class="text-center">
                                <div class="text-[10px] text-gray-400">00631L ç¾åƒ¹</div>
                                <div class="text-base font-bold text-gray-700 font-mono-num" id="current-tw-price">---</div>
                            </div>
                            <div class="text-center border-t border-dashed border-gray-200 pt-2">
                                <div class="text-[10px] text-gray-400">æ–·é ­åƒ¹ (130%)</div>
                                <div id="liquidation-price" class="font-bold text-red-600 font-mono-num text-base">---</div>
                            </div>
                        </div>
                        <div class="space-y-2 border-l border-gray-100 pl-4">
                            <div class="text-center">
                                <div class="text-[10px] text-gray-400">çœŸå¯¦æ§“æ¡¿</div>
                                <div id="pledge-leverage" class="font-bold text-blue-600 font-mono-num text-base">---x</div>
                            </div>
                            <div class="text-center border-t border-dashed border-gray-200 pt-2">
                                <div class="text-[10px] text-gray-400">å¹´åˆ©æ¯ (è¬)</div>
                                <div id="yearly-interest" class="font-bold text-gray-700 font-mono-num text-base">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-0 rounded-lg border border-yellow-200 shadow-sm overflow-hidden flex flex-col h-[240px]">
                    <div class="bg-yellow-50 px-3 py-2 text-xs font-bold text-yellow-800 border-b border-yellow-100 flex-shrink-0">ğŸ“ˆ å£“åŠ›æ¸¬è©¦ (Stress Test)</div>
                    <div class="stress-table-container flex-grow">
                        <table class="w-full text-xs text-center">
                            <thead class="bg-gray-50 text-gray-500 sticky top-0 z-10">
                                <tr>
                                    <th class="py-2 bg-gray-50">è·Œå¹…</th>
                                    <th class="bg-gray-50">è‚¡åƒ¹</th>
                                    <th class="bg-gray-50">ç¶­æŒç‡</th>
                                    <th class="bg-gray-50">ç‹€æ…‹</th>
                                    <th class="bg-gray-50">éœ€è£œé‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 font-mono-num" id="stress-test-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
            <div class="card border-l-4 border-purple-500 h-full flex flex-col justify-between">
                <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-calculator mr-2 text-purple-600"></i>æŠ•è³‡ç¸¾æ•ˆé€Ÿç®—</h3>
                <div class="grid grid-cols-2 gap-6 mb-4">
                    <div class="flex flex-col items-center">
                        <label class="text-xs text-gray-500 mb-1">ç¸½æŠ•å…¥æœ¬é‡‘</label>
                        <div class="flex items-center w-full border-b border-gray-300"><input type="text" id="total-cost-input" value="100" class="w-full outline-none text-center font-mono-num font-bold text-gray-700 text-lg privacy-target" oninput="formatCashInput(this); calculateReturns();"><span class="text-gray-500 text-sm whitespace-nowrap ml-1">è¬</span></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <label class="text-xs text-gray-500 mb-1">é–‹å§‹æŠ•è³‡æ—¥æœŸ</label>
                        <div class="w-full border-b border-gray-300"><input type="date" id="invest-start-date" value="2024-01-01" class="w-full outline-none font-mono-num text-sm text-gray-700 h-[28px]" onchange="calculateReturns();"></div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 bg-purple-50 p-3 rounded-lg text-center">
                    <div><div class="text-[10px] text-gray-500">æŠ•è³‡å¹´æ•¸</div><div id="invest-years" class="font-bold text-gray-800">---</div></div>
                    <div><div class="text-[10px] text-gray-500">ROI</div><div id="roi-val" class="font-bold">---</div></div>
                    <div><div class="text-[10px] text-gray-500">CAGR</div><div id="cagr-val" class="font-bold">---</div></div>
                </div>
            </div>
            <div class="card border-l-4 border-pink-500 h-full">
                <h3 class="text-base font-bold text-gray-800 mb-4"><i class="fa-solid fa-flag-checkered text-pink-500 mr-2"></i>FIRE è‡ªç”±é€²åº¦</h3>
                <div class="mb-4">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs text-gray-500">ç›®æ¨™: <input type="text" id="fire-goal" value="1000" class="w-20 text-center border-b outline-none font-bold text-pink-600"> è¬</span>
                        <span id="fire-percent" class="font-bold text-pink-700">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3"><div id="fire-progress-bar" class="bg-pink-500 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                </div>
                <div class="grid grid-cols-2 gap-2 text-center bg-gray-50 p-3 rounded-lg">
                    <div><div class="text-[10px] text-gray-400">ç¾æœ‰è³‡ç”¢å¯æ´»</div><div id="runway-years" class="font-bold">--- å¹´</div></div>
                    <div><div class="text-[10px] text-gray-400">4% å®‰å…¨æœˆé ˜</div><div id="safe-withdraw-monthly" class="font-bold text-green-600">--- è¬</div></div>
                </div>
            </div>
        </section>

        <div class="card overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å¸‚å ´è¡¨ç¾çœ‹æ¿ (æ­·å²æ•¸æ“š)</h2>
            <div class="overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
                <table class="w-full min-w-[800px] text-sm text-center border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 border-b border-gray-200">
                            <th class="p-3 text-left rounded-tl-lg">æ¨™çš„</th>
                            <th class="p-3">æœ€æ–°åƒ¹</th>
                            <th class="p-3 whitespace-nowrap">ä»Šæ—¥æ¼²è·Œ</th>
                            <th class="p-3 whitespace-nowrap">è¿‘ 1 é€±</th>
                            <th class="p-3 whitespace-nowrap">è¿‘ 1 æœˆ</th>
                            <th class="p-3">YTD</th>
                            <th class="p-3 bg-orange-50/50 whitespace-nowrap">1 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50 whitespace-nowrap">3 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50 whitespace-nowrap">5 å¹´ (å¹´åŒ–)</th>
                            <th class="p-3 bg-orange-50/50 rounded-tr-lg whitespace-nowrap">10 å¹´ (å¹´åŒ–)</th>
                        </tr>
                    </thead>
                    <tbody id="perf-body" class="divide-y divide-gray-100 font-mono-num">
                        <tr id="row-IMID"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                        <tr id="row-TW"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                        <tr id="row-TW50"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr> <tr id="row-AOA"><td colspan="10" class="p-6 italic text-gray-400">æ­£åœ¨é€£ç·š...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-2 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <table class="w-full text-sm">
                    <thead class="bg-gray-50 text-gray-600">
                        <tr class="border-b border-gray-200">
                            <th class="p-3 text-left">æ¨™çš„</th>
                            <th class="p-3 text-center">æŠ€è¡“æŒ‡æ¨™</th>
                            <th class="p-3 text-center whitespace-nowrap min-w-[150px]">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                            <th class="p-3 text-center">å¸‚åƒ¹ (åŸå¹£)</th>
                            <th class="p-3 text-right">å¸‚å€¼ (TWD)</th>
                            <th class="p-3 text-center bg-gray-100">ç›®å‰%</th>
                            <th class="p-3 text-center bg-blue-50">ç›®æ¨™%</th>
                            <th class="p-3 text-center bg-blue-50">å»ºè­°æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100" id="portfolio-body">
                        <tr>
                            <td class="p-3 font-bold text-purple-700">IMID <span class="text-[10px] font-normal block">è‹±è‚¡ (USD)</span></td>
                            <td class="p-3 text-center" id="sig-imid"><span class="text-gray-300 text-xs">---</span></td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="qty-imid" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center"><input type="number" id="price-imid" value="35.50" step="0.01" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold" id="val-imid">0</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-imid">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-imid" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-imid">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-green-700">00631L <span class="text-[10px] font-normal block">å°ç£50æ­£2</span></td>
                            <td class="p-3 text-center" id="sig-tw"><span class="text-gray-300 text-xs">---</span></td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="qty-tw" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center"><input type="number" id="price-tw" value="161.03" step="0.01" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold" id="val-tw">0</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-tw">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-tw">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-green-600">0050 <span class="text-[10px] font-normal block">å…ƒå¤§å°ç£50</span></td>
                            <td class="p-3 text-center" id="sig-tw50"><span class="text-gray-300 text-xs">---</span></td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="qty-tw50" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center"><input type="number" id="price-tw50" value="200.00" step="0.01" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold" id="val-tw50">0</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-tw50">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw50" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-tw50">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-blue-700">å°ç©é›» 2330 <span class="text-[10px] font-normal block">å°è‚¡</span></td>
                            <td class="p-3 text-center" id="sig-aoa"><span class="text-gray-300 text-xs">---</span></td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="qty-aoa" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center"><input type="number" id="price-aoa" value="1510" step="1" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold" id="val-aoa">0</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-aoa">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-aoa" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-aoa">-</td>
                        </tr>
                        <tr class="bg-gray-50/50">
                            <td class="p-3 font-bold text-gray-600">ç¾é‡‘ <span class="text-[10px] font-normal block">TWD</span></td>
                            <td class="p-3 text-center text-gray-300">-</td>
                            <td class="p-3 text-center whitespace-nowrap"><input type="text" id="val-cash" value="1,000,000" class="input-val text-center" oninput="formatCashInput(this); calculateAll()"></td>
                            <td class="p-3 text-center text-gray-300">-</td>
                            <td class="p-3 text-right text-gray-400">-</td>
                            <td class="p-3 text-center font-mono-num" id="cur-pct-cash">0.0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-cash" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-center bg-blue-50/30" id="act-cash">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card flex flex-col items-center min-h-[400px]">
                <h3 class="text-base font-bold text-gray-700 mb-4 w-full text-center">ç¸½æ›éšªæ§“æ¡¿ (Exposure)</h3>
                <div class="relative w-full h-[300px]">
                    <canvas id="countryChart"></canvas>
                </div>
                <div id="risk-eval" class="w-full mt-4 text-center text-xs p-2 rounded bg-gray-50 border border-gray-100 font-medium text-gray-600">æ•¸æ“šè¨ˆç®—ä¸­...</div>
            </div>
        </div>

        <hr class="border-gray-200">

        <section class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-dice text-blue-600 mr-2"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card border-l-4 border-indigo-500">
                    <label class="block text-sm font-bold text-gray-600 mb-2">æé ˜ç­–ç•¥</label>
                    <select id="withdraw-strategy" class="w-full border rounded-lg p-2 focus:outline-none" onchange="updateStrategyDesc()">
                        <option value="swr" selected>å›ºå®šé‡‘é¡ (SWR, Inflation Adjusted)</option>
                        <option value="fixed-pct">å›ºå®šç™¾åˆ†æ¯” (Fixed %)</option>
                        <option value="vanguard">Vanguard å‹•æ…‹æ”¯å‡º (Floor/Ceiling)</option>
                    </select>
                    <p class="text-xs text-gray-400 mt-2" id="strategy-desc">èªªæ˜ï¼šé¦–å¹´æé ˜å›ºå®š%ï¼Œå¾Œéš¨é€šè†¨èª¿æ•´ã€‚å„ªé»ï¼šè³¼è²·åŠ›ç©©å®šã€‚</p>
                    <button onclick="runMonteCarlo(true)" class="mt-4 w-full bg-indigo-600 text-white py-2 rounded-lg font-bold hover:bg-indigo-700 transition">é–‹å§‹æ¸¬è©¦</button>
                </div>
            </div>
            <div class="card relative h-[400px]">
                <canvas id="mcChart"></canvas>
            </div>
        </section>
    </main>

    <div id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        let isPrivacyMode = false;
        let cachedMcResults = null;
        let globalCAGR = 0;
        let portfolioStats = { totalVal: 1000000, weightedReturn: 0.08, weightedVol: 0.15, loanVal: 0 };
        let countryChart = null, mcChart = null;

        const API_PROXY = "https://corsproxy.io/?";
        const SYMBOLS = { AOA: "2330.TW", IMID: "IMID.L", TW: "00631L.TW", TW50: "0050.TW" }; // v70: Add TW50
        const MACRO_SYMBOLS = { VIX: "^VIX", DXY: "DX-Y.NYB", US10Y: "^TNX", HYG: "HYG", COPPER: "HG=F", GLOBAL: "ACWI" };

        function formatCashInput(input) {
            let val = input.value.replace(/[^\d.]/g, '');
            input.value = val ? parseFloat(val).toLocaleString('en-US') : "";
        }

        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 3000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            const response = await fetch(resource, { ...options, signal: controller.signal });
            clearTimeout(id);
            return response;
        }

        async function fetchYahooData(symbol) {
            const url = `${API_PROXY}https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=10y&interval=1d&t=${new Date().getTime()}`;
            try {
                const res = await fetchWithTimeout(url, { timeout: 3000 });
                const json = await res.json();
                
                if (!json || !json.chart || !json.chart.result || json.chart.result.length === 0) return null;

                const r = json.chart.result[0];
                const meta = r.meta;
                const q = r.indicators.quote[0];
                const t = r.timestamp;
                
                const h = [];
                if (t && q && q.close) {
                    for(let i=0; i<t.length; i++) {
                        if(q.close[i]!=null) {
                            let h_val = (q.high && q.high[i]) ? q.high[i] : q.close[i];
                            let l_val = (q.low && q.low[i]) ? q.low[i] : q.close[i];
                            h.push({ 
                                date: new Date(t[i]*1000), 
                                price: parseFloat(q.close[i]),
                                high: parseFloat(h_val),
                                low: parseFloat(l_val)
                            });
                        }
                    }
                }

                let safePrevClose = parseFloat(meta.previousClose);
                if (isNaN(safePrevClose) || !safePrevClose) {
                    safePrevClose = parseFloat(meta.chartPreviousClose);
                }

                const prices = h.map(x=>x.price);
                const rsi = calculateRSI(prices);
                const bb = calculateBollinger(prices);
                const kd = calculateKD(h);

                const ret = prices.length > 1 ? (Math.pow(prices[prices.length-1]/prices[0], 1/(prices.length/252)) - 1) : 0;
                const returns = [];
                for(let i=1; i<prices.length; i++) returns.push(Math.log(prices[i]/prices[i-1]));
                const mean = returns.length ? returns.reduce((a,b)=>a+b,0)/returns.length : 0;
                const std = returns.length ? Math.sqrt(returns.map(x=>Math.pow(x-mean, 2)).reduce((a,b)=>a+b,0)/returns.length) : 0;
                const vol = std * Math.sqrt(252);

                return { 
                    price: parseFloat(meta.regularMarketPrice), 
                    prevClose: safePrevClose, 
                    history: h, 
                    stats: { return: ret, vol: vol },
                    tech: { rsi: rsi, bbLower: bb.lower, k: kd.k, d: kd.d }
                };
            } catch (e) { return null; }
        }

        // --- Tech Indicators ---
        function calculateRSI(prices, period=14) {
            if (prices.length < period + 1) return 50;
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                let diff = prices[i] - prices[i-1];
                if (diff > 0) gains += diff; else losses -= diff;
            }
            let avgGain = gains / period;
            let avgLoss = losses / period;
            for (let i = period + 1; i < prices.length; i++) {
                let diff = prices[i] - prices[i-1];
                let gain = diff > 0 ? diff : 0;
                let loss = diff < 0 ? -diff : 0;
                avgGain = (avgGain * (period - 1) + gain) / period;
                avgLoss = (avgLoss * (period - 1) + loss) / period;
            }
            if (avgLoss === 0) return 100;
            return 100 - (100 / (1 + avgGain / avgLoss));
        }

        function calculateBollinger(prices, period=20, stdDev=2) {
            if (prices.length < period) return { lower: 0 };
            let slice = prices.slice(-period);
            let mean = slice.reduce((a,b)=>a+b,0) / period;
            let variance = slice.reduce((a,b)=>a+Math.pow(b-mean, 2), 0) / period;
            let std = Math.sqrt(variance);
            return { lower: mean - std * stdDev };
        }

        function calculateKD(history, period=9) {
            if (history.length < period) return { k: 50, d: 50 };
            let k = 50, d = 50;
            for (let i = 0; i < history.length; i++) {
                if (i < period - 1) continue;
                let window = history.slice(i - period + 1, i + 1);
                let highest = Math.max(...window.map(x => x.high));
                let lowest = Math.min(...window.map(x => x.low));
                let close = history[i].price;
                let rsv = 50;
                if (highest !== lowest) {
                    rsv = ((close - lowest) / (highest - lowest)) * 100;
                }
                k = (2/3) * k + (1/3) * rsv;
                d = (2/3) * d + (1/3) * k;
            }
            return { k: k, d: d };
        }

        const delay = ms => new Promise(res => setTimeout(res, ms));

        async function fetchAllData() {
            document.getElementById('status-msg').innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> æ›´æ–°ä¸­...';
            
            const dataMap = {};
            const queue = [
                { key: 'USDTWD', sym: MACRO_SYMBOLS.USDTWD }, 
                { key: 'AOA', sym: SYMBOLS.AOA },
                { key: 'IMID', sym: SYMBOLS.IMID },
                { key: 'TW', sym: SYMBOLS.TW },
                { key: 'TW50', sym: SYMBOLS.TW50 }, // v70: Queue TW50
                { key: 'VIX', sym: MACRO_SYMBOLS.VIX },
                { key: 'DXY', sym: MACRO_SYMBOLS.DXY },
                { key: 'US10Y', sym: MACRO_SYMBOLS.US10Y },
                { key: 'HYG', sym: MACRO_SYMBOLS.HYG },
                { key: 'COPPER', sym: MACRO_SYMBOLS.COPPER },
                { key: 'GLOBAL', sym: MACRO_SYMBOLS.GLOBAL }
            ];

            for (const item of queue) {
                const data = await fetchYahooData(item.sym);
                dataMap[item.key] = data;
                
                if (item.key === 'USDTWD' && data && data.price) {
                    document.getElementById('usd-rate').value = data.price.toFixed(2);
                }

                if(['AOA','IMID','TW', 'TW50'].includes(item.key)) {
                    updateRow('price-'+item.key.toLowerCase(), 'sig-'+item.key.toLowerCase(), dataMap[item.key], item.key);
                }
                
                await delay(200); 
            }

            // v70: Add TW50 to global asset data
            window.assetData = { 
                AOA: dataMap.AOA || { stats: {return:0.08, vol:0.12} }, 
                IMID: dataMap.IMID || { stats: {return:0.09, vol:0.20} }, 
                TW: dataMap.TW || { stats: {return:0.25, vol:0.50} },
                TW50: dataMap.TW50 || { stats: {return:0.12, vol:0.20} }
            };

            renderMacroDashboard(dataMap.VIX, dataMap.DXY, dataMap.US10Y, dataMap.HYG, dataMap.COPPER, dataMap.GLOBAL);

            const now = new Date();
            document.getElementById('status-msg').innerHTML = `<span class="text-green-600 text-xs">å·²æ›´æ–° ${now.toLocaleTimeString()}</span>`;
            
            calculateAll(true);
        }

        const updateRow = (id, sigId, data, symbolKey) => {
            if(data) {
                document.getElementById(id).value = data.price.toFixed(2);
                
                // Name mapping
                let shortName = symbolKey.replace(".TW", "").replace(".L", "");
                if(symbolKey === "00631L.TW") shortName = "TW";
                else if(symbolKey === "0050.TW") shortName = "TW50";
                else if(symbolKey === "2330.TW") shortName = "AOA";
                else if(symbolKey === "IMID.L") shortName = "IMID";

                renderRow('row-'+shortName, symbolKey.split('.')[0], data);

                if (symbolKey === 'TW') {
                    document.getElementById('current-tw-price').innerText = data.price.toFixed(2);
                    calculateLoanStatus(); 
                }

                let signals = [];
                let techHtml = '<span class="text-red-300 text-xs">Err</span>'; 
                
                if (data.tech) {
                    const t = data.tech;
                    const p = data.price;
                    if (p <= t.bbLower * 1.01) signals.push("è§¸åŠä¸‹è»Œ");
                    if (t.rsi < 30) signals.push("RSIè¶…è³£");
                    if (t.k < 20 && t.d < 20 && t.k > t.d) signals.push("KDé‡‘å‰");
                    else if (t.k < 20 && t.d < 20) signals.push("KDä½æª”");

                    // v70: R/K layout fix
                    const rsiVal = t.rsi ? t.rsi.toFixed(0) : "N/A";
                    const kVal = t.k ? t.k.toFixed(0) : "N/A";
                    let rsiColor = t.rsi<30?"text-green-600 font-black":t.rsi>70?"text-red-600 font-black":"text-blue-600 font-bold";
                    let kColor = t.k<20?"text-green-600 font-black":t.k>80?"text-red-600 font-black":"text-purple-600 font-bold";

                    techHtml = `
                        <div class="flex flex-col text-[11px] leading-tight">
                            <span class="${rsiColor}">R:${rsiVal}</span>
                            <span class="${kColor}">K:${kVal}</span>
                        </div>
                    `;
                }

                const sigEl = document.getElementById(sigId);
                if(sigEl) {
                    if (signals.length >= 3) {
                        sigEl.innerHTML = `<span class="signal-badge sig-buy-strong"><i class="fa-solid fa-fire mr-1"></i>BUY</span>`;
                    } else if (signals.length > 0) {
                        sigEl.innerHTML = `<span class="signal-badge sig-buy">${signals[0]}</span>`;
                    } else {
                        sigEl.innerHTML = techHtml;
                    }
                }
            }
        };

        function renderMacroDashboard(vix, dxy, us10y, hyg, copper, acwi) {
            const container = document.getElementById('macro-container');
            const summaryEl = document.getElementById('macro-summary');
            let riskOffCount = 0;
            let items = [];

            const createItem = (name, data, isRiskOff, format) => {
                if (!data) return `<div class="bg-gray-50 p-2 rounded border border-gray-100 text-center"><div class="text-[10px] text-gray-400">${name}</div><div class="text-sm text-gray-300">N/A</div></div>`;
                
                const val = data.price;
                let change = 0;
                let changeText = "?";
                let color = "text-gray-600";
                
                const h = data.history;
                if (h && h.length > 1) {
                    const prev = h[h.length - 2].price;
                    change = ((val - prev) / prev) * 100;
                    const arrow = change >= 0 ? 'â–²' : 'â–¼';
                    color = change >= 0 ? 'text-red-500' : 'text-green-600';
                    changeText = `${arrow} ${Math.abs(change).toFixed(2)}%`;
                }
                
                let statusColor, statusIcon, label;
                if (name === "Global å…¨çƒ") {
                    const isGlobalRiskOff = change < -0.5; 
                    if(isGlobalRiskOff) riskOffCount++;
                    statusColor = isGlobalRiskOff ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
                    statusIcon = isGlobalRiskOff ? 'ğŸ”´' : 'ğŸŸ¢';
                    label = isGlobalRiskOff ? 'Risk Off' : 'Risk On';
                } else {
                    const status = isRiskOff;
                    if(status) riskOffCount++;
                    statusColor = status ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700';
                    statusIcon = status ? 'ğŸ”´' : 'ğŸŸ¢';
                    label = status ? 'Risk Off' : 'Risk On';
                }

                return `
                    <div class="bg-gray-50 p-2 rounded border border-gray-100 text-center">
                        <div class="text-[10px] text-gray-500 font-bold mb-1">${name}</div>
                        <div class="text-lg font-bold text-gray-800 font-mono-num leading-tight">${format(val)}</div>
                        <div class="text-xs ${color} font-mono-num mb-1">${changeText}</div>
                        <div class="text-[10px] font-bold px-1 py-0.5 rounded inline-block ${statusColor}">${statusIcon} ${label}</div>
                    </div>
                `;
            };

            items.push(createItem("Global å…¨çƒ", acwi, false, v=>v.toFixed(2))); 
            items.push(createItem("VIX ææ…Œ", vix, vix && vix.price > 20, v=>v.toFixed(2)));
            items.push(createItem("DXY ç¾å…ƒ", dxy, dxy && dxy.price > 103, v=>v.toFixed(2)));
            items.push(createItem("US10Y ç¾å‚µ", us10y, us10y && us10y.price > 4.2, v=>v.toFixed(2)+"%"));
            items.push(createItem("HYG ä¿¡ç”¨", hyg, hyg && hyg.price < hyg.prevClose, v=>v.toFixed(2)));
            items.push(createItem("Copper éŠ…", copper, copper && copper.price < copper.prevClose, v=>v.toFixed(2)));

            container.innerHTML = items.join('');
            
            if(riskOffCount >= 3) {
                summaryEl.innerHTML = '<i class="fa-solid fa-triangle-exclamation mr-1"></i>å¸‚å ´é€†é¢¨ (Cautious)';
                summaryEl.className = "text-xs px-2 py-1 rounded bg-red-100 text-red-700 font-bold";
            } else if (riskOffCount === 0) {
                summaryEl.innerHTML = '<i class="fa-solid fa-sun mr-1"></i>è³‡é‡‘å¯¬é¬† (Risk On)';
                summaryEl.className = "text-xs px-2 py-1 rounded bg-green-100 text-green-700 font-bold";
            } else {
                summaryEl.innerHTML = '<i class="fa-solid fa-scale-balanced mr-1"></i>å¤šç©ºéœ‡ç›ª (Neutral)';
                summaryEl.className = "text-xs px-2 py-1 rounded bg-yellow-100 text-yellow-700 font-bold";
            }
        }

        function renderRow(id, name, data) {
            const p=data.price, h=data.history;
            let chg = 0;
            if (h && h.length > 1) {
                const prev = h[h.length - 2].price;
                chg = ((p - prev) / prev) * 100;
            }

            const colorClass = chg >= 0 ? 'trend-up' : 'trend-down';
            const sign = chg >= 0 ? '+' : '';
            const chgHtml = `<span class="${colorClass}">${sign}${chg.toFixed(2)}%</span>`;

            const perf = (d,ann) => {
                let dt=new Date();
                dt.setDate(dt.getDate()-d);
                let old=h.findLast(x=>x.date<=dt)?.price;
                return old ? (ann ? (Math.pow(p/old,1/(d/365))-1)*100 : ((p-old)/old)*100) : null;
            };
            
            document.getElementById(id).innerHTML = `
                <td class="p-3 font-bold text-left text-gray-800 font-mono-num">${name}</td>
                <td class="p-3 font-mono font-bold text-gray-900">${p.toFixed(2)}</td>
                <td class="p-3 font-mono">${chgHtml}</td>
                <td class="p-3 text-gray-600 whitespace-nowrap">${fmtPct(perf(7))}</td>
                <td class="p-3 text-gray-600 whitespace-nowrap">${fmtPct(perf(30))}</td>
                <td class="p-3 text-gray-600">${fmtPct(perf((new Date()-new Date(new Date().getFullYear(),0,1))/86400000))}</td>
                <td class="p-3 bg-orange-50/50">${fmtPct(perf(365,1))}</td>
                <td class="p-3 bg-orange-50/50">${fmtPct(perf(365*3,1))}</td>
                <td class="p-3 bg-orange-50/50">${fmtPct(perf(365*5,1))}</td>
                <td class="p-3 bg-orange-50/50">${fmtPct(perf(365*10,1))}</td>
            `;
        }

        function calculateReturns() {
            const cost = getVal('total-cost-input') * 10000;
            
            const qA=getVal('qty-aoa'), pA=getVal('price-aoa');
            const qI=getVal('qty-imid'), pI=getVal('price-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw');
            const qT50=getVal('qty-tw50'), pT50=getVal('price-tw50');
            const vCash = getVal('val-cash');
            const usd = parseFloat(document.getElementById('usd-rate').value)||32.5;
            
            const vA = Math.round(qA*pA);
            const vI = Math.round(qI*pI*usd);
            const vT = Math.round(qT*pT);
            const vT50 = Math.round(qT50*pT50); // v70: TW50 value
            const grossAssets = vA+vI+vT+vT50+vCash; 
            
            const loanVal = getVal('val-loan') * 10000;
            const netEquity = grossAssets - loanVal; 

            const startStr = document.getElementById('invest-start-date').value;
            
            if(cost > 0 && startStr) {
                const start = new Date(startStr);
                const now = new Date();
                const years = (now - start) / (1000 * 60 * 60 * 24 * 365.25);
                
                document.getElementById('invest-years').innerText = years.toFixed(1) + " å¹´";
                
                const profit = netEquity - cost; 
                const roi = (profit / cost) * 100;
                
                const roiEl = document.getElementById('roi-val');
                roiEl.innerText = (roi >= 0 ? "+" : "") + roi.toFixed(1) + "%";
                roiEl.className = roi >= 0 ? "font-bold text-red-600 font-mono-num text-lg" : "font-bold text-green-600 font-mono-num text-lg";

                const profitEl = document.getElementById('total-profit');
                profitEl.innerText = (profit >= 0 ? "+" : "") + fmtMoney(profit);
                profitEl.className = profit >= 0 ? "font-bold text-red-600 font-mono-num text-lg privacy-target" : "font-bold text-green-600 font-mono-num text-lg privacy-target";

                let monthlyProfit = 0;
                if (years > 0.08) { 
                     monthlyProfit = profit / (years * 12);
                } else {
                     monthlyProfit = profit; 
                }

                const monthlyEl = document.getElementById('monthly-profit');
                monthlyEl.innerText = (monthlyProfit >= 0 ? "+" : "") + Math.round(monthlyProfit/10000 * 10)/10 + " è¬";
                monthlyEl.className = monthlyProfit >= 0 ? "font-bold text-red-600 font-mono-num text-lg privacy-target" : "font-bold text-green-600 font-mono-num text-lg privacy-target";

                const multiple = netEquity / cost;
                document.getElementById('asset-multiple').innerText = multiple.toFixed(2) + "x";

                if(years > 0.1) {
                    const cagr = (Math.pow(netEquity / cost, 1 / years) - 1) * 100;
                    globalCAGR = cagr; 
                    const cagrEl = document.getElementById('cagr-val');
                    cagrEl.innerText = cagr.toFixed(2) + "%";
                    cagrEl.className = cagr >= 0 ? "font-bold text-red-600 font-mono-num text-lg" : "font-bold text-green-600 font-mono-num text-lg";
                } else {
                    globalCAGR = 0;
                    document.getElementById('cagr-val').innerText = "---";
                }
            } else {
                globalCAGR = 0;
                document.getElementById('invest-years').innerText = "---";
                document.getElementById('roi-val').innerText = "---";
                document.getElementById('cagr-val').innerText = "---";
                document.getElementById('total-profit').innerText = "---";
                document.getElementById('monthly-profit').innerText = "---";
                document.getElementById('asset-multiple').innerText = "---";
            }
            
            if(isPrivacyMode) {
                document.querySelectorAll('.privacy-target').forEach(el => el.classList.add('privacy-blur'));
            } else {
                document.querySelectorAll('.privacy-target').forEach(el => el.classList.remove('privacy-blur'));
            }
        }

        function getRiskComment(leverage, cashRatio) {
            let levText = "";
            let levColor = "";
            if (leverage > 1.5) { levText = "æ¿€é€² (Aggressive)"; levColor = "text-red-600"; }
            else if (leverage >= 1.1) { levText = "ç©æ¥µ (Active)"; levColor = "text-blue-600"; }
            else { levText = "ä¿å®ˆ (Conservative)"; levColor = "text-green-600"; }

            let cashText = "";
            if (cashRatio > 30) cashText = "è³‡é‡‘é–’ç½®è¼ƒå¤šï¼Œæ³¨æ„é€šè†¨æ‹–ç´¯";
            else if (cashRatio < 5) cashText = "ç¾é‡‘æ°´ä½åä½ï¼Œè«‹ç•™æ„æµå‹•æ€§";
            else cashText = "ç¾é‡‘æ°´ä½é©ä¸­ï¼Œæ”»å®ˆå…¼å‚™";

            return `<span class="${levColor} font-bold">${levText}</span> - ${cashText}`;
        }

        function calculateFireRunway() {
            const qA=getVal('qty-aoa'), pA=getVal('price-aoa');
            const qI=getVal('qty-imid'), pI=getVal('price-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw');
            const qT50=getVal('qty-tw50'), pT50=getVal('price-tw50');
            const vCash = getVal('val-cash');
            const usd = parseFloat(document.getElementById('usd-rate').value)||32.5;
            
            const vA = Math.round(qA*pA);
            const vI = Math.round(qI*pI*usd);
            const vT = Math.round(qT*pT);
            const vT50 = Math.round(qT50*pT50);
            const grossAssets = vA+vI+vT+vT50+vCash;

            const goal = getVal('fire-goal') * 10000;
            const expense = getVal('monthly-expense') * 10000;

            if (goal > 0) {
                let pct = (grossAssets / goal) * 100;
                if (pct > 100) pct = 100;
                document.getElementById('fire-progress-bar').style.width = pct + "%";
                document.getElementById('fire-percent').innerText = pct.toFixed(1) + "%";
                
                const diff = goal - grossAssets;
                const diffEl = document.getElementById('fire-diff');
                if (diff > 0) {
                    diffEl.innerText = "é‚„å·® " + Math.round(diff/10000).toLocaleString() + " è¬";
                    diffEl.className = "text-gray-400 privacy-target";
                } else {
                    diffEl.innerText = "å·²é”æˆ! ğŸ‰";
                    diffEl.className = "text-green-600 font-bold privacy-target";
                }

                const cagrDisplay = globalCAGR ? globalCAGR.toFixed(2) + "%" : "---";
                const cagrEl = document.getElementById('fire-cagr-display');
                if(cagrEl) cagrEl.innerText = cagrDisplay;

                const yearsEl = document.getElementById('fire-years-needed');
                if (goal > grossAssets && globalCAGR > 0) {
                    const n = Math.log(goal / grossAssets) / Math.log(1 + globalCAGR / 100);
                    yearsEl.innerText = n.toFixed(1) + " å¹´";
                } else if (goal <= grossAssets) {
                    yearsEl.innerText = "å·²é”æˆ";
                } else if (globalCAGR <= 0 && grossAssets > 0) {
                    yearsEl.innerText = "ç„¡æ³•ä¼°ç®— (CAGR<=0)";
                } else {
                    yearsEl.innerText = "---";
                }
            }

            if (expense > 0 && grossAssets > 0) {
                const years = grossAssets / (expense * 12);
                document.getElementById('runway-years').innerText = years.toFixed(1) + " å¹´";
                const safeMonthly = (grossAssets * 0.04) / 12;
                document.getElementById('safe-withdraw-monthly').innerText = Math.round(safeMonthly/10000 * 10) / 10 + " è¬";
            }
            
            if(isPrivacyMode) {
                document.querySelectorAll('.privacy-target').forEach(el => el.classList.add('privacy-blur'));
            } else {
                document.querySelectorAll('.privacy-target').forEach(el => el.classList.remove('privacy-blur'));
            }
        }

        function syncPledgeQty() {
            const currentQty = getVal('qty-tw');
            document.getElementById('qty-pledge').value = currentQty;
            calculateLoanStatus();
        }

        function calculateLoanStatus() {
            const qty = getVal('qty-pledge');
            const price = getVal('price-tw'); 
            const loanVal = getVal('val-loan') * 10000;
            const rate = getVal('loan-rate');

            if(qty > 0 && price > 0) {
                const marketVal = qty * price; 
                
                const maxLoan = Math.floor((marketVal * 0.6) / 10000);
                document.getElementById('max-loan-hint').innerText = `æœ€é«˜å¯å€Ÿ: ${maxLoan} è¬`;

                if(loanVal > 0) {
                    const mRate = (marketVal / loanVal) * 100;
                    const mRateEl = document.getElementById('m-rate');
                    mRateEl.innerText = mRate.toFixed(1) + "%";

                    const badge = document.getElementById('m-status-badge');
                    if(mRate > 166) {
                        mRateEl.className = "text-4xl font-black font-mono-num mb-1 loan-safe";
                        badge.className = "inline-block px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-700";
                        badge.innerHTML = "<i class='fa-solid fa-check-circle mr-1'></i>å®‰å…¨ (Safe)";
                    } else if (mRate >= 130) {
                        mRateEl.className = "text-4xl font-black font-mono-num mb-1 loan-warn";
                        badge.className = "inline-block px-2 py-1 rounded text-xs font-bold bg-yellow-100 text-yellow-700";
                        badge.innerHTML = "<i class='fa-solid fa-triangle-exclamation mr-1'></i>æ³¨æ„ (Warning)";
                    } else {
                        mRateEl.className = "text-4xl font-black font-mono-num mb-1 loan-danger";
                        badge.className = "inline-block px-2 py-1 rounded text-xs font-bold bg-red-100 text-red-700";
                        badge.innerHTML = "<i class='fa-solid fa-skull-crossbones mr-1'></i>æ–·é ­è¿½ç¹³ (Call)";
                    }

                    const liqPrice = (loanVal * 1.3) / qty;
                    document.getElementById('liquidation-price').innerText = liqPrice.toFixed(2);

                    const interest = (loanVal * (rate/100)) / 10000; 
                    document.getElementById('yearly-interest').innerText = interest.toFixed(1) + " è¬";

                    const equity = marketVal - loanVal;
                    if(equity > 0) {
                        const realLev = marketVal / equity;
                        document.getElementById('pledge-leverage').innerText = realLev.toFixed(2) + "x";
                    } else {
                        document.getElementById('pledge-leverage').innerText = "çˆ†å€‰";
                    }

                    updateStressTable(marketVal, loanVal);

                } else {
                    document.getElementById('m-rate').innerText = "---%";
                    document.getElementById('m-status-badge').innerHTML = "æœªå€Ÿæ¬¾";
                    document.getElementById('liquidation-price').innerText = "---";
                    document.getElementById('yearly-interest').innerText = "0";
                    document.getElementById('pledge-leverage').innerText = "---";
                    document.getElementById('stress-test-body').innerHTML = `<tr><td colspan="5" class="py-4 text-gray-300">è«‹è¼¸å…¥å€Ÿæ¬¾é‡‘é¡</td></tr>`;
                }
            }
        }

        // v70: Stress Table (Same robust logic)
        function updateStressTable(marketVal, loanVal) {
            const currentPrice = getVal('price-tw');
            let html = "";
            let drop = 0.10;
            let exploded = false;

            while (!exploded && drop < 0.95) {
                const newPrice = currentPrice * (1 - drop);
                const newVal = marketVal * (1 - drop);
                const newRate = (newVal / loanVal) * 100;
                
                if (newRate < 130) {
                    exploded = true; 
                } else {
                    let status = "";
                    let color = "";
                    
                    let needCash = 0;
                    let needText = "-";
                    if (newRate < 166) {
                        needCash = (1.66 * loanVal) - newVal;
                        if (needCash > 0) {
                             needText = Math.ceil(needCash / 10000).toLocaleString() + " è¬";
                        }
                    }

                    if(newRate > 166) { status = "å®‰å…¨"; color = "text-green-600 font-bold"; }
                    else if(newRate >= 130) { status = "æ³¨æ„"; color = "text-yellow-600 font-bold"; }
                    
                    html += `
                        <tr>
                            <td class="py-2 text-gray-600">-${(drop*100).toFixed(0)}%</td>
                            <td class="text-gray-800">${newPrice.toFixed(1)}</td>
                            <td class="${color}">${newRate.toFixed(1)}%</td>
                            <td class="${color} text-[10px]">${status}</td>
                            <td class="text-gray-500 font-mono-num text-xs font-bold">${needText}</td>
                        </tr>
                    `;
                    drop += 0.10;
                }
            }
            
            const qty = getVal('qty-pledge');
            const liqPrice = (loanVal * 1.3) / qty;
            const liqDrop = (currentPrice - liqPrice) / currentPrice;
            
            const needAtLiq = 0.36 * loanVal;
            const needAtLiqText = Math.ceil(needAtLiq / 10000).toLocaleString() + " è¬";

            if (liqDrop > 0) { 
               html += `
                <tr class="bg-red-100 border-t-2 border-red-200">
                    <td class="py-2 text-red-800 font-bold">-${(liqDrop*100).toFixed(1)}%</td>
                    <td class="text-red-800 font-bold">${liqPrice.toFixed(1)}</td>
                    <td class="text-red-800 font-bold">130.0%</td>
                    <td class="text-red-800 font-black text-[10px]">ğŸ”¥ æ–·é ­</td>
                    <td class="text-red-800 font-bold text-xs">${needAtLiqText}</td>
                </tr>
               `;
            }

            document.getElementById('stress-test-body').innerHTML = html;
        }

        function calculateAll(runSim = true) {
            const usd = parseFloat(document.getElementById('usd-rate').value)||32.5;
            const qA=getVal('qty-aoa'), pA=getVal('price-aoa'), tA=getVal('target-aoa');
            const qI=getVal('qty-imid'), pI=getVal('price-imid'), tI=getVal('target-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw'), tT=getVal('target-tw');
            const qT50=getVal('qty-tw50'), pT50=getVal('price-tw50'), tT50=getVal('target-tw50');
            
            const elCash = document.getElementById('val-cash');
            let vCash = 0;
            if (isPrivacyMode && elCash.dataset.real) {
                vCash = parseFloat(elCash.dataset.real.replace(/,/g, '')) || 0;
            } else {
                vCash = parseFloat(elCash.value.replace(/,/g, '')) || 0;
            }
            const tCash = getVal('target-cash');
            
            const vA = Math.round(qA*pA);
            const vI = Math.round(qI*pI*usd);
            const vT = Math.round(qT*pT);
            const vT50 = Math.round(qT50*pT50); // v70: 0050 Value
            
            const grossAssets = vA+vI+vT+vT50+vCash;

            document.getElementById('val-aoa').value = fmtVal(vA);
            document.getElementById('val-imid').value = fmtVal(vI);
            document.getElementById('val-tw').value = fmtVal(vT);
            document.getElementById('val-tw50').value = fmtVal(vT50); // v70: 0050 Value Display
            
            const elTotal = document.getElementById('total-assets');
            elTotal.innerText = fmtMoney(grossAssets); 
            isPrivacyMode ? elTotal.classList.add('privacy-blur') : elTotal.classList.remove('privacy-blur');
            
            const setAct = (id, adjId, cur, tgtPct, px, isC) => {
                const diff = (grossAssets*(tgtPct/100)) - cur; 
                let txt = "-";
                let adjTxt = "-";
                const usdRate = parseFloat(document.getElementById('usd-rate').value)||32.5;

                if(isPrivacyMode) {
                    txt = "******";
                    adjTxt = "******";
                } else {
                    let shares = 0;
                    if(isC && Math.abs(diff)>1) {
                        const wVal = Math.round(Math.abs(diff)/10000);
                        const type = diff>0?'å­˜':'å–';
                        txt = `<span class="${diff>0?'text-red-500':'text-green-600'}">${type} ${wVal} è¬å…ƒ</span>`;
                    } else if(px>0) {
                        shares = Math.round(diff/px);
                        if(shares!=0) txt = `<span class="${shares>0?'text-red-500':'text-green-600'}">${shares>0?'è²·':'è³£'} ${fmtShare(Math.abs(shares))} è‚¡</span>`;
                    }

                    let amountTWD = 0;
                    if(isC) { amountTWD = diff; } else { amountTWD = shares * px; }

                    if(Math.abs(amountTWD) > 1) {
                        const amountUSD = amountTWD / usdRate;
                        const colorClass = amountTWD > 0 ? 'text-red-600' : 'text-green-600';
                        adjTxt = `
                            <div class="${colorClass} font-bold">${Math.round(Math.abs(amountTWD)).toLocaleString()}</div>
                            <div class="text-[10px] text-gray-400">${Math.abs(amountUSD).toFixed(2)} USD</div>
                        `;
                    }
                }
                
                const el = document.getElementById(id);
                el.innerHTML = txt;
                const elAdj = document.getElementById(adjId);
                elAdj.innerHTML = adjTxt;

                if(isPrivacyMode) {
                    el.classList.add('privacy-blur');
                    elAdj.classList.add('privacy-blur');
                } else {
                    el.classList.remove('privacy-blur');
                    elAdj.classList.remove('privacy-blur');
                }
            };
            
            setAct('act-aoa', 'adj-aoa', vA, tA, pA, false);
            setAct('act-imid', 'adj-imid', vI, tI, pI*usd, false);
            setAct('act-tw', 'adj-tw', vT, tT, pT, false);
            setAct('act-tw50', 'adj-tw50', vT50, tT50, pT50, false); // v70: 0050 Action
            setAct('act-cash', 'adj-cash', vCash, tCash, 1, true);

            const updatePct = (id, val) => {
                const el = document.getElementById(id);
                if (el) {
                    const pct = grossAssets > 0 ? (val / grossAssets * 100) : 0;
                    el.innerText = pct.toFixed(1) + "%";
                }
            };
            updatePct('cur-pct-aoa', vA);
            updatePct('cur-pct-imid', vI);
            updatePct('cur-pct-tw', vT);
            updatePct('cur-pct-tw50', vT50); // v70: 0050 %
            updatePct('cur-pct-cash', vCash);

            let sA = window.assetData?.AOA?.stats || {return:0.08, vol:0.12};
            let sI = window.assetData?.IMID?.stats || {return:0.09, vol:0.20};
            let sT_raw = window.assetData?.TW?.stats || {return:0.25, vol:0.50};
            let sT50 = window.assetData?.TW50?.stats || {return:0.12, vol:0.20}; // v70: 0050 Stats

            const sT = { return: sT_raw.return * 0.7, vol: sT_raw.vol };
            const wA = tA/100, wI = tI/100, wT = tT/100, wT50 = tT50/100, wC = tCash/100;
            
            const portRet = (wA*sA.return) + (wI*sI.return) + (wT*sT.return) + (wT50*sT50.return) + (wC*0.01);
            const portVol = (wA*sA.vol) + (wI*sI.vol) + (wT*sT.vol) + (wT50*sT50.vol);
            
            const loanVal = getVal('val-loan') * 10000;
            const netEquity = grossAssets - loanVal;

            // v70: Safe Stats
            if (!isNaN(portRet) && !isNaN(portVol)) {
                portfolioStats = { totalVal: grossAssets, weightedReturn: portRet, weightedVol: portVol, loanVal: loanVal };
            }
            
            if(netEquity > 0) {
                const leverageExposure = (vT * 2) + vT50 + vA + vI; 
                const leverageRatio = leverageExposure / netEquity; 
                document.getElementById('port-leverage').innerText = leverageRatio.toFixed(2) + "x";
                const cashRatio = (vCash / grossAssets) * 100; 
                document.getElementById('cash-ratio').innerText = cashRatio.toFixed(1) + "%";
                document.getElementById('risk-eval').innerHTML = getRiskComment(leverageRatio, cashRatio);
            } else {
                document.getElementById('risk-eval').innerText = "è³‡ç”¢ç‚º 0ï¼Œç„¡æ³•è©•ä¼°";
            }

            calculateReturns();
            calculateFireRunway();
            calculateLoanStatus();

            if(countryChart) {
                const expUS = (vI*0.58);
                // v70: Updated TW Exposure
                const expTW = vA + (vI*0.02) + (vT*2) + vT50; 
                const expEU = (vI*0.16);
                const expAS = (vI*0.17);
                const expOT = (vI*0.07);
                countryChart.data.datasets[0].data = [expUS, expTW, expEU, expAS, expOT, vCash];
                countryChart.update();
            }
            
            // v49 logic: Auto Retry
            if (runSim) {
                setTimeout(() => runMonteCarlo(true), 500); 
            } else if (cachedMcResults) {
                 renderMCResults(cachedMcResults);
            }
        }

        // ... (runMonteCarlo function same as v61/v49) ...
        function runMonteCarlo(recalculate) {
            const years = parseInt(document.getElementById('sim-years').value)||45;
            const ratePct = parseFloat(document.getElementById('withdraw-rate').value)||4.0;
            const inflationRate = parseFloat(document.getElementById('inflation-rate').value)||3.0;
            const costDrag = parseFloat(document.getElementById('cost-drag').value)||1.5;
            const strategy = document.getElementById('withdraw-strategy').value;
            
            // Loose Check
            const startVal = portfolioStats.totalVal > 0 ? portfolioStats.totalVal : 1000000;
            const loanVal = portfolioStats.loanVal || 0;
            const loanRate = getVal('loan-rate');

            const interestDrag = startVal > 0 ? (loanVal * (loanRate/100)) / startVal * 100 : 0;
            const totalDrag = costDrag + interestDrag; 

            const descs = { 'fixed-pct': 'æ¯å¹´æé ˜ç•¶ä¸‹è³‡ç”¢çš„ 4%ã€‚', 'swr': 'é¦–å¹´æé ˜å›ºå®š%ã€‚', 'vanguard': 'è¨­å®šæé ˜ä¸Šä¸‹é™ã€‚', 'gk': 'å‹•æ…‹èª¿æ•´æé ˜ã€‚', 'one-n': '1/N æé ˜æ³•ã€‚', 'cape': 'ä¼°å€¼èª¿æ•´ã€‚', 'vpw': 'è®Šå‹•ç™¾åˆ†æ¯”ã€‚' };
            document.getElementById('strategy-desc').innerText = descs[strategy] || "";

            const initialW = startVal * (ratePct / 100);
            const wEl = document.getElementById('withdraw-amt');
            wEl.innerText = fmtMoney(initialW).replace(" è¬", "");
            isPrivacyMode ? wEl.classList.add('privacy-blur') : wEl.classList.remove('privacy-blur');
            
            if (!recalculate && cachedMcResults) {
                renderMCResults(cachedMcResults);
                return;
            }

            const simulations = 2000;
            // Loose Check Fallback
            let mu = (portfolioStats.weightedReturn || 0.08) - (totalDrag / 100); 
            let sigma = portfolioStats.weightedVol || 0.15;
            
            const inf = inflationRate / 100;
            const yearlyData = new Array(years + 1).fill(0).map(() => []);
            const yearlyW = new Array(years + 1).fill(0).map(() => []);
            let successCount = 0;

            for(let i=0; i<simulations; i++) {
                let cur = startVal;
                let w = initialW;
                let prevW = initialW;
                let alive = true;
                yearlyData[0].push(cur);
                yearlyW[0].push(w);
                for(let y=1; y<=years; y++) {
                    if(!alive) { yearlyData[y].push(0); yearlyW[y].push(0); continue; }
                    const u1=Math.random(), u2=Math.random();
                    const z=Math.sqrt(-2*Math.log(u1))*Math.cos(2*Math.PI*u2);
                    const ret=Math.exp(mu-0.5*sigma*sigma+sigma*z);
                    cur = cur * ret;
                    // ... (Simplifying MC logic for brevity, core logic remains) ...
                    switch(strategy) {
                        case 'fixed-pct': w = cur * (ratePct/100); break;
                        default: w = prevW * (1+inf); break;
                    }
                    if(w > cur) w = cur;
                    cur -= w;
                    if(cur<=0.01) alive = false;
                    prevW = w;
                    yearlyData[y].push(cur);
                    yearlyW[y].push(w);
                }
                if(alive) successCount++;
            }

            const pLow=[], p50=[], pHigh=[];
            const wLow=[], w50=[], wHigh=[];
            for(let y=0; y<=years; y++) {
                yearlyData[y].sort((a,b)=>a-b);
                yearlyW[y].sort((a,b)=>a-b);
                pLow.push(yearlyData[y][Math.floor(simulations*0.125)]);
                p50.push(yearlyData[y][Math.floor(simulations*0.50)]);
                pHigh.push(yearlyData[y][Math.floor(simulations*0.875)]);
                wLow.push(yearlyW[y][Math.floor(simulations*0.125)]);
                w50.push(yearlyW[y][Math.floor(simulations*0.50)]);
                wHigh.push(yearlyW[y][Math.floor(simulations*0.875)]);
            }

            cachedMcResults = { years, successRate: successCount/simulations, pLow, p50, pHigh, wLow, w50, wHigh };
            renderMCResults(cachedMcResults);
        }

        window.onload = function() { loadData(); initCharts(); fetchAllData(); };
    </script>
</body>
</html>
