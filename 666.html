<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ v62 - æœ€çµ‚å®Œå·¥ç‰ˆ</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“ˆ</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Roboto', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f3f4f6; color: #374151; }
        .font-mono-num { font-family: 'Roboto Mono', monospace; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 24px; border: 1px solid #e5e7eb; }
        .input-val { width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; text-align: left; font-weight: 700; font-family: 'Roboto Mono', monospace; transition: all 0.2s; color: #1f2937; }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        .calc-val { border: none; background: transparent; text-align: right; font-family: 'Roboto Mono', monospace; color: #374151; width: 100%; font-size: 1rem; }
        .trend-up { color: #dc2626; font-weight: 700; }
        .trend-down { color: #16a34a; font-weight: 700; }
        .privacy-blur { color: transparent !important; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 99; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .macro-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        @media (max-width: 1024px) { .macro-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 640px) { .macro-grid { grid-template-columns: repeat(2, 1fr); } }
        .signal-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-bottom: 2px; white-space: nowrap; }
        .strategy-card { border-left: 4px solid #3b82f6; background: #f8fafc; padding: 16px; margin-bottom: 12px; border-radius: 8px; font-size: 0.95rem; line-height: 1.5; }
        .strategy-title { font-weight: 700; color: #1e40af; display: block; margin-bottom: 6px; font-size: 1.05rem; }
        th { font-weight: 700; letter-spacing: 0.02em; }
        td { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="pb-20 overflow-x-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-white/90">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center justify-center lg:justify-start">
                    <i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬
                </h1>
                <div class="flex items-center justify-center lg:justify-start gap-2 mt-3 flex-wrap">
                    <button onclick="saveData()" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-3 py-1.5 rounded-full transition font-medium border border-green-200">å„²å­˜è¨­å®š</button>
                    <button onclick="togglePrivacy()" id="btn-privacy" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition font-medium border border-gray-300">éš±è—è³‡ç”¢</button>
                    <button onclick="fetchAllData()" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full transition font-medium border border-blue-200">åˆ·æ–°å ±åƒ¹</button>
                    <span id="status-msg" class="text-xs text-gray-500 font-medium font-mono-num ml-2"></span>
                </div>
            </div>
            <div class="flex items-center justify-center md:justify-end gap-6 w-full md:w-auto border-t md:border-t-0 pt-3 md:pt-0 border-gray-100">
                <div class="flex flex-col items-start border-r pr-8 border-gray-200">
                    <div class="text-xs text-gray-500 font-medium mb-1">USD/TWD åŒ¯ç‡</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-2xl font-bold text-blue-600 w-24 text-left bg-transparent border-none focus:ring-0 p-0 m-0 font-mono-num" onchange="calculateAll()">
                </div>
                <div class="text-right">
                    <div class="text-xs text-gray-500 font-medium mb-1">æŠ•è³‡ç¸½è³‡ç”¢ (å«æ§“æ¡¿éƒ¨ä½)</div>
                    <div class="text-4xl font-bold text-gray-800 tracking-tight font-mono-num privacy-target" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        <!-- å®è§€çœ‹æ¿ -->
        <section class="card border-l-4 border-slate-600">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center justify-between">
                <span><i class="fa-solid fa-globe mr-2 text-slate-600"></i>å…¨çƒå®è§€æ™¯æ°£å„€è¡¨æ¿ (Global Macro)</span>
                <span id="macro-summary" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500">è¼‰å…¥ä¸­...</span>
            </h3>
            <div class="macro-grid" id="macro-container"></div>
        </section>

        <!-- è³ªæŠ¼ç›£æ§ -->
        <section class="card border-l-4 border-yellow-500 bg-yellow-50/20">
            <h3 class="text-base font-bold text-gray-800 mb-4"><i class="fa-solid fa-landmark mr-2 text-yellow-600"></i>è‚¡ç¥¨è³ªæŠ¼ç›£æ§ (00631L)</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg border border-yellow-200">
                    <div class="space-y-3">
                        <div><div class="text-xs text-gray-500">è³ªæŠ¼å¼µæ•¸ (å¼µ) <span class="cursor-pointer text-blue-500" onclick="syncPledgeQty()">ğŸ”„åŒæ­¥æŒè‚¡</span></div><input type="number" id="qty-pledge" value="0" class="input-val text-center font-mono-num privacy-target" oninput="calculateLoanStatus()"></div>
                        <div><div class="text-xs text-gray-500">å€Ÿæ¬¾é‡‘é¡ (è¬)</div><input type="number" id="val-loan" value="0" class="input-val text-center font-mono-num font-bold text-red-600 privacy-target" oninput="calculateLoanStatus(); calculateAll(true)"></div>
                        <div><div class="text-xs text-gray-500">å¹´åˆ©ç‡ (%)</div><input type="number" id="loan-rate" value="2.35" step="0.01" class="input-val text-center font-mono-num privacy-target" oninput="calculateLoanStatus()"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg border border-yellow-200 text-center flex flex-col justify-between">
                    <div>
                        <div class="text-xs text-gray-500 mb-1">ç›®å‰ç¶­æŒç‡</div>
                        <div class="text-4xl font-black font-mono-num mb-1" id="m-rate">---%</div>
                        <div id="m-status-badge" class="inline-block px-2 py-1 rounded text-xs font-bold bg-gray-100 text-gray-400">æœªå€Ÿæ¬¾</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t">
                        <div><div class="text-[10px] text-gray-400">00631L ç¾åƒ¹</div><div class="text-base font-bold font-mono-num" id="current-tw-price">---</div></div>
                        <div><div class="text-[10px] text-gray-400">è²¡å‹™æ§“æ¡¿ (Financing)</div><div id="pledge-leverage" class="font-bold text-blue-600 font-mono-num">---x</div></div>
                    </div>
                </div>
                <div class="bg-white rounded-lg border border-yellow-200 overflow-hidden flex flex-col h-[240px]">
                    <div class="bg-yellow-50 px-3 py-2 text-xs font-bold border-b">ğŸ“‰ å£“åŠ›æ¸¬è©¦ (Stress Test)</div>
                    <div class="stress-table-container flex-grow overflow-y-auto">
                        <table class="w-full text-xs text-center"><thead class="bg-gray-50 sticky top-0"><tr><th>è·Œå¹…</th><th>è‚¡åƒ¹</th><th>ç¶­æŒç‡</th><th>ç‹€æ…‹</th><th>éœ€è£œé‡‘é¡</th></tr></thead><tbody id="stress-test-body" class="font-mono-num"></tbody></table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¸¾æ•ˆé€Ÿç®— -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
            <div class="card border-l-4 border-purple-500">
                <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-calculator mr-2 text-purple-600"></i>æŠ•è³‡ç¸¾æ•ˆé€Ÿç®— (ç¸½è³‡ç”¢åŸºæº–)</h3>
                <div class="grid grid-cols-2 gap-6 mb-4">
                    <div class="flex flex-col items-center">
                        <label class="text-xs text-gray-500 mb-1">ç¸½æŠ•å…¥æœ¬é‡‘</label>
                        <div class="flex items-center w-full border-b border-gray-300"><input type="text" id="total-cost-input" value="100" class="w-full text-center font-bold text-lg privacy-target font-mono-num outline-none" oninput="formatCashInput(this); calculateAll();"><span class="text-sm">è¬</span></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <label class="text-xs text-gray-500 mb-1">é–‹å§‹æŠ•è³‡æ—¥æœŸ</label>
                        <input type="date" id="invest-start-date" value="2024-01-01" class="w-full text-center outline-none border-b font-mono-num text-sm" onchange="calculateAll();">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 bg-purple-50 p-3 rounded-lg text-center mt-auto font-mono-num">
                    <div><div class="text-[10px]">æŠ•è³‡å¹´æ•¸</div><div class="font-bold text-lg" id="invest-years">---</div></div>
                    <div><div class="text-[10px]">ç¸½å ±é…¬ç‡ (ROI)</div><div class="font-bold text-lg" id="roi-val">---</div></div>
                    <div><div class="text-[10px]">å¹´åŒ–å ±é…¬ (CAGR)</div><div class="font-bold text-lg" id="cagr-val">---</div></div>
                </div>
            </div>
            <div class="card border-l-4 border-pink-500">
                <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-flag-checkered text-pink-500 mr-2"></i>FIRE è‡ªç”±é€²åº¦</h3>
                <div class="flex justify-between items-center mb-2">
                    <span id="fire-percent" class="text-4xl font-black text-pink-600">0%</span>
                    <div class="flex items-center gap-1 border-b border-gray-300"><span class="text-xs">ç›®æ¨™:</span><input type="text" id="fire-goal" value="1000" class="w-20 text-center font-bold text-lg text-pink-600 privacy-target font-mono-num outline-none" oninput="formatCashInput(this); calculateAll();"><span class="text-xs">è¬</span></div>
                </div>
                <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden"><div id="fire-progress-bar" class="bg-pink-500 h-full" style="width: 0%"></div></div>
                <div id="fire-years-needed" class="text-center text-xs text-gray-400 mt-2 font-bold font-mono-num">æŒ‰ç›®å‰ç¸¾æ•ˆé ä¼°éœ€ --- å¹´</div>
            </div>
        </div>

        <!-- æŠ•è³‡çµ„åˆæ˜ç´° -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-2 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <table class="w-full min-w-[800px] text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 border-b border-gray-200">
                            <th class="p-3 text-left">æ¨™çš„</th>
                            <th class="p-3 text-center">æŠ€è¡“åˆ†æ</th>
                            <th class="p-3 text-center whitespace-nowrap">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                            <th class="p-3 text-center w-32">å¸‚åƒ¹ (åŸå¹£)</th>
                            <th class="p-3 text-right">å¸‚å€¼ (TWD)</th>
                            <th class="p-3 text-center bg-gray-100/50">ç›®å‰ %</th>
                            <th class="p-3 text-center bg-blue-50/50">ç›®æ¨™ %</th>
                            <th class="p-3 text-center bg-blue-50/50">å»ºè­°æ“ä½œ</th>
                            <th class="p-3 text-center bg-blue-50/50">èª¿æ•´é‡‘é¡</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 font-mono-num">
                        <tr>
                            <td class="p-3 font-bold text-purple-700">IMID <span class="text-[10px] font-normal text-gray-400 block">è‹±è‚¡(USD)</span></td>
                            <td class="p-3 text-center" id="sig-imid">-</td>
                            <td class="p-3 text-left"><input type="text" id="qty-imid" value="0" class="input-val privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-imid" value="35.5" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-imid">0</td>
                            <td class="p-3 text-center font-bold text-gray-400" id="cur-pct-imid">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-imid" value="60" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold bg-blue-50/30 privacy-target" id="act-imid">-</td>
                            <td class="p-3 text-left bg-blue-50/30 privacy-target" id="adj-imid">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-green-700">00631L <span class="text-[10px] font-normal text-gray-400 block">å°ç£50æ­£2</span></td>
                            <td class="p-3 text-center" id="sig-tw">-</td>
                            <td class="p-3 text-left"><input type="text" id="qty-tw" value="0" class="input-val privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-tw" value="161.03" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-tw">0</td>
                            <td class="p-3 text-center font-bold text-gray-400" id="cur-pct-tw">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw" value="40" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold bg-blue-50/30 privacy-target" id="act-tw">-</td>
                            <td class="p-3 text-left bg-blue-50/30 privacy-target" id="adj-tw">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-blue-700">2330 <span class="text-[10px] font-normal text-gray-400 block">å°ç©é›»</span></td>
                            <td class="p-3 text-center" id="sig-tsmc">-</td>
                            <td class="p-3 text-left"><input type="text" id="qty-tsmc" value="0" class="input-val privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-tsmc" value="1000" class="input-val text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-tsmc">0</td>
                            <td class="p-3 text-center font-bold text-gray-400" id="cur-pct-tsmc">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tsmc" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold bg-blue-50/30 privacy-target" id="act-tsmc">-</td>
                            <td class="p-3 text-left bg-blue-50/30 privacy-target" id="adj-tsmc">-</td>
                        </tr>
                        <tr class="bg-gray-50/50">
                            <td class="p-3 font-bold text-gray-600 text-base">ç¾é‡‘ <span class="text-[10px] font-normal text-gray-400 block mt-0.5">TWD</span></td>
                            <td class="p-3 text-center text-gray-300">-</td>
                            <td class="p-3 text-left"><input type="text" id="val-cash" value="1,000,000" class="input-val font-bold text-gray-700 privacy-target" oninput="formatCashInput(this); calculateAll()"></td>
                            <td class="p-3 text-center text-gray-300">-</td>
                            <td class="p-3 text-right text-gray-400">-</td>
                            <td class="p-3 text-center font-bold text-gray-400" id="cur-pct-cash">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-cash" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left font-bold bg-blue-50/30 text-gray-600 privacy-target" id="act-cash">-</td>
                            <td class="p-3 text-left bg-blue-50/30 privacy-target" id="adj-cash">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- åœ“é¤…åœ– -->
            <div class="card flex flex-col items-center justify-center">
                <h3 class="text-base font-bold text-gray-700 mb-4 w-full text-left"><i class="fa-solid fa-earth-americas mr-2 text-blue-500"></i>å€åŸŸæ›éšªæ¨ä¼°</h3>
                <div class="relative w-full flex-grow min-h-[300px]"><canvas id="countryChart"></canvas></div>
                <div class="w-full mt-4 border-t pt-3 flex justify-between items-center text-sm">
                    <span>ç¸½æ›éšªæ§“æ¡¿ (Exposure)</span>
                    <span id="port-leverage" class="font-bold text-blue-700">---x</span>
                </div>
            </div>
        </div>

        <!-- çœ‹æ¿ -->
        <div class="card overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å¸‚å ´è¡¨ç¾çœ‹æ¿ (æ­·å²æ•¸æ“š)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-center border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 border-b">
                            <th class="p-3 text-left">æ¨™çš„</th><th>æœ€æ–°åƒ¹</th><th>ä»Šæ—¥æ¼²è·Œ</th><th>è¿‘ 1 é€±</th><th>è¿‘ 1 æœˆ</th><th>YTD</th><th class="bg-orange-50/50">1å¹´å¹´åŒ–</th><th class="bg-orange-50/50">3å¹´å¹´åŒ–</th><th class="bg-orange-50/50">5å¹´å¹´åŒ–</th><th class="bg-orange-50/50">10å¹´å¹´åŒ–</th>
                        </tr>
                    </thead>
                    <tbody id="perf-body" class="divide-y divide-gray-100 font-mono-num">
                        <tr id="row-IMID"><td colspan="10" class="p-6 italic text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                        <tr id="row-TW"><td colspan="10" class="p-6 italic text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                        <tr id="row-TSMC"><td colspan="10" class="p-6 italic text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr class="border-gray-200 my-8">

        <!-- è’™åœ°å¡ç¾… -->
        <section class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-dice text-blue-600 mr-2"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="card border-t-4 border-blue-500 p-5"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">é€€ä¼‘å¹´æ•¸</h3><input type="number" id="sim-years" value="45" class="text-2xl font-bold font-mono-num outline-none w-full text-center border-b"></div>
                <div class="card border-t-4 border-orange-500 p-5"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">é¦–å¹´æé ˜ç‡ %</h3><input type="number" id="withdraw-rate" value="4.0" step="0.1" class="text-2xl font-bold font-mono-num outline-none w-full text-center border-b"><div class="text-xs mt-2 text-orange-600">é¦–å¹´ <span id="withdraw-amt" class="privacy-target">---</span> è¬</div></div>
                <div class="card border-t-4 border-red-500 p-5"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">é ä¼°é€šè†¨ %</h3><input type="number" id="inflation-rate" value="3.0" step="0.1" class="text-2xl font-bold font-mono-num outline-none w-full text-center border-b"></div>
                <div class="card border-t-4 border-gray-500 p-5"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">éš±æ€§æˆæœ¬ %</h3><input type="number" id="cost-drag" value="1.5" step="0.1" class="text-2xl font-bold font-mono-num outline-none w-full text-center border-b"></div>
                <div class="card border-t-4 border-green-500 bg-green-50 p-5"><h3 class="text-xs font-bold text-green-800 mb-2 uppercase">æé ˜æˆåŠŸç‡ %</h3><div id="success-rate" class="text-3xl font-black text-green-600">---</div></div>
            </div>
            
            <div class="grid grid-cols-1 gap-6">
                <div class="card p-6">
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <select id="withdraw-strategy" class="border-2 border-gray-200 rounded p-2 text-sm font-bold flex-grow outline-none" onchange="updateStrategyDesc()">
                            <option value="fixed-pct">1. å›ºå®šç™¾åˆ†æ¯”æé ˜</option>
                            <option value="swr" selected>2. å›ºå®šé‡‘é¡æé ˜ (SWR)</option>
                            <option value="vanguard">3. Vanguard å‹•æ…‹æ”¯å‡º</option>
                            <option value="gk">4. Guyton-Klinger æ±ºç­–</option>
                            <option value="one-n">5. 1/N æé ˜æ³•</option>
                            <option value="cape">6. CAPE ä¼°å€¼èª¿æ•´</option>
                            <option value="vpw">7. VPW è®Šå‹•ç™¾åˆ†æ¯”</option>
                        </select>
                        <button onclick="runMonteCarlo(true)" class="bg-indigo-600 text-white px-8 py-2 rounded-lg font-bold shadow-lg"><i class="fa-solid fa-play mr-2"></i>é–‹å§‹æ¸¬è©¦</button>
                    </div>
                    <p class="text-xs text-gray-400 mb-6" id="strategy-desc">èªªæ˜ï¼š...</p>
                    
                    <div class="mb-8 overflow-x-auto"><h4 class="text-sm font-bold text-gray-600 mb-3 pl-3 border-l-4">è³‡ç”¢ç´¯ç©è©³ç´°æ•¸æ“š (è¬å…ƒ)</h4><table class="w-full text-sm text-center border"><thead class="bg-gray-100"><tr id="mc-detail-table-head"></tr></thead><tbody id="mc-detail-table-body" class="divide-y font-mono-num"></tbody></table></div>
                    <div class="mb-8 overflow-x-auto"><h4 class="text-sm font-bold text-orange-600 mb-3 pl-3 border-l-4 border-orange-400">é ä¼°æ¯å¹´ç”Ÿæ´»è²» (è¬å…ƒ)</h4><table class="w-full text-sm text-center border"><thead class="bg-orange-50 text-orange-800"><tr id="mc-withdraw-table-head"></tr></thead><tbody id="mc-withdraw-table-body" class="divide-y font-mono-num"></tbody></table></div>
                    
                    <div class="flex justify-between items-center mb-2 border-t pt-6">
                        <h3 class="font-bold text-lg">æœ€çµ‚è³‡ç”¢è·¯å¾‘æ¨¡æ“¬</h3>
                        <button onclick="resetZoom()" class="text-xs bg-gray-100 px-2 py-1 rounded">é‡ç½®ç¸®æ”¾</button>
                    </div>
                    <div class="h-80"><canvas id="mcChart"></canvas></div>
                    <div class="grid grid-cols-3 gap-2 mt-6 text-center text-sm pt-4 border-t">
                        <div><div class="text-[10px] text-green-700 bg-green-50 rounded px-1 inline-block mb-1">ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)</div><div class="text-xl font-bold privacy-target" id="res-low">---</div></div>
                        <div><div class="text-[10px] text-blue-700 bg-blue-50 rounded px-1 inline-block mb-1">ä¸­ä½è¶¨å‹¢ (é æœŸ)</div><div class="text-xl font-bold privacy-target" id="res-p50">---</div></div>
                        <div><div class="text-[10px] text-red-700 bg-red-50 rounded px-1 inline-block mb-1">æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)</div><div class="text-xl font-bold privacy-target" id="res-high">---</div></div>
                    </div>
                </div>
            </div>
            <div id="dynamic-advice" class="strategy-card bg-white border border-blue-100 shadow-sm min-h-[80px]"></div>
        </section>
    </main>

    <div id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        // --- æ ¸å¿ƒé‚è¼¯ (v62 æœ€çµ‚ä¿®æ­£ç‰ˆ) ---
        let isPrivacyMode = false;
        let cachedMcResults = null;
        let globalCAGR = 0;
        let countryChart, mcChart;

        const QUOTES = ["ã€ŒæŠ•è³‡çš„æœ¬è³ªä¸æ˜¯æ“Šæ•—å¸‚å ´ï¼Œè€Œæ˜¯æ§åˆ¶é¢¨éšªã€‚ã€", "ã€Œè€å¿ƒæ˜¯è²¡å¯Œç´¯ç©çš„é—œéµè¦ç´ ã€‚ã€", "ã€Œä¸è¦é æ¸¬é¢¨å‘ï¼Œèª¿æ•´ä½ çš„é¢¨å¸†ã€‚ã€"];
        const API_PROXY = "https://api.allorigins.win/get?url=";

        // --- æ ¼å¼åŒ–å·¥å…· ---
        const fmtMoney = (n) => {
            if (isPrivacyMode) return "******";
            if (n === null || n === undefined || isNaN(n)) return "---";
            if (n <= 0) return "0 è¬";
            const wan = n / 10000;
            if (wan >= 10000) return (wan / 10000).toFixed(2).replace(/\.00$/, '') + " å„„";
            return Math.round(wan).toLocaleString() + " è¬";
        };
        const fmtVal = (n) => isPrivacyMode ? "******" : Math.round(n).toLocaleString();
        const fmtShare = (n) => isPrivacyMode ? "******" : Math.round(n).toLocaleString();
        const getVal = (id) => {
            let el = document.getElementById(id);
            if(!el) return 0;
            let v = (isPrivacyMode && el.dataset.real) ? el.dataset.real : el.value;
            return parseFloat(v.toString().replace(/,/g,'')) || 0;
        };

        function formatCashInput(input) {
            if(isPrivacyMode) return;
            let val = input.value.replace(/[^\d.]/g, '');
            input.value = val ? parseFloat(val).toLocaleString('en-US') : "";
        }

        // --- åˆå§‹åŒ–åœ–è¡¨ ---
        function initCharts() {
            const ctxC = document.getElementById('countryChart').getContext('2d');
            countryChart = new Chart(ctxC, {
                type: 'pie',
                data: { labels: ['ç¾åœ‹','å°ç£','æ­æ´²','äºæ´²(ä¸å«å°ç£)','å…¶ä»–','ç¾é‡‘'], datasets: [{ data: [0,0,0,0,0,0], backgroundColor: ['#2563eb','#16a34a','#9333ea','#f59e0b','#06b6d4','#9ca3af'] }] },
                options: {
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 10 } },
                        datalabels: { color: '#fff', font: { weight: 'bold', size: 11 }, formatter: (v, ctx) => {
                            if (isPrivacyMode) return "";
                            let d = ctx.chart.data.datasets[0].data, sum = d.reduce((a, b) => a + b, 0), p = (v / sum * 100);
                            let sorted = [...d].sort((a,b)=>b-a);
                            return (v >= sorted[2] && p > 1) ? ctx.chart.data.labels[ctx.dataIndex] + "\n" + p.toFixed(1) + "%" : "";
                        }}
                    }
                }
            });

            const ctxM = document.getElementById('mcChart').getContext('2d');
            mcChart = new Chart(ctxM, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { position: 'top', labels: { usePointStyle: true, sort: (a,b) => ['ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)','ä¸­ä½è¶¨å‹¢ (é æœŸ)','æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)'].indexOf(a.text) - ['ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)','ä¸­ä½è¶¨å‹¢ (é æœŸ)','æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)'].indexOf(b.text) } },
                        zoom: { zoom: { wheel: { enabled: true }, pinch: { enabled: true, mode: 'x' }, drag: { enabled: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }, mode: 'x' }, pan: { enabled: true, mode: 'x' } }
                    },
                    scales: { y: { ticks: { callback: v => isPrivacyMode ? "******" : fmtMoney(v) } } }
                }
            });
        }
        function resetZoom(){ if(mcChart) mcChart.resetZoom(); }

        // --- è³‡æ–™æŠ“å–èˆ‡è¨ˆç®— ---
        async function fetchYahooData(symbol) {
            const url = API_PROXY + encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=10y&interval=1d`);
            try {
                const res = await fetch(url);
                const data = await res.json();
                const json = JSON.parse(data.contents);
                const r = json.chart.result[0];
                const q = r.indicators.quote[0].close;
                const t = r.timestamp;
                const h = [];
                for(let i=0; i<t.length; i++) if(q[i]!=null) h.push({date: new Date(t[i]*1000), price: q[i]});
                const prices = h.map(x=>x.price);
                const ret = prices.length > 1 ? (Math.pow(prices[prices.length-1]/prices[0], 1/(prices.length/252)) - 1) : 0;
                const returns = [];
                for(let i=1; i<prices.length; i++) returns.push(Math.log(prices[i]/prices[i-1]));
                const mean = returns.length ? returns.reduce((a,b)=>a+b,0)/returns.length : 0;
                const std = returns.length ? Math.sqrt(returns.map(x=>Math.pow(x-mean, 2)).reduce((a,b)=>a+Math.pow(x-mean, 2),0)/returns.length) : 0;
                const vol = std * Math.sqrt(252);
                return { price: r.meta.regularMarketPrice, prevClose: h[h.length-2].price, history: h, stats: { return: ret, vol: vol } };
            } catch (e) { return null; }
        }

        async function fetchAllData() {
            document.getElementById('status-msg').innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i> é€£ç·šä¸­...';
            const targets = [{ k: 'IMID', s: 'IMID.L' }, { k: 'TW', s: '00631L.TW' }, { k: 'TSMC', s: '2330.TW' }];
            const dataMap = {};
            for (let t of targets) {
                const data = await fetchYahooData(t.s);
                if (data) {
                    dataMap[t.k] = data;
                    document.getElementById('price-'+t.k.toLowerCase()).value = data.price.toFixed(2);
                    renderRow('row-'+t.k, t.k === 'TSMC' ? '2330' : (t.k === 'TW' ? '00631L' : 'IMID'), data);
                }
                await new Promise(r => setTimeout(r, 200));
            }
            window.assetData = dataMap;
            calculateAll(true);
            document.getElementById('status-msg').innerText = "å·²æ›´æ–° " + new Date().toLocaleTimeString();
        }

        function calculateAll(runSim = true) {
            const usd = parseFloat(document.getElementById('usd-rate').value) || 32.5;
            const qI=getVal('qty-imid'), pI=getVal('price-imid'), tI=getVal('target-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw'), tT=getVal('target-tw');
            const qS=getVal('qty-tsmc'), pS=getVal('price-tsmc'), tS=getVal('target-tsmc');
            const vCash=getVal('val-cash'), tCash=getVal('target-cash');

            const vI = Math.round(qI * pI * usd);
            const vT = Math.round(qT * pT);
            const vS = Math.round(qS * pS);
            const total = vI + vT + vS + vCash;

            document.getElementById('val-imid').value = fmtVal(vI);
            document.getElementById('val-tw').value = fmtVal(vT);
            document.getElementById('val-tsmc').value = fmtVal(vS);
            document.getElementById('total-assets').innerText = fmtMoney(total);

            // æ›´æ–°ä½”æ¯”
            const updatePct = (id, v) => document.getElementById(id).innerText = total > 0 ? (v/total*100).toFixed(1)+"%" : "0%";
            updatePct('cur-pct-imid', vI); updatePct('cur-pct-tw', vT); updatePct('cur-pct-tsmc', vS); updatePct('cur-pct-cash', vCash);

            // å»ºè­°æ“ä½œ (ç½®ä¸­ - èˆ‡ å·¦å°é½Š)
            const setAct = (id, adjId, cur, tgt, px) => {
                const diff = (total * (tgt / 100)) - cur;
                const el = document.getElementById(id);
                const elA = document.getElementById(adjId);
                if (isPrivacyMode) { el.innerText = "******"; elA.innerText = "******"; }
                else if (Math.abs(diff) < 10) { el.innerText = "-"; elA.innerText = "-"; el.className="p-3 text-center text-gray-300"; elA.className="p-3 text-center text-gray-300"; }
                else {
                    const type = diff > 0 ? "è²·" : "è³£";
                    el.innerHTML = `<span class="${diff>0?'trend-up':'trend-down'}">${type} ${Math.round(Math.abs(diff/px)).toLocaleString()} è‚¡</span>`;
                    elA.innerHTML = `<span class="${diff>0?'trend-up':'trend-down'}">${Math.round(Math.abs(diff)).toLocaleString()}</span>`;
                    el.className="p-3 text-left font-bold bg-blue-50/30"; elA.className="p-3 text-left font-mono-num bg-blue-50/30";
                }
            };
            setAct('act-imid', 'adj-imid', vI, tI, pI*usd);
            setAct('act-tw', 'adj-tw', vT, tT, pT);
            setAct('act-tsmc', 'adj-tsmc', vS, tS, pS);

            // ç‰¹æ®Šè™•ç†ç¾é‡‘å»ºè­°
            const cDiff = (total*(tCash/100))-vCash;
            const cEl = document.getElementById('act-cash');
            const cAEl = document.getElementById('adj-cash');
            if(isPrivacyMode) { cEl.innerText="******"; cAEl.innerText="******"; }
            else if(Math.abs(cDiff)<10) { cEl.innerText="-"; cAEl.innerText="-"; cEl.className="p-3 text-center text-gray-300"; cAEl.className="p-3 text-center text-gray-300"; }
            else { 
                cEl.innerHTML = `<span class="${cDiff>0?'trend-up':'trend-down'}">${cDiff>0?'å­˜':'å–'} ${Math.round(Math.abs(cDiff/10000))} è¬</span>`; 
                cAEl.innerHTML = `<span class="${cDiff>0?'trend-up':'trend-down'}">${Math.round(Math.abs(cDiff)).toLocaleString()}</span>`;
                cEl.className="p-3 text-left font-bold bg-blue-50/30"; cAEl.className="p-3 text-left font-mono-num bg-blue-50/30";
            }

            // è’™åœ°å¡ç¾…åƒæ•¸èˆ‡ ROI
            const sI = window.assetData?.IMID?.stats || {return:0.09, vol:0.2};
            const sT = { return: (window.assetData?.TW?.stats?.return || 0.25) * 0.7, vol: 0.45 };
            const sS = window.assetData?.TSMC?.stats || {return:0.2, vol:0.3};
            const wI = tI/100, wT = tT/100, wS = tS/100, wC = tCash/100;
            const rPort = (wI*sI.return) + (wT*sT.return) + (wS*sS.return) + (wC*0.01);
            const vPort = (wI*sI.vol) + (wT*sT.vol) + (wS*sS.vol);
            portfolioStats = { totalVal: total, weightedReturn: rPort, weightedVol: vPort };

            const netEquity = total - (getVal('val-loan') * 10000);
            document.getElementById('port-leverage').innerText = netEquity > 0 ? ((vT*2 + vI + vS)/netEquity).toFixed(2)+"x" : "---x";

            calculateReturns(total);
            if (countryChart) {
                countryChart.data.datasets[0].data = [vI*0.58, (vI*0.02 + vT*2 + vS), vI*0.16, vI*0.17, vI*0.07, vCash];
                countryChart.update();
            }
            if (runSim) setTimeout(()=>runMonteCarlo(true), 100);
        }

        function calculateReturns(currentTotal) {
            const cost = getVal('total-cost-input') * 10000;
            const startStr = document.getElementById('invest-start-date').value;
            if(cost > 0 && currentTotal > 0 && startStr) {
                const start = new Date(startStr);
                const years = (new Date() - start) / 31557600000;
                document.getElementById('invest-years').innerText = years.toFixed(1) + " å¹´";
                const roi = (currentTotal - cost) / cost;
                const roiEl = document.getElementById('roi-val');
                roiEl.innerText = (roi >= 0 ? "+" : "") + (roi * 100).toFixed(1) + "%";
                roiEl.className = roi >= 0 ? "trend-up text-lg" : "trend-down text-lg";
                if(years > 0.1) {
                    const cagr = (Math.pow(currentTotal/cost, 1/years) - 1) * 100;
                    globalCAGR = cagr; document.getElementById('cagr-val').innerText = cagr.toFixed(2) + "%";
                    const goal = getVal('fire-goal')*10000;
                    const pct = Math.min(100, (currentTotal/goal)*100);
                    document.getElementById('fire-percent').innerText = pct.toFixed(1) + "%";
                    document.getElementById('fire-progress-bar').style.width = pct + "%";
                    document.getElementById('fire-goal-disp').innerText = getVal('fire-goal');
                    document.getElementById('fire-years-needed').innerText = "é ä¼°éœ€ " + (Math.log(goal/currentTotal)/Math.log(1+cagr/100)).toFixed(1) + " å¹´";
                }
            }
        }

        function runMonteCarlo(recalc) {
            const years = parseInt(document.getElementById('sim-years').value)||45;
            const rate = parseFloat(document.getElementById('withdraw-rate').value)/100;
            const inf = parseFloat(document.getElementById('inflation-rate').value)/100;
            const drag = parseFloat(document.getElementById('cost-drag').value)/100;
            const strategy = document.getElementById('withdraw-strategy').value;
            if(portfolioStats.totalVal <= 0) return;
            if(!recalc && cachedMcResults) { renderMCResults(cachedMcResults); return; }

            const initialW = portfolioStats.totalVal * rate;
            const mu = portfolioStats.weightedReturn - drag, sigma = portfolioStats.weightedVol;
            const simulations = 5000;
            const yearlyData = Array.from({length: years+1}, () => []);
            const yearlyW = Array.from({length: years+1}, () => []);
            let successCount = 0;

            for(let i=0; i<simulations; i++) {
                let cur = portfolioStats.totalVal, w = initialW, prevW = initialW, alive = true;
                yearlyData[0].push(cur); yearlyW[0].push(w);
                for(let y=1; y<=years; y++) {
                    if(!alive) { yearlyData[y].push(0); yearlyW[y].push(0); continue; }
                    const ret = Math.exp(mu - 0.5*sigma*sigma + sigma*(Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random())));
                    cur *= ret;
                    if(strategy === 'swr') w = prevW * (1+inf);
                    else if(strategy === 'one-n') w = cur / (years-y+1);
                    else if(strategy === 'gk') { w = (ret<1)?prevW:prevW*(1+inf); if(w/cur > rate*1.2) w*=0.9; }
                    if(w > cur) w = cur;
                    cur -= w;
                    if(cur <= 0.01) { cur = 0; if(!((strategy==='one-n') && y===years)) alive = false; }
                    prevW = w; yearlyData[y].push(cur); yearlyW[y].push(w);
                }
                if(alive) successCount++;
            }
            const getS = (arr) => { arr.sort((a,b)=>a-b); return [arr[Math.floor(simulations*0.125)], arr[Math.floor(simulations*0.5)], arr[Math.floor(simulations*0.875)]]; };
            const pL=[], pM=[], pH=[], wL=[], wM=[], wH=[];
            for(let y=0; y<=years; y++) {
                const sP = getS(yearlyData[y]); pL.push(sP[0]); pM.push(sP[1]); pH.push(sP[2]);
                const sW = getS(yearlyW[y]); wL.push(sW[0]); wM.push(sW[1]); wH.push(sW[2]);
            }
            cachedMcResults = { years, successRate: successCount/simulations, pL, pM, pH, wL, wM, wH };
            renderMCResults(cachedMcResults);
        }

        function renderMCResults(d) {
            document.getElementById('success-rate').innerText = (d.successRate*100).toFixed(1);
            document.getElementById('res-low').innerText = fmtMoney(d.pL[d.years]);
            document.getElementById('res-p50').innerText = fmtMoney(d.pM[d.years]);
            document.getElementById('res-high').innerText = fmtMoney(d.pH[d.years]);
            document.getElementById('withdraw-amt').innerText = (d.wM[0]/10000).toFixed(0);
            updateMcChart(d.years, d.pL, d.pM, d.pH);
            updateMcTables(d);
            const adv = document.getElementById('dynamic-advice');
            if(d.pL[d.years] <= 0 && d.successRate < 0.9) adv.innerHTML = "<span class='text-red-500 font-bold'>âš ï¸ è­¦å ±ï¼šä¿å®ˆæƒ…å¢ƒå­˜åœ¨æ­¸é›¶é¢¨éšªï¼Œå»ºè­°é™ä½æé ˜æˆ–èª¿æ•´é…ç½®ã€‚</span>";
            else adv.innerText = QUOTES[Math.floor(Math.random()*QUOTES.length)];
        }

        function updateMcTables(d) {
            const head = document.getElementById('mc-detail-table-head'), body = document.getElementById('mc-detail-table-body');
            const wHead = document.getElementById('mc-withdraw-table-head'), wBody = document.getElementById('mc-withdraw-table-body');
            const pts = [3,5,10,20,30,40], now = new Date().getFullYear();
            let hStr = "<th>æƒ…å¢ƒ</th>", rL = "<tr><td class='bg-green-50 font-bold text-green-700'>ä¿å®ˆ</td>", rM = "<tr><td class='bg-blue-50 font-bold text-blue-700'>ä¸­ä½</td>", rH = "<tr><td class='bg-red-50 font-bold text-red-700'>æ¨‚è§€</td>";
            let wL = "<tr><td>ä¿å®ˆæé ˜</td>", wM = "<tr><td>ä¸­ä½æé ˜</td>", wH = "<tr><td>æ¨‚è§€æé ˜</td>";
            pts.forEach(y => {
                if(y <= d.years) {
                    hStr += `<th>ç¬¬${y}å¹´(${now+y})</th>`;
                    rL += `<td>${fmtMoney(d.pL[y])}</td>`; rM += `<td>${fmtMoney(d.pM[y])}</td>`; rH += `<td>${fmtMoney(d.pH[y])}</td>`;
                    wL += `<td>${fmtMoney(d.wL[y])}</td>`; wM += `<td>${fmtMoney(d.wM[y])}</td>`; wH += `<td>${fmtMoney(d.wH[y])}</td>`;
                }
            });
            head.innerHTML = hStr; wHead.innerHTML = hStr; body.innerHTML = rL+"</tr>"+rM+"</tr>"+rH+"</tr>"; wBody.innerHTML = wL+"</tr>"+wM+"</tr>"+wH+"</tr>";
        }

        function updateMcChart(y, L, M, H) {
            const labels = Array.from({length: y+1}, (_, i) => i);
            mcChart.data.labels = labels;
            mcChart.data.datasets = [
                { label: 'ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)', data: L, borderColor: '#16a34a', borderWidth: 2, fill: false, pointRadius: 0 },
                { label: 'æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)', data: H, borderColor: '#dc2626', backgroundColor: 'rgba(253, 224, 71, 0.3)', borderWidth: 2, fill: '-1', pointRadius: 0 },
                { label: 'ä¸­ä½è¶¨å‹¢ (é æœŸ)', data: M, borderColor: '#2563eb', borderWidth: 3, fill: false, pointRadius: 0 }
            ];
            mcChart.update();
        }

        function syncPledgeQty() { document.getElementById('qty-pledge').value = document.getElementById('qty-tw').value; calculateLoanStatus(); }

        function calculateLoanStatus() {
            const qty = getVal('qty-pledge'), price = getVal('price-tw'), loan = getVal('val-loan')*10000;
            if(qty > 0 && price > 0) {
                const mv = qty * price;
                document.getElementById('max-loan-hint').innerText = `æœ€é«˜å¯å€Ÿ: ${Math.floor(mv*0.6/10000)} è¬`;
                if(loan > 0) {
                    const mr = (mv / loan) * 100;
                    document.getElementById('m-rate').innerText = mr.toFixed(1) + "%";
                    const badge = document.getElementById('m-status-badge');
                    if(mr > 166) badge.className="bg-green-100 text-green-700 px-2 rounded font-bold text-xs"; else badge.className="bg-red-100 text-red-700 px-2 rounded font-bold text-xs";
                    badge.innerText = mr > 166 ? "å®‰å…¨ (Safe)" : "å±éšª (Call)";
                    document.getElementById('liquidation-price').innerText = (loan*1.3/qty).toFixed(2);
                    document.getElementById('pledge-leverage').innerText = (mv/(mv-loan)).toFixed(2)+"x";
                    
                    let html = "";
                    [0.1, 0.2, 0.3].forEach(d => {
                        let np = price*(1-d), nmv = qty*np, nmr = (nmv/loan)*100, gap = Math.max(0, loan*1.66 - nmv);
                        html += `<tr><td>-${d*100}%</td><td>${np.toFixed(1)}</td><td>${nmr.toFixed(1)}%</td><td>${nmr>166?'å®‰å…¨':'è¿½ç¹³'}</td><td>${gap>0?Math.round(gap/10000)+'è¬':'-'}</td></tr>`;
                    });
                    document.getElementById('stress-test-body').innerHTML = html;
                }
            }
        }

        function saveData() {
            const data = {
                qtyImid: document.getElementById('qty-imid').value, qtyTw: document.getElementById('qty-tw').value, qtyTsmc: document.getElementById('qty-tsmc').value, valCash: document.getElementById('val-cash').value,
                cost: document.getElementById('total-cost-input').value, date: document.getElementById('invest-start-date').value, goal: document.getElementById('fire-goal').value,
                tI: document.getElementById('target-imid').value, tT: document.getElementById('target-tw').value, tS: document.getElementById('target-tsmc').value, tC: document.getElementById('target-cash').value,
                qP: document.getElementById('qty-pledge').value, vL: document.getElementById('val-loan').value, lR: document.getElementById('loan-rate').value
            };
            localStorage.setItem('portfolio_v62', JSON.stringify(data));
            const x = document.getElementById("toast"); x.className = "show"; setTimeout(()=>x.className="", 3000);
        }

        function loadData() {
            const s = localStorage.getItem('portfolio_v62');
            if(s) {
                const d = JSON.parse(s);
                const mapping = {
                    qtyImid: 'qty-imid', qtyTw: 'qty-tw', qtyTsmc: 'qty-tsmc', valCash: 'val-cash',
                    cost: 'total-cost-input', date: 'invest-start-date', goal: 'fire-goal',
                    tI: 'target-imid', tT: 'target-tw', tS: 'target-tsmc', tC: 'target-cash',
                    qP: 'qty-pledge', vL: 'val-loan', lR: 'loan-rate'
                };
                Object.keys(mapping).forEach(k => { if(d[k]) document.getElementById(mapping[k]).value = d[k]; });
            }
        }

        function togglePrivacy() {
            isPrivacyMode = !isPrivacyMode;
            document.querySelectorAll('.privacy-target').forEach(el => isPrivacyMode ? el.classList.add('privacy-blur') : el.classList.remove('privacy-blur'));
            calculateAll(false);
        }

        window.onload = () => { loadData(); initCharts(); fetchAllData(); updateStrategyDesc(); };
    </script>
</body>
</html>
