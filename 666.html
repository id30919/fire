<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³‡ç”¢æˆ°æƒ…å®¤ (v62 å´©æ½°ä¿®å¾©ç‰ˆ)</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“ˆ</text></svg>">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { font-family: 'Roboto', 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif; background-color: #f3f4f6; color: #374151; }
        .font-mono-num { font-family: 'Roboto Mono', monospace; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 16px; border: 1px solid #e5e7eb; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .card { padding: 24px; } }
        .input-val { width: 100%; padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; text-align: right; font-weight: 700; font-family: 'Roboto Mono', monospace; transition: all 0.2s; color: #1f2937; }
        .input-val:focus { border-color: #2563eb; outline: none; background-color: #eff6ff; }
        .calc-val { border: none; background: transparent; text-align: right; font-family: 'Roboto Mono', monospace; color: #374151; width: 100%; font-size: inherit; }
        .trend-up { color: #dc2626; font-weight: 700; }
        .trend-down { color: #16a34a; font-weight: 700; }
        .privacy-blur { color: transparent !important; text-shadow: 0 0 8px rgba(0,0,0,0.5); user-select: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 16px; position: fixed; z-index: 99; left: 50%; bottom: 30px; font-size: 17px; }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        .macro-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
        @media (max-width: 1024px) { .macro-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 640px) { .macro-grid { grid-template-columns: repeat(2, 1fr); } }
        .signal-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-bottom: 2px; white-space: nowrap; }
        .sig-buy-strong { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; } 
        .sig-buy { background-color: #d1fae5; color: #047857; border: 1px solid #a7f3d0; } 
        .sig-neutral { background-color: #f3f4f6; color: #9ca3af; }
        .loan-safe { color: #16a34a; }
        .loan-warn { color: #ca8a04; }
        .loan-danger { color: #dc2626; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .stress-table-container { max-height: 200px; overflow-y: auto; }
        .strategy-card { border-left: 4px solid #3b82f6; background: #f8fafc; padding: 16px; margin-bottom: 12px; border-radius: 8px; font-size: 0.95rem; line-height: 1.5; }
        .strategy-title { font-weight: 700; color: #1e40af; display: block; margin-bottom: 6px; font-size: 1.05rem; }
        th { font-weight: 700; letter-spacing: 0.02em; }
        td { font-variant-numeric: tabular-nums; }
    </style>
</head>
<body class="pb-20 overflow-x-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 backdrop-blur-md bg-white/90">
        <div class="w-full max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4 box-border">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight flex items-center justify-center lg:justify-start">
                    <i class="fa-solid fa-chart-pie text-blue-600 mr-2"></i>è³‡ç”¢æˆ°æƒ…å®¤ & é€€ä¼‘æ¨¡æ“¬
                </h1>
                <div class="flex items-center justify-center lg:justify-start gap-2 mt-3 flex-wrap">
                    <button onclick="saveData()" class="text-xs bg-green-50 hover:bg-green-100 text-green-700 px-4 py-2 rounded-full transition font-medium border border-green-200">
                        <i class="fa-solid fa-floppy-disk mr-1"></i>å„²å­˜è¨­å®š
                    </button>
                    <button onclick="togglePrivacy()" id="btn-privacy" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-full transition font-medium border border-gray-300">
                        <i class="fa-solid fa-eye-slash mr-1"></i>éš±è—è³‡ç”¢
                    </button>
                    <button onclick="fetchAllData()" class="text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 px-4 py-2 rounded-full transition font-medium border border-blue-200">
                        <i class="fa-solid fa-sync-alt mr-1"></i>åˆ·æ–°å ±åƒ¹
                    </button>
                    <span id="status-msg" class="text-xs text-gray-500 font-medium font-mono-num ml-2"></span>
                </div>
            </div>
            <div class="flex items-center justify-center md:justify-end gap-6 w-full md:w-auto border-t md:border-t-0 pt-3 md:pt-0 border-gray-100">
                <div class="flex flex-col items-start border-r pr-6 border-gray-200">
                    <div class="text-xs text-gray-500 font-medium mb-1">USD/TWD</div>
                    <input type="number" id="usd-rate" value="32.5" class="text-xl font-bold text-blue-600 w-20 text-left bg-transparent border-none focus:ring-0 p-0 m-0 font-mono-num" onchange="calculateAll()">
                </div>
                <div class="text-center md:text-right">
                    <div class="text-xs text-gray-500 font-medium mb-1">ç›®å‰å¸³é¢ç¸½è³‡ç”¢ (TWD)</div>
                    <div class="text-3xl font-bold text-gray-800 tracking-tight font-mono-num privacy-target" id="total-assets">---</div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">

        <!-- å®è§€çœ‹æ¿ -->
        <section class="card border-l-4 border-slate-600">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center justify-between">
                <span><i class="fa-solid fa-globe mr-2 text-slate-600"></i>å…¨çƒå®è§€æ™¯æ°£å„€è¡¨æ¿ (Global Macro)</span>
                <span id="macro-summary" class="text-xs px-2 py-1 rounded bg-gray-100 text-gray-500">è¼‰å…¥ä¸­...</span>
            </h3>
            <div class="macro-grid" id="macro-container">
                <div class="text-center p-3 bg-gray-50 rounded text-gray-400 text-xs">æ•¸æ“šæº–å‚™ä¸­...</div>
            </div>
        </section>

        <!-- è³ªæŠ¼ç›£æ§ -->
        <section class="card border-l-4 border-yellow-500 bg-yellow-50/20">
            <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-landmark mr-2 text-yellow-600"></i>è‚¡ç¥¨è³ªæŠ¼ç›£æ§ (00631L)
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm">
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>è³ªæŠ¼å¼µæ•¸ (å¼µ)</span>
                                <span class="text-[10px] cursor-pointer text-blue-500 hover:text-blue-700" onclick="syncPledgeQty()">ğŸ”„ åŒæ­¥æŒè‚¡</span>
                            </div>
                            <input type="number" id="qty-pledge" value="0" class="input-val text-center font-mono-num privacy-target" oninput="calculateLoanStatus()">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span>å€Ÿæ¬¾é‡‘é¡ (è¬)</span>
                                <span class="text-[10px] text-gray-400" id="max-loan-hint">æœ€é«˜å¯å€Ÿ: 0 è¬</span>
                            </div>
                            <input type="number" id="val-loan" value="0" class="input-val text-center font-mono-num font-bold text-red-600 privacy-target" oninput="calculateLoanStatus(); calculateAll(true)">
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 mb-1">å¹´åˆ©ç‡ (%)</div>
                            <input type="number" id="loan-rate" value="2.35" step="0.01" class="input-val text-center font-mono-num privacy-target" oninput="calculateLoanStatus()">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm flex flex-col justify-between">
                    <div class="text-center">
                        <div class="text-xs text-gray-500 mb-1">ç›®å‰ç¶­æŒç‡</div>
                        <div class="text-4xl font-black font-mono-num mb-1" id="m-rate">---%</div>
                        <div id="m-status-badge" class="inline-block px-2 py-1 rounded text-xs font-bold bg-gray-100 text-gray-400">æœªå€Ÿæ¬¾</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-100">
                        <div class="text-center">
                            <div class="text-[10px] text-gray-400">00631L ç¾åƒ¹</div>
                            <div class="text-base font-bold text-gray-700 font-mono-num" id="current-tw-price">---</div>
                        </div>
                        <div class="text-center border-l border-gray-100">
                            <div class="text-[10px] text-gray-400">è²¡å‹™æ§“æ¡¿ (Financing)</div>
                            <div id="pledge-leverage" class="font-bold text-blue-600 font-mono-num text-base">---x</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-0 rounded-lg border border-yellow-200 shadow-sm overflow-hidden flex flex-col h-[240px]">
                    <div class="bg-yellow-50 px-3 py-2 text-xs font-bold text-yellow-800 border-b border-yellow-100 flex-shrink-0">ğŸ“‰ å£“åŠ›æ¸¬è©¦</div>
                    <div class="stress-table-container flex-grow">
                        <table class="w-full text-xs text-center">
                            <thead class="bg-gray-50 text-gray-500 sticky top-0 z-10">
                                <tr><th>è·Œå¹…</th><th>è‚¡åƒ¹</th><th>ç¶­æŒç‡</th><th>ç‹€æ…‹</th><th>éœ€è£œé‡‘é¡</th></tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 font-mono-num" id="stress-test-body">
                                <tr><td colspan="5" class="py-10 text-gray-300">è«‹è¼¸å…¥å€Ÿæ¬¾é‡‘é¡</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- ç¸¾æ•ˆé€Ÿç®— -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-stretch">
            <div class="card border-l-4 border-purple-500">
                <h3 class="text-base font-bold text-gray-800 mb-4 flex items-center"><i class="fa-solid fa-calculator mr-2 text-purple-600"></i>æŠ•è³‡ç¸¾æ•ˆé€Ÿç®— (ç¸½è³‡ç”¢åŸºæº–)</h3>
                <div class="grid grid-cols-2 gap-6 mb-4 text-center">
                    <div>
                        <label class="text-xs text-gray-500 mb-1">ç¸½æŠ•å…¥æœ¬é‡‘</label>
                        <div class="flex items-center border-b border-gray-300"><input type="text" id="total-cost-input" value="100" class="w-full text-center font-bold text-lg privacy-target font-mono-num outline-none" oninput="formatCashInput(this); calculateReturns();"><span class="text-sm">è¬</span></div>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 mb-1">é–‹å§‹æŠ•è³‡æ—¥æœŸ</label>
                        <input type="date" id="invest-start-date" value="2024-01-01" class="w-full text-center text-sm border-b border-gray-300 outline-none" onchange="calculateReturns();">
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 bg-purple-50 p-3 rounded-lg text-center mt-auto font-mono-num">
                    <div><div class="text-[10px] text-gray-500">æŠ•è³‡å¹´æ•¸</div><div class="font-bold text-lg" id="invest-years">---</div></div>
                    <div><div class="text-[10px] text-gray-500">ç¸½å ±é…¬ç‡</div><div class="font-bold text-lg" id="roi-val">---</div></div>
                    <div><div class="text-[10px] text-gray-500">å¹´åŒ–å ±é…¬</div><div class="font-bold text-lg" id="cagr-val">---</div></div>
                </div>
            </div>

            <div class="card border-l-4 border-pink-500">
                <h3 class="text-base font-bold text-gray-800 mb-2"><i class="fa-solid fa-flag-checkered text-pink-500 mr-2"></i>FIRE è‡ªç”±é€²åº¦</h3>
                <div class="flex justify-between items-center mb-2">
                    <span id="fire-percent" class="text-2xl font-black text-pink-600">0%</span>
                    <div class="flex items-center gap-1 border-b"><span class="text-xs">ç›®æ¨™:</span><input type="text" id="fire-goal" value="1000" class="w-20 text-center font-bold privacy-target font-mono-num outline-none"><span class="text-xs">è¬</span></div>
                </div>
                <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden"><div id="fire-progress-bar" class="bg-pink-500 h-full transition-all duration-500" style="width: 0%"></div></div>
                <div id="fire-years-needed" class="text-center text-xs text-gray-400 mt-2">æŒ‰ç›®å‰ç¸¾æ•ˆé ä¼°éœ€ --- å¹´</div>
            </div>
        </div>

        <!-- æŠ•è³‡çµ„åˆ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card lg:col-span-2 overflow-x-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-6">æŠ•è³‡çµ„åˆæ˜ç´°</h2>
                <table class="w-full min-w-[750px] text-sm">
                    <thead>
                        <tr class="bg-gray-50 text-gray-600 border-b border-gray-200">
                            <th class="p-3 text-left">æ¨™çš„</th>
                            <th class="p-3 text-center">æŠ€è¡“åˆ†æ</th>
                            <th class="p-3 text-center">æŒæœ‰è‚¡æ•¸/é‡‘é¡</th>
                            <th class="p-3 text-center w-32">å¸‚åƒ¹ (åŸå¹£)</th>
                            <th class="p-3 text-right">å¸‚å€¼ (TWD)</th>
                            <th class="p-3 text-center bg-gray-100/50">ç›®å‰ %</th>
                            <th class="p-3 text-center bg-blue-50/50">ç›®æ¨™ %</th>
                            <th class="p-3 text-center bg-blue-50/50">å»ºè­°æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 font-mono-num">
                        <tr>
                            <td class="p-3 font-bold text-purple-700">IMID <span class="text-xs font-normal text-gray-400 block">è‹±è‚¡ (USD)</span></td>
                            <td class="p-3 text-center" id="sig-imid"><span class="text-gray-300">-</span></td>
                            <td class="p-3 text-left"><input type="text" id="qty-imid" value="0" class="input-val text-left privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-imid" value="35.5" class="input-val text-left text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-imid">0</td>
                            <td class="p-3 text-center font-bold text-gray-400" id="cur-pct-imid">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-imid" value="60" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left bg-blue-50/30 privacy-target" id="act-imid">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-green-700">00631L <span class="text-xs font-normal text-gray-400 block">å°ç£50æ­£2</span></td>
                            <td class="p-3 text-center" id="sig-tw"><span class="text-gray-300">-</span></td>
                            <td class="p-3 text-left"><input type="text" id="qty-tw" value="0" class="input-val text-left privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-tw" value="161.03" class="input-val text-left text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-tw">0</td>
                            <td class="p-3 text-center font-bold text-gray-400" id="cur-pct-tw">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tw" value="40" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left bg-blue-50/30 privacy-target" id="act-tw">-</td>
                        </tr>
                        <tr>
                            <td class="p-3 font-bold text-blue-700">2330 <span class="text-xs font-normal text-gray-400 block">å°ç©é›»</span></td>
                            <td class="p-3 text-center" id="sig-tsmc"><span class="text-gray-300">-</span></td>
                            <td class="p-3 text-left"><input type="text" id="qty-tsmc" value="0" class="input-val text-left privacy-target" oninput="calculateAll()"></td>
                            <td class="p-3 text-left"><input type="number" id="price-tsmc" value="1000" class="input-val text-left text-blue-600" oninput="calculateAll()"></td>
                            <td class="p-3 text-right font-bold privacy-target" id="val-tsmc">0</td>
                            <td class="p-3 text-center font-bold text-gray-400" id="cur-pct-tsmc">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-tsmc" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left bg-blue-50/30 privacy-target" id="act-tsmc">-</td>
                        </tr>
                        <tr class="bg-gray-50/50">
                            <td class="p-3 font-bold text-gray-600">ç¾é‡‘ <span class="text-xs font-normal text-gray-400 block">TWD</span></td>
                            <td class="p-3 text-center">-</td>
                            <td class="p-3"><input type="text" id="val-cash" value="1,000,000" class="input-val text-left font-bold privacy-target" oninput="formatCashInput(this); calculateAll()"></td>
                            <td class="p-3 text-center">-</td>
                            <td class="p-3">-</td>
                            <td class="p-3 text-center font-bold text-gray-400" id="cur-pct-cash">0%</td>
                            <td class="p-3 bg-blue-50/30"><input type="number" id="target-cash" value="0" class="input-val text-center" oninput="calculateAll()"></td>
                            <td class="p-3 text-left bg-blue-50/30 privacy-target" id="act-cash">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- åœ“é¤…åœ– -->
            <div class="card flex flex-col items-center">
                <h3 class="text-base font-bold text-gray-700 mb-4 w-full flex items-center justify-between"><span>å€åŸŸæ›éšªæ¨ä¼°</span></h3>
                <div class="relative w-full flex-grow min-h-[300px]"><canvas id="countryChart"></canvas></div>
                <div class="grid grid-cols-2 gap-2 w-full mt-4 border-t pt-3">
                    <div class="text-center"><div class="text-[10px] text-gray-400">ç¸½æ›éšªæ§“æ¡¿ (Exposure)</div><div id="port-leverage" class="font-bold text-blue-700 font-mono-num text-lg">---x</div></div>
                    <div class="text-center border-l"><div class="text-[10px] text-gray-400">ç¾é‡‘æ°´ä½</div><div id="cash-ratio" class="font-bold text-gray-600 font-mono-num text-lg">---%</div></div>
                </div>
                <div id="risk-eval" class="w-full mt-2 text-center text-xs p-2 rounded bg-gray-50 border font-medium text-gray-600">ç­‰å¾…æ•¸æ“šä¸­...</div>
            </div>
        </div>

        <!-- çœ‹æ¿ -->
        <div class="card overflow-hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å¸‚å ´è¡¨ç¾çœ‹æ¿ (æ­·å²æ•¸æ“š)</h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-center border-collapse">
                    <thead class="bg-gray-100 text-gray-600 border-b">
                        <tr><th class="p-3 text-left">æ¨™çš„</th><th>æœ€æ–°åƒ¹</th><th>ä»Šæ—¥æ¼²è·Œ</th><th>è¿‘ 1 é€±</th><th>è¿‘ 1 æœˆ</th><th>YTD</th><th class="bg-orange-50/50">1å¹´å¹´åŒ–</th><th class="bg-orange-50/50">3å¹´å¹´åŒ–</th><th class="bg-orange-50/50">5å¹´å¹´åŒ–</th><th class="bg-orange-50/50">10å¹´å¹´åŒ–</th></tr>
                    </thead>
                    <tbody id="perf-body" class="divide-y divide-gray-100 font-mono-num">
                        <tr id="row-IMID"><td colspan="10" class="p-6 italic text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                        <tr id="row-TW"><td colspan="10" class="p-6 italic text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                        <tr id="row-TSMC"><td colspan="10" class="p-6 italic text-gray-400">è¼‰å…¥ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <hr class="border-gray-200 my-8">

        <!-- è’™åœ°å¡ç¾… -->
        <section class="space-y-6">
            <h2 class="text-2xl font-bold text-gray-900"><i class="fa-solid fa-dice text-blue-600 mr-2"></i>è’™åœ°å¡ç¾…é€€ä¼‘æé ˜æ¨¡æ“¬</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="card border-t-4 border-blue-500 p-5"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">é€€ä¼‘å¹´æ•¸</h3><input type="number" id="sim-years" value="45" class="text-2xl font-bold font-mono-num border-b-2 outline-none w-full text-center"></div>
                <div class="card border-t-4 border-orange-500 p-5"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">æé ˜ç‡</h3><input type="number" id="withdraw-rate" value="4.0" step="0.1" class="text-2xl font-bold font-mono-num border-b-2 outline-none w-full text-center"><div class="text-[10px] text-orange-600 mt-2">é¦–å¹´æé ˜ <span id="withdraw-amt" class="privacy-target font-bold">---</span> è¬</div></div>
                <div class="card border-t-4 border-red-500 p-5"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">é€šè†¨ç‡</h3><input type="number" id="inflation-rate" value="3.0" step="0.1" class="text-2xl font-bold font-mono-num border-b-2 outline-none w-full text-center"></div>
                <div class="card border-t-4 border-gray-500 p-5"><h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">éš±æ€§æˆæœ¬</h3><input type="number" id="cost-drag" value="1.5" step="0.1" class="text-2xl font-bold font-mono-num border-b-2 outline-none w-full text-center"></div>
                <div class="card border-t-4 border-green-500 bg-green-50 p-5"><h3 class="text-xs font-bold text-green-800 mb-2 uppercase">æé ˜æˆåŠŸç‡</h3><div class="text-2xl font-bold text-green-600 font-mono-num" id="success-rate">---%</div></div>
            </div>
            
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex gap-2">
                        <select id="withdraw-strategy" class="border rounded p-1 text-sm font-bold" onchange="runMonteCarlo(true)">
                            <option value="swr">å›ºå®šé‡‘é¡ (SWR)</option>
                            <option value="one-n">1/N æé ˜æ³•</option>
                            <option value="gk">Guyton-Klinger</option>
                        </select>
                        <button onclick="runMonteCarlo(true)" class="bg-indigo-600 text-white px-3 py-1 rounded text-sm font-bold">é–‹å§‹æ¸¬è©¦</button>
                    </div>
                    <button onclick="resetZoom()" class="text-xs bg-gray-100 p-1 rounded">é‡ç½®ç¸®æ”¾</button>
                </div>
                <div class="h-80"><canvas id="mcChart"></canvas></div>
                <div class="grid grid-cols-3 gap-2 mt-6 text-center text-sm border-t pt-4">
                    <div><div class="text-[10px] text-green-700 bg-green-50 px-1 rounded inline-block">ä¿å®ˆæƒ…å¢ƒ</div><div class="font-bold text-lg privacy-target" id="res-low">---</div></div>
                    <div><div class="text-[10px] text-blue-700 bg-blue-50 px-1 rounded inline-block">ä¸­ä½è¶¨å‹¢</div><div class="font-bold text-lg privacy-target" id="res-p50">---</div></div>
                    <div><div class="text-[10px] text-red-700 bg-red-50 px-1 rounded inline-block">æ¨‚è§€æƒ…å¢ƒ</div><div class="font-bold text-lg privacy-target" id="res-high">---</div></div>
                </div>
                
                <!-- è©³ç´°è¡¨ -->
                <div class="mt-6 overflow-x-auto">
                    <table class="w-full text-xs text-center border">
                        <thead class="bg-gray-50 text-gray-500"><tr id="mc-detail-table-head"></tr></thead>
                        <tbody id="mc-detail-table-body" class="font-mono-num"></tbody>
                    </table>
                </div>
                <div class="mt-4 overflow-x-auto">
                    <table class="w-full text-xs text-center border">
                        <thead class="bg-orange-50 text-orange-800"><tr id="mc-withdraw-table-head"></tr></thead>
                        <tbody id="mc-withdraw-table-body" class="font-mono-num"></tbody>
                    </table>
                </div>
            </div>
            <div id="dynamic-advice" class="strategy-card bg-white italic text-gray-500">ç­‰å¾…æ¨¡æ“¬é‹ç®—...</div>
        </section>
    </main>

    <div id="toast">è¨­å®šå·²å„²å­˜</div>

    <script>
        // --- ä¿®æ­£å¾Œçš„æ ¸å¿ƒé‚è¼¯ ---
        let isPrivacyMode = false;
        let cachedMcResults = null;
        let globalCAGR = 0;
        const QUOTES = ["ã€ŒæŠ•è³‡çš„æœ¬è³ªä¸æ˜¯æ“Šæ•—å¸‚å ´ï¼Œè€Œæ˜¯æ§åˆ¶é¢¨éšªã€‚ã€", "ã€Œæ™‚é–“æ˜¯æŠ•è³‡è€…æœ€å¥½çš„æœ‹å‹ã€‚ã€", "ã€Œè¤‡åˆ©æ˜¯ä¸–ç•Œç¬¬å…«å¤§å¥‡è¹Ÿã€‚ã€"];
        const SYMBOLS = { IMID: "IMID.L", TW: "00631L.TW", TSMC: "2330.TW" };
        const MACRO_SYMBOLS = { VIX: "^VIX", DXY: "DX-Y.NYB", US10Y: "^TNX", HYG: "HYG", COPPER: "HG=F", GLOBAL: "ACWI", USDTWD: "TWD=X" };

        // ä½¿ç”¨ AllOrigins ä½œç‚ºè¼ƒç©©å®šçš„ Proxy
        const API_PROXY = "https://api.allorigins.win/get?url=";

        const fmtMoney = (n) => {
            if (isPrivacyMode) return "******";
            if (n === null || n === undefined || isNaN(n)) return "---";
            if (n <= 0) return "0 è¬";
            const wan = n / 10000;
            if (wan >= 10000) return (wan / 10000).toFixed(2).replace(/\.00$/, '') + " å„„";
            return Math.round(wan).toLocaleString() + " è¬";
        };
        const fmtVal = (n) => isPrivacyMode ? "******" : Math.round(n).toLocaleString();
        const fmtShare = (n) => isPrivacyMode ? "******" : Math.round(n).toLocaleString();
        const fmtPct = (n) => (n==null||isNaN(n)) ? "---" : `<span class="${n>=0?'trend-up':'trend-down'}">${n>=0?'+':''}${n.toFixed(2)}%</span>`;

        function formatCashInput(input) {
            if(isPrivacyMode) return;
            let val = input.value.replace(/[^\d.]/g, '');
            input.value = val ? parseFloat(val).toLocaleString('en-US') : "";
        }

        // --- æ ¸å¿ƒæ›´æ–°åŠŸèƒ½ ---
        async function fetchYahooData(symbol) {
            const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=10y&interval=1d`;
            const fullUrl = API_PROXY + encodeURIComponent(targetUrl);
            try {
                const res = await fetch(fullUrl);
                const data = await res.json();
                const json = JSON.parse(data.contents);
                
                if (!json.chart.result) return null;
                const r = json.chart.result[0];
                const q = r.indicators.quote[0].close;
                const t = r.timestamp;
                const h = [];
                for(let i=0; i<t.length; i++) if(q[i]!=null) h.push({date: new Date(t[i]*1000), price: q[i]});
                
                const prices = h.map(x=>x.price);
                const ret = prices.length > 1 ? (Math.pow(prices[prices.length-1]/prices[0], 1/(prices.length/252)) - 1) : 0;
                const returns = [];
                for(let i=1; i<prices.length; i++) returns.push(Math.log(prices[i]/prices[i-1]));
                const mean = returns.length ? returns.reduce((a,b)=>a+b,0)/returns.length : 0;
                const std = returns.length ? Math.sqrt(returns.map(x=>Math.pow(x-mean, 2)).reduce((a,b)=>a+Math.pow(x-mean, 2),0)/returns.length) : 0;
                const vol = std * Math.sqrt(252);

                return { price: r.meta.regularMarketPrice, prevClose: h[h.length-2].price, history: h, stats: { return: ret, vol: vol } };
            } catch (e) { return null; }
        }

        function calculateAll(runSim = true) {
            const usd = parseFloat(document.getElementById('usd-rate').value)||32.5;
            const qI=getVal('qty-imid'), pI=getVal('price-imid'), tI=getVal('target-imid');
            const qT=getVal('qty-tw'), pT=getVal('price-tw'), tT=getVal('target-tw');
            const qTSMC=getVal('qty-tsmc'), pTSMC=getVal('price-tsmc'), tTSMC=getVal('target-tsmc');
            const vCash = getVal('val-cash'), tCash = getVal('target-cash');

            const vI = Math.round(qI*pI*usd);
            const vT = Math.round(qT*pT);
            const vTSMC = Math.round(qTSMC*pTSMC);
            const total = vI+vT+vTSMC+vCash;

            document.getElementById('val-imid').value = fmtVal(vI);
            document.getElementById('val-tw').value = fmtVal(vT);
            document.getElementById('val-tsmc').value = fmtVal(vTSMC);
            document.getElementById('total-assets').innerText = fmtMoney(total);

            // æ›´æ–°ä½”æ¯”
            const updatePct = (id, v) => {
                const el = document.getElementById(id);
                if(el) el.innerText = total > 0 ? (v/total*100).toFixed(1)+"%" : "0%";
            };
            updatePct('cur-pct-imid', vI); updatePct('cur-pct-tw', vT); updatePct('cur-pct-tsmc', vTSMC); updatePct('cur-pct-cash', vCash);

            const setAct = (id, adjId, cur, tgtPct, px, isC) => {
                const diff = (total*(tgtPct/100)) - cur;
                let txt = "-"; let adjTxt = "-";
                if(isPrivacyMode) { txt = "******"; adjTxt = "******"; }
                else {
                    if(isC && Math.abs(diff)>1) txt = `<span class="${diff>0?'text-red-500':'text-green-600'}">${diff>0?'å­˜':'å–'} ${fmtMoney(Math.abs(diff))}</span>`;
                    else if(px>0) {
                        const s = Math.round(diff/px);
                        if(s!=0) txt = `<span class="${s>0?'text-red-500':'text-green-600'}">${s>0?'è²·':'è³£'} ${fmtShare(Math.abs(s))} è‚¡</span>`;
                    }
                    if(Math.abs(diff)>1) adjTxt = `<span class="${diff>0?'text-red-500':'text-green-600'}">${Math.round(Math.abs(diff)).toLocaleString()}</span>`;
                }
                const el = document.getElementById(id); if(el) el.innerHTML = txt;
                const elAdj = document.getElementById(adjId); if(elAdj) elAdj.innerHTML = adjTxt;
            };
            setAct('act-imid', 'adj-imid', vI, tI, pI*usd, false);
            setAct('act-tw', 'adj-tw', vT, tT, pT, false);
            setAct('act-tsmc', 'adj-tsmc', vTSMC, tTSMC, pTSMC, false);
            setAct('act-cash', 'adj-cash', vCash, tCash, 1, true);

            // é¢¨æ§èˆ‡æ§“æ¡¿ (Exposure)
            const loanVal = getVal('val-loan') * 10000;
            const netEquity = total - loanVal;
            if(netEquity > 0) {
                const exp = (vT * 2) + vI + vTSMC;
                const lev = exp / netEquity;
                document.getElementById('port-leverage').innerText = lev.toFixed(2) + "x";
                document.getElementById('cash-ratio').innerText = (vCash/total*100).toFixed(1) + "%";
                document.getElementById('risk-eval').innerHTML = getRiskComment(lev, vCash/total*100);
            }

            calculateReturns();
            calculateFireRunway();

            if(countryChart) {
                countryChart.data.datasets[0].data = [(vI*0.58), ((vI*0.02)+(vT*2)+vTSMC), (vI*0.16), (vI*0.17), (vI*0.07), vCash];
                countryChart.update();
            }
            if(runSim) setTimeout(()=>runMonteCarlo(true), 100);
        }

        // --- ä»¥ä¸‹ç‚ºä¿®æ­£å¾Œçš„è’™åœ°å¡ç¾…èˆ‡å¸¸ç”¨å‡½å¼ ---
        const getVal = (id) => {
            let el = document.getElementById(id);
            if(!el) return 0;
            let valStr = (isPrivacyMode && el.dataset.real) ? el.dataset.real : el.value;
            return parseFloat(valStr.toString().replace(/,/g,'')) || 0;
        };

        function calculateReturns() {
            const cost = getVal('total-cost-input') * 10000;
            const total = parseFloat(document.getElementById('total-assets').innerText.replace(/[^0-9]/g, '')) * (document.getElementById('total-assets').innerText.includes('å„„')?100000000:10000) || 0;
            const startStr = document.getElementById('invest-start-date').value;
            if(cost > 0 && startStr && total > 0) {
                const start = new Date(startStr); const years = (new Date() - start) / 31557600000;
                document.getElementById('invest-years').innerText = years.toFixed(1) + " å¹´";
                const profit = total - cost; const roi = (profit/cost)*100;
                const roiEl = document.getElementById('roi-val'); roiEl.innerText = (roi>=0?"+":"")+roi.toFixed(1)+"%";
                roiEl.className = roi>=0?"trend-up text-lg font-mono-num":"trend-down text-lg font-mono-num";
                document.getElementById('total-profit').innerText = fmtMoney(profit);
                document.getElementById('monthly-profit').innerText = Math.round(profit/(years*12 || 1)/10000)+" è¬";
                document.getElementById('asset-multiple').innerText = (total/cost).toFixed(2)+"x";
                if(years > 0.1) {
                    const cagr = (Math.pow(total/cost, 1/years)-1)*100;
                    globalCAGR = cagr; document.getElementById('cagr-val').innerText = cagr.toFixed(2)+"%";
                }
            }
        }

        function calculateFireRunway() {
            const total = parseFloat(document.getElementById('total-assets').innerText.replace(/[^0-9]/g, '')) * (document.getElementById('total-assets').innerText.includes('å„„')?100000000:10000) || 0;
            const goal = getVal('fire-goal')*10000;
            if(goal > 0) {
                const pct = Math.min(100, (total/goal)*100);
                document.getElementById('fire-percent').innerText = pct.toFixed(1)+"%";
                document.getElementById('fire-progress-bar').style.width = pct+"%";
                if(globalCAGR > 0) document.getElementById('fire-years-needed').innerText = "é ä¼°éœ€ " + (Math.log(goal/total)/Math.log(1+globalCAGR/100)).toFixed(1) + " å¹´";
            }
        }

        function runMonteCarlo(recalculate) {
            const years = parseInt(document.getElementById('sim-years').value)||45;
            const ratePct = parseFloat(document.getElementById('withdraw-rate').value)||4.0;
            const inflation = parseFloat(document.getElementById('inflation-rate').value)/100;
            const drag = parseFloat(document.getElementById('cost-drag').value)/100;
            const strategy = document.getElementById('withdraw-strategy').value;
            const startVal = portfolioStats.totalVal;
            if(startVal <= 0) return;

            if(!recalculate && cachedMcResults) { renderMCResults(cachedMcResults); return; }

            const initialW = startVal * (ratePct/100);
            const simulations = 5000;
            const mu = portfolioStats.weightedReturn - drag;
            const sigma = portfolioStats.weightedVol;
            const yearlyData = Array.from({length: years+1}, () => []);
            const yearlyW = Array.from({length: years+1}, () => []);
            let successCount = 0;

            for(let i=0; i<simulations; i++) {
                let cur = startVal; let w = initialW; let prevW = initialW; let alive = true;
                yearlyData[0].push(cur); yearlyW[0].push(w);
                for(let y=1; y<=years; y++) {
                    if(!alive) { yearlyData[y].push(0); yearlyW[y].push(0); continue; }
                    const ret = Math.exp(mu - 0.5*sigma*sigma + sigma*(Math.sqrt(-2*Math.log(Math.random()))*Math.cos(2*Math.PI*Math.random())));
                    cur *= ret;
                    if(strategy==='swr') w = prevW*(1+inflation);
                    else if(strategy==='one-n') w = cur/(years-y+1);
                    else if(strategy==='gk') { w = (ret<1)?prevW:prevW*(1+inflation); if(w/cur > (ratePct/100)*1.2) w*=0.9; }
                    
                    if(w > cur) w = cur;
                    cur -= w;
                    // ä¿®æ­£æ ¸å¿ƒï¼šæœ€å¾Œä¸€å¹´æ­¸é›¶è¦–ç‚ºæˆåŠŸ
                    if(cur <= 0.01) { 
                        cur = 0; 
                        if(!((strategy==='one-n') && y===years)) alive = false; 
                    }
                    prevW = w; yearlyData[y].push(cur); yearlyW[y].push(w);
                }
                if(alive) successCount++;
            }

            const getStats = (arr) => {
                arr.sort((a,b)=>a-b);
                return [arr[Math.floor(simulations*0.125)], arr[Math.floor(simulations*0.5)], arr[Math.floor(simulations*0.875)]];
            };

            const pL=[], pM=[], pH=[], wL=[], wM=[], wH=[];
            for(let y=0; y<=years; y++) {
                const sP = getStats(yearlyData[y]); pL.push(sP[0]); pM.push(sP[1]); pH.push(sP[2]);
                const sW = getStats(yearlyW[y]); wL.push(sW[0]); wM.push(sW[1]); wH.push(sW[2]);
            }
            cachedMcResults = { years, successRate: successCount/simulations, pL, pM, pH, wL, wM, wH };
            renderMCResults(cachedMcResults);
        }

        function renderMCResults(d) {
            document.getElementById('success-rate').innerText = (d.successRate*100).toFixed(1);
            document.getElementById('res-low').innerText = fmtMoney(d.pL[d.years]);
            document.getElementById('res-p50').innerText = fmtMoney(d.pM[d.years]);
            document.getElementById('res-high').innerText = fmtMoney(d.pH[d.years]);
            document.getElementById('withdraw-amt').innerText = (d.wL[0]/10000).toFixed(0);
            
            const advice = document.getElementById('dynamic-advice');
            if(d.pL[d.years] <= 0 && d.successRate < 0.9) {
                advice.innerHTML = "<span class='text-red-500 font-bold'>âš ï¸ è­¦å ±ï¼šä¿å®ˆæƒ…å¢ƒæœ‰æ­¸é›¶é¢¨éšªï¼Œå»ºè­°é™ä½æé ˜æˆ–å¢åŠ ç¾é‡‘ã€‚</span>";
            } else {
                advice.innerHTML = QUOTES[Math.floor(Math.random()*QUOTES.length)];
            }
            updateMcChart(d.years, d.pL, d.pM, d.pH);
            updateMcTables(d);
        }

        function updateMcTables(d) {
            const head = document.getElementById('mc-detail-table-head');
            const body = document.getElementById('mc-detail-table-body');
            const wHead = document.getElementById('mc-withdraw-table-head');
            const wBody = document.getElementById('mc-withdraw-table-body');
            const points = [3,5,10,20,30,40];
            const now = new Date().getFullYear();

            let hStr = "<th>å¹´ä»½</th>"; 
            let rL = "<tr><td>ä¿å®ˆ</td>", rM = "<tr><td>ä¸­ä½</td>", rH = "<tr><td>æ¨‚è§€</td>";
            let wL = "<tr><td>ä¿å®ˆæé ˜</td>", wM = "<tr><td>ä¸­ä½æé ˜</td>", wH = "<tr><td>æ¨‚è§€æé ˜</td>";

            points.forEach(y => {
                if(y <= d.years) {
                    hStr += `<th>ç¬¬${y}å¹´(${now+y})</th>`;
                    rL += `<td>${fmtMoney(d.pL[y])}</td>`; rM += `<td>${fmtMoney(d.pM[y])}</td>`; rH += `<td>${fmtMoney(d.pH[y])}</td>`;
                    wL += `<td>${fmtMoney(d.wL[y])}</td>`; wM += `<td>${fmtMoney(d.wM[y])}</td>`; wH += `<td>${fmtMoney(d.wH[y])}</td>`;
                }
            });
            head.innerHTML = hStr; wHead.innerHTML = hStr;
            body.innerHTML = rL+"</tr>"+rM+"</tr>"+rH+"</tr>";
            wBody.innerHTML = wL+"</tr>"+wM+"</tr>"+wH+"</tr>";
        }

        function updateMcChart(y, L, M, H) {
            const labels = Array.from({length: y+1}, (_, i) => i);
            mcChart.data.labels = labels;
            mcChart.data.datasets = [
                { label: 'ä¿å®ˆæƒ…å¢ƒ (åº•ç·š)', data: L, borderColor: '#16a34a', borderWidth: 2, fill: false, pointRadius: 0 },
                { label: 'æ¨‚è§€æƒ…å¢ƒ (è¶…é¡)', data: H, borderColor: '#dc2626', backgroundColor: 'rgba(253, 224, 71, 0.3)', borderWidth: 2, fill: '-1', pointRadius: 0 },
                { label: 'ä¸­ä½è¶¨å‹¢ (é æœŸ)', data: M, borderColor: '#2563eb', borderWidth: 3, fill: false, pointRadius: 0 }
            ];
            mcChart.update();
        }

        function syncPledgeQty() {
            document.getElementById('qty-pledge').value = document.getElementById('qty-tw').value;
            calculateLoanStatus();
        }

        function getRiskComment(lev, cash) {
            if(lev > 1.8) return "<span class='text-red-600 font-bold'>æ¥µé«˜é¢¨éšª</span> - å‹™å¿…ä¿ç•™å……è¶³ç¾é‡‘ã€‚";
            if(cash < 5) return "<span class='text-orange-500 font-bold'>æµå‹•æ€§è­¦è¨Š</span> - ç¾é‡‘éƒ¨ä½éä½ã€‚";
            return "<span class='text-green-600'>é…ç½®å¥åº·</span> - ç¹¼çºŒä¿æŒã€‚";
        }

        function saveData() {
            const data = {
                qtyImid: document.getElementById('qty-imid').value,
                qtyTw: document.getElementById('qty-tw').value,
                qtyTsmc: document.getElementById('qty-tsmc').value,
                valCash: document.getElementById('val-cash').value,
                totalCost: document.getElementById('total-cost-input').value,
                investDate: document.getElementById('invest-start-date').value,
                fireGoal: document.getElementById('fire-goal').value,
                targetImid: document.getElementById('target-imid').value,
                targetTw: document.getElementById('target-tw').value,
                targetTsmc: document.getElementById('target-tsmc').value,
                qtyPledge: document.getElementById('qty-pledge').value,
                valLoan: document.getElementById('val-loan').value,
                loanRate: document.getElementById('loan-rate').value
            };
            localStorage.setItem('portfolio_v55', JSON.stringify(data));
            const x = document.getElementById("toast"); x.className = "show"; setTimeout(()=>x.className="", 3000);
        }

        function loadData() {
            const s = localStorage.getItem('portfolio_v55');
            if(s) {
                const d = JSON.parse(s);
                Object.keys(d).forEach(k => {
                    const el = document.getElementById(k.replace(/[A-Z]/g, m => "-" + m.toLowerCase()));
                    if(el) el.value = d[k];
                });
            }
        }

        function togglePrivacy() {
            isPrivacyMode = !isPrivacyMode;
            document.querySelectorAll('.privacy-target').forEach(el => isPrivacyMode ? el.classList.add('privacy-blur') : el.classList.remove('privacy-blur'));
            calculateAll(false);
        }

        window.onload = () => { loadData(); initCharts(); fetchAllData(); };
    </script>
</body>
</html>
