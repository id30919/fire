<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹ä¿è€å¹´å¹´é‡‘ï¼šææ—©é ˜ vs å»¶å¾Œé ˜ æ±ºç­–æ¨¡æ“¬å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif; background: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        
        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; }
        }

        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1 { text-align: center; color: #2c3e50; grid-column: 1 / -1; margin-bottom: 20px; }
        h2 { font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; color: #34495e; }

        .input-group { margin-bottom: 18px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; }
        input[type="number"], input[type="range"] { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        input[type="range"] { padding: 0; }
        .hint { font-size: 0.8rem; color: #7f8c8d; margin-top: 4px; }
        .val-display { float: right; color: #2980b9; font-weight: bold; }

        .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-box { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-top: 4px solid #ccc; }
        .stat-box h3 { margin: 0 0 5px 0; font-size: 1rem; color: #555; }
        .stat-box .money { font-size: 1.3rem; font-weight: bold; color: #2c3e50; }
        .stat-box .desc { font-size: 0.8rem; color: #666; }
        
        .box-early { border-color: #27ae60; } /* ç¶ è‰² */
        .box-normal { border-color: #7f8c8d; } /* ç°è‰² */
        .box-late { border-color: #e67e22; }   /* æ©˜è‰² */

        .analysis-text { background: #e8f6f3; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #1abc9c; }
        
        #chartContainer { height: 400px; position: relative; }
    </style>
</head>
<body>

    <h1>ğŸ‡¹ğŸ‡¼ å‹ä¿è€å¹´å¹´é‡‘ï¼šææ—©é ˜ vs å»¶å¾Œé ˜ è©¦ç®—æ¨¡æ“¬</h1>

    <div class="container">
        <!-- å·¦å´åƒæ•¸è¨­å®š -->
        <div class="card">
            <h2>ğŸ“‹ å€‹äººåƒæ•¸è¨­å®š</h2>
            
            <div class="input-group">
                <label>ç›®å‰å¹´é½¡</label>
                <input type="number" id="age_current" value="50">
            </div>

            <div class="input-group">
                <label>ç›®å‰å·²ç´¯ç©å‹ä¿å¹´è³‡ (å¹´)</label>
                <input type="number" id="years_current" value="25">
            </div>

            <div class="input-group">
                <label>æœ€é«˜ 60 å€‹æœˆå¹³å‡æŠ•ä¿è–ªè³‡ (å…ƒ)</label>
                <input type="number" id="avg_salary" value="45800">
                <div class="hint">ç›®å‰æœ€é«˜ç´šè·ç‚º 45,800 å…ƒ</div>
            </div>

            <div class="input-group">
                <label>é ä¼°æ¯æœˆè‡ªä»˜å‹ä¿è²» (å…ƒ)</label>
                <input type="number" id="monthly_premium" value="1100">
                <div class="hint">ç”¨æ–¼è¨ˆç®—å»¶å¾Œé€€ä¼‘éœ€å¤šä»˜å‡ºçš„æˆæœ¬ (ç´„è–ªè³‡2.4%å·¦å³)</div>
            </div>
            
            <div class="input-group">
                <label>å°ç£å¹³å‡é¤˜å‘½åƒè€ƒç·š (æ­²)</label>
                <input type="range" id="life_expectancy" min="70" max="100" value="84">
                <div class="hint">ç›®å‰åœ‹äººå¹³å‡ç´„ 80~84 æ­² <span class="val-display" id="d_life">84æ­²</span></div>
            </div>

            <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
            
            <div style="font-size:0.9rem; color:#666;">
                <p><b>é è¨­æƒ…å¢ƒèªªæ˜ï¼š</b></p>
                <ul style="padding-left:20px; margin:5px 0;">
                    <li><b>ææ—©é ˜ (A)ï¼š</b>60æ­²é€€ä¼‘ï¼Œå¹´è³‡åœåœ¨60æ­²ï¼Œæœˆé ˜æ¸›é¡ 20%ã€‚</li>
                    <li><b>æ­£å¸¸é ˜ (B)ï¼š</b>65æ­²é€€ä¼‘ï¼Œå¹´è³‡ç®—åˆ°65æ­²ï¼Œæœˆé ˜æ¨™æº–é‡‘é¡ã€‚</li>
                    <li><b>å»¶å¾Œé ˜ (C)ï¼š</b>70æ­²é€€ä¼‘ï¼Œå¹´è³‡ç®—åˆ°70æ­²ï¼Œæœˆé ˜å¢é¡ 20%ã€‚</li>
                </ul>
            </div>
        </div>

        <!-- å³å´åˆ†æçµæœ -->
        <div class="card">
            <h2>ğŸ“Š æ•ˆç›Šåˆ†æèˆ‡äº¤å‰é»</h2>
            
            <div class="summary-grid">
                <div class="stat-box box-early">
                    <h3>ææ—©é ˜ (60æ­²)</h3>
                    <div class="money" id="pension_early">$0</div>
                    <div class="desc">æ¯æœˆé ˜å–é‡‘é¡<br>(-20% æ¸›çµ¦)</div>
                </div>
                <div class="stat-box box-normal">
                    <h3>æ­£å¸¸é ˜ (65æ­²)</h3>
                    <div class="money" id="pension_normal">$0</div>
                    <div class="desc">æ¯æœˆé ˜å–é‡‘é¡<br>(æ¨™æº–)</div>
                </div>
                <div class="stat-box box-late">
                    <h3>å»¶å¾Œé ˜ (70æ­²)</h3>
                    <div class="money" id="pension_late">$0</div>
                    <div class="desc">æ¯æœˆé ˜å–é‡‘é¡<br>(+20% å±•å»¶)</div>
                </div>
            </div>

            <div class="analysis-text" id="analysisResult">
                è¨ˆç®—ä¸­...
            </div>

            <div id="chartContainer">
                <canvas id="pensionChart"></canvas>
            </div>
            <div class="hint" style="text-align:center; margin-top:10px;">
                * ç¸±è»¸ç‚ºã€Œç´¯ç©æ·¨å€¼ã€ï¼šå·²é ˜å¹´é‡‘ç¸½é¡ æ‰£é™¤ 60æ­²å¾Œç¹³ç´ä¹‹ä¿è²»æˆæœ¬
            </div>
        </div>
    </div>

<script>
    const inputs = document.querySelectorAll('input');
    inputs.forEach(inp => inp.addEventListener('input', calculate));
    
    let myChart = null;

    function init() {
        calculate();
    }

    function formatMoney(n) {
        return parseInt(n).toLocaleString('zh-TW');
    }

    function calculate() {
        // 1. å–å¾—è¼¸å…¥
        const ageCurrent = Number(document.getElementById('age_current').value);
        const yearsCurrent = Number(document.getElementById('years_current').value);
        const salary = Number(document.getElementById('avg_salary').value);
        const premium = Number(document.getElementById('monthly_premium').value); // æœˆç¹³ä¿è²»
        const lifeExp = Number(document.getElementById('life_expectancy').value);

        document.getElementById('d_life').innerText = lifeExp + "æ­²";

        // 2. å®šç¾©ä¸‰å€‹æƒ…å¢ƒçš„åƒæ•¸
        // å‡è¨­ç›®å‰å¹´é½¡å°æ–¼ 60ï¼Œè‹¥å¤§æ–¼ 60 å‰‡é‚è¼¯éœ€å¾®èª¿ï¼Œé€™è£¡ä»¥è¦åŠƒè§’åº¦ç‚ºä¸»
        
        // å…±åŒè®Šæ•¸ï¼šæ³•å®šé€€ä¼‘å¹´é½¡ 65 (è¨ˆç®—åŸºæº–)
        // å¹´é‡‘å…¬å¼ï¼šå¹³å‡æœˆæŠ•ä¿è–ªè³‡ Ã— å¹´è³‡ Ã— 1.55%
        
        // --- æƒ…å¢ƒ A: ææ—©é ˜ (60æ­²) ---
        // å¹´è³‡ç´¯ç©åˆ° 60 æ­²åœæ­¢
        const ageA = 60;
        const yearsA = yearsCurrent + Math.max(0, ageA - ageCurrent); 
        const baseA = salary * yearsA * 0.0155; 
        const monthlyA = baseA * (1 - 0.20); // æå‰5å¹´ï¼Œæ¸›çµ¦ 20%
        const costA = 0; // 60æ­²å°±æ²’ç¹³è²»äº† (ç›¸å°æ–¼åŸºæº–é»)

        // --- æƒ…å¢ƒ B: æ­£å¸¸é ˜ (65æ­²) ---
        // å¹´è³‡ç´¯ç©åˆ° 65 æ­²
        const ageB = 65;
        const yearsB = yearsCurrent + Math.max(0, ageB - ageCurrent);
        const baseB = salary * yearsB * 0.0155;
        const monthlyB = baseB; // æ¨™æº–
        // æˆæœ¬ï¼šå¾ 60æ­²åˆ° 65æ­² å¤šç¹³äº† 5 å¹´ä¿è²»
        // ç‚ºäº†æ–¹ä¾¿æ¯”è¼ƒï¼Œæˆ‘å€‘è¨ˆç®—ã€Œæ·¨æ‰€å¾—ã€ã€‚
        
        // --- æƒ…å¢ƒ C: å»¶å¾Œé ˜ (70æ­²) ---
        // å¹´è³‡ç´¯ç©åˆ° 70 æ­²
        const ageC = 70;
        const yearsC = yearsCurrent + Math.max(0, ageC - ageCurrent);
        const baseC = salary * yearsC * 0.0155;
        const monthlyC = baseC * (1 + 0.20); // å»¶å¾Œ5å¹´ï¼Œå±•å»¶ 20%

        // æ›´æ–°ä¸Šæ–¹é¡¯ç¤º
        document.getElementById('pension_early').innerText = '$' + formatMoney(monthlyA);
        document.getElementById('pension_normal').innerText = '$' + formatMoney(monthlyB);
        document.getElementById('pension_late').innerText = '$' + formatMoney(monthlyC);

        // 3. ç”¢ç”Ÿåœ–è¡¨æ•¸æ“š (å¾ 60 æ­²è¨ˆç®—åˆ° 90 æ­²)
        let labels = [];
        let dataA = [];
        let dataB = [];
        let dataC = [];

        let accA = 0;
        let accB = 0; // 60æ­²é–‹å§‹ç®—ï¼ŒBé‚„æ²’é ˜ä¸”åœ¨ç¹³è²»
        let accC = 0; // 60æ­²é–‹å§‹ç®—ï¼ŒCé‚„æ²’é ˜ä¸”åœ¨ç¹³è²»

        // ç”¨æ–¼å°‹æ‰¾äº¤å‰é»
        let crossAB = null; // æ­£å¸¸ è¿½é ææ—©
        let crossCB = null; // å»¶å¾Œ è¿½é æ­£å¸¸
        
        const maxAge = 95;

        for (let age = 60; age <= maxAge; age++) {
            labels.push(age + "æ­²");

            // æƒ…å¢ƒ A: 60æ­²é–‹å§‹é ˜ï¼Œä¸éœ€ç¹³è²»
            if (age >= ageA) {
                accA += monthlyA * 12;
            }

            // æƒ…å¢ƒ B: 60-64æ­²ç¹³è²»ï¼Œ65æ­²é–‹å§‹é ˜
            if (age < ageB) {
                accB -= premium * 12; // è² ç¾é‡‘æµ (ç¹³ä¿è²»)
            } else {
                accB += monthlyB * 12;
            }

            // æƒ…å¢ƒ C: 60-69æ­²ç¹³è²»ï¼Œ70æ­²é–‹å§‹é ˜
            if (age < ageC) {
                accC -= premium * 12; // è² ç¾é‡‘æµ
            } else {
                accC += monthlyC * 12;
            }

            dataA.push(accA);
            dataB.push(accB);
            dataC.push(accC);

            // åµæ¸¬äº¤å‰é»
            if (crossAB === null && accB > accA) crossAB = age;
            if (crossCB === null && accC > accB) crossCB = age;
        }

        // 4. æ›´æ–°åˆ†ææ–‡å­—
        const diffBA = monthlyB - monthlyA;
        const diffCB = monthlyC - monthlyB;
        
        let msg = `<b>ğŸ’¡ åˆ†æå ±å‘Šï¼š</b><br>`;
        msg += `1. <b>ææ—©é ˜ vs æ­£å¸¸é ˜</b>ï¼šé›–ç„¶ææ—©é ˜æ¯å€‹æœˆå°‘é ˜ $${formatMoney(diffBA)}ï¼Œä½†æ‚¨å…ˆé ˜äº† 5 å¹´ã€‚`;
        if (crossAB) {
            msg += `å¦‚æœæ‚¨é æœŸæœƒæ´»è¶…é <b>${crossAB} æ­²</b>ï¼Œé¸æ“‡ã€Œæ­£å¸¸é ˜ã€ç´¯ç©ç¸½é‡‘é¡è¼ƒé«˜ã€‚ç›¸åçš„ï¼Œè‹¥å¥åº·ç‹€æ³ä¸ä½³ï¼Œææ—©é ˜è¼ƒæœ‰åˆ©ã€‚<br>`;
        } else {
            msg += `åœ¨é€™å€‹è¨­å®šä¸‹ï¼Œæ­£å¸¸é ˜ä¼¼ä¹æ°¸é è¿½ä¸ä¸Šææ—©é ˜ï¼ˆç½•è¦‹æƒ…æ³ï¼Œè«‹æª¢æŸ¥åƒæ•¸ï¼‰ã€‚<br>`;
        }
        
        msg += `<br>2. <b>æ­£å¸¸é ˜ vs å»¶å¾Œé ˜</b>ï¼šå»¶å¾Œé ˜æ¯å€‹æœˆå¤šé ˜ $${formatMoney(diffCB)}ï¼Œä½†é ˆå¤šç¹³ä¿è²»ä¸”æ™š5å¹´æ‹¿éŒ¢ã€‚`;
        if (crossCB) {
            msg += `æ‚¨éœ€è¦æ´»è¶…é <b>${crossCB} æ­²</b>ï¼Œå»¶å¾Œé ˜çš„ç¸½æ•ˆç›Šæ‰æœƒè¶…è¶Šæ­£å¸¸é ˜ã€‚`;
            if (crossCB > lifeExp) {
                msg += `<span style="color:#c0392b; font-weight:bold;">(æ³¨æ„ï¼šæ­¤æ­²æ•¸å·²è¶…éæ‚¨è¨­å®šçš„å¹³å‡é¤˜å‘½ ${lifeExp} æ­²ï¼Œå»¶å¾Œé ˜å¯èƒ½ä¸åˆ’ç®—ï¼)</span>`;
            } else {
                msg += `<span style="color:#27ae60; font-weight:bold;">(æ­¤æ­²æ•¸å°æ–¼å¹³å‡é¤˜å‘½ï¼Œè‹¥å®¶æ—é•·å£½å¯è€ƒæ…®å»¶å¾Œé ˜)</span>`;
            }
        }

        document.getElementById('analysisResult').innerHTML = msg;

        drawChart(labels, dataA, dataB, dataC, lifeExp);
    }

    function drawChart(labels, dA, dB, dC, lifeExp) {
        const ctx = document.getElementById('pensionChart').getContext('2d');
        
        if (myChart) myChart.destroy();

        // æ‰¾å‡ºå¹³å‡é¤˜å‘½åœ¨ label ä¸­çš„ index
        const lifeIndex = lifeExp - 60; 

        const annotation = {
            type: 'line',
            mode: 'vertical',
            scaleID: 'x',
            value: lifeIndex,
            borderColor: 'rgba(255, 99, 132, 0.8)',
            borderWidth: 2,
            borderDash: [5, 5],
            label: {
                content: 'å¹³å‡é¤˜å‘½',
                enabled: true,
                position: 'top'
            }
        };

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'ææ—©é ˜ (60æ­²)',
                        data: dA,
                        borderColor: '#27ae60', // Green
                        backgroundColor: 'rgba(39, 174, 96, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    },
                    {
                        label: 'æ­£å¸¸é ˜ (65æ­²)',
                        data: dB,
                        borderColor: '#7f8c8d', // Gray
                        backgroundColor: 'rgba(127, 140, 141, 0.1)',
                        borderWidth: 3, // Thicker
                        tension: 0.4
                    },
                    {
                        label: 'å»¶å¾Œé ˜ (70æ­²)',
                        data: dC,
                        borderColor: '#e67e22', // Orange
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatMoney(context.raw);
                            }
                        }
                    },
                    annotation: {
                        // Chart.js annotation plugin is external, simplified via basic drawing or ignored if not loaded
                        // We use manual checking logic in text instead to keep it single-file without external plugins dependency issues
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'ç´¯ç©æ·¨æ”¶ç›Š (å…ƒ)' },
                        ticks: {
                            callback: function(value) { return value/10000 + 'è¬'; }
                        }
                    }
                }
            },
            plugins: [{
                // è‡ªå®šç¾©æ’ä»¶ç•«ã€Œå¹³å‡é¤˜å‘½ã€é‚£æ¢è™›ç·š
                id: 'lifeLine',
                beforeDraw: (chart) => {
                    if (lifeIndex < 0 || lifeIndex >= labels.length) return;
                    const ctx = chart.ctx;
                    const xAxis = chart.scales.x;
                    const yAxis = chart.scales.y;
                    const x = xAxis.getPixelForTick(lifeIndex);
                    
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(x, yAxis.top);
                    ctx.lineTo(x, yAxis.bottom);
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#e74c3c';
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    
                    // æ–‡å­—æ¨™ç±¤
                    ctx.fillStyle = '#e74c3c';
                    ctx.font = 'bold 12px Arial';
                    ctx.fillText(`å¹³å‡é¤˜å‘½ (${lifeExp}æ­²)`, x + 5, yAxis.top + 20);
                    ctx.restore();
                }
            }]
        });
    }

    window.onload = function() {
        if (typeof Chart === 'undefined') {
            alert("è«‹é€£æ¥ç¶²è·¯ä»¥è¼‰å…¥åœ–è¡¨åº«");
        } else {
            init();
        }
    }
</script>

</body>
</html>
